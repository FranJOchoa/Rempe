sap.ui.define(["com/resulto/hcfi/controller/BaseController","sap/base/strings/formatMessage","sap/m/IconTabFilter","sap/m/MessageBox","sap/m/MessageToast","sap/m/PDFViewer","sap/ui/model/Filter","sap/ui/core/format/DateFormat","com/resulto/hcfi/model/formatter","com/resulto/hcfi/model/models","sap/ui/model/json/JSONModel","sap/m/Dialog","sap/m/Button"],function(e,t,s,i,r,a,o,n,l,d,c,g,h){"use strict";return e.extend("com.resulto.hcfi.controller.Main",{formatMessage:t,previousDateRange:"",vitalSignBatchID:"",noAllergy:false,oServiceResultsDialog:null,_itemsToUpload:[],onInit:function(){this.addIcons();this._pdfViewer=new a;this.getView().addDependent(this._pdfViewer);this.getInitialModels();this.getRouter().getRoute("Main").attachPatternMatched(this.onObjectMatched,this);this.byId("vitalSignsTable").onAfterRendering=this.onAfterTableRendering;jQuery.sap.addUrlWhitelist("blob")},onObjectMatched:function(e){this.headers={};try{this.headers=e.getParameter("arguments")["?query"]||JSON.parse('{"'+window.location.href.split("?")[1].replace(/"/g,'\\"').replace(/&/g,'","').replace(/=/g,'":"')+'"}')||{};if(this.headers.Institution&&this.headers.Case&&this.headers.Patient)this.getData();else this.goToErrorPage()}catch(e){try{this.headers=JSON.parse('{"'+window.location.href.split("#")[1].split("?")[1].replace(/"/g,'\\"').replace(/&/g,'","').replace(/=/g,'":"')+'"}')||{};if(this.headers.Institution&&this.headers.Case&&this.headers.Patient)this.getData();else this.goToErrorPage()}catch(e){this.goToErrorPage()}}},getData:function(){this.getMainData();this.getFieldKeyValues();this.getSummaryTypes();this.getRadUrl();this.getLabUrl();this.getMedicalDataOverview();this.getPatientAllergyData();this.getNotesCategories();this.getClinicalOrders();this.getServiceTree();this.getRiskFactors();this.getAllergies();this.getProfessionalData();this.getAntecedents();this.getPatientRiskFactor();this.getPatientSocialHabits();this.getPatientProcesses();this.getDiagnosticsSet();this.getOrganizationUnits()},getInitialModels:function(){this.setModel(d.createMainModel(),"MainData");this.setModel(d.createLinksModel(),"Links");this.setModel(d.createAllowedPMDModel(),"AllowedPMD");this.setModel(d.createOPDModel(),"CAD_OPD");this.setModel(d.createAEModel(),"CAD_AE");this.setModel(d.createGINEModel(),"CAD_GINE");this.setModel(d.createCADMAMModel(),"CAD_MAM");this.setModel(d.createCTREMBModel(),"CAD_CTREMB");this.setModel(d.createResultsModel(),"PatientAllergy");this.setModel(d.createResultsModel(),"PatientRiskFactor");this.setModel(d.createResultsModel(),"PatientMedicalHistory");this.setModel(d.createResultsModel(),"PatientSurgeryHistory");this.setModel(d.createResultsModel(),"PatientFamilyHistory");this.setModel(d.createResultsModel(),"PatientSocialHabitsHistory");this.setModel(d.createResultsModel(),"MedicalDataOverview");this.setModel(d.createResultsModel(),"Documents");this.setModel(d.createResultsModel(),"Services");this.setModel(d.createResultsModel(),"ServiceTree");this.setModel(d.createResultsModel(),"ProcessCases");this.setModel(d.createResultsModel(),"NotesCategories");this.setModel(d.createResultsModel(),"SummaryType");this.setModel(d.createResultsModel(),"Summary");this.setModel(d.createResultsModel(),"TypesReduced");this.setModel(d.createResultsModel(),"DocumentationUnitsReduced");this.setModel(d.createResultsModel(),"ResponsiblesReduced");this.setModel(d.createResultsModel(),"ResponsiblesGroupReduced");this.setModel(d.createResultsModel(),"Config");this.setModel(d.createResultsModel(),"TimeFilter");this.setModel(d.createResultsModel(),"RiskFactor");this.setModel(d.createResultsModel(),"Allergy");this.setModel(d.createResultsModel(),"DiagnosticsSet");this.setModel(d.createResultsModel(),"GetCaseDiagnostics");this.setModel(d.createResultsModel(),"GetOrganizationUnits");this.setModel(d.createAntecedentsModel(),"Antecedent");this.setModel(d.createEmptyModel(),"KeyValue");this.setModel(d.createEmptyModel(),"ProfessionalData");this.setModel(d.createNewAllergyModel(),"NewAllergy");this.setModel(d.createNewFamilyHistoryModel(),"NewFamilyHistory");this.setModel(d.createNewMedicalHistoryModel(),"NewMedicalHistory");this.setModel(d.createNewSurgeryHistoryModel(),"NewSurgeryHistory");this.setModel(d.createNewHabitModel(),"NewHabit");this.setModel(d.createVitalSignsModel(),"VitalSigns");this.setModel(d.createResultsModel(),"PatientProcess");this.setModel(d.createResultsModel(),"RiskFactorFiltered");this.setModel(new c({ov:true,al:true,rf:true,sh:true,mh:true,fh:true,oh:true}),"BusyModel");this.setModel(d.createResultsModel(),"ClinicalOrders")},onAfterRendering:function(){this.updateCss()},getMainData:function(){this.getModel("ZISH_HCFI_SRV").callFunction("/GetMainData",{urlParameters:{Institution:this.headers.Institution,Case:this.headers.Case,Movement:this.headers.Movement,Patient:this.headers.Patient},success:function(e){this.getModel("MainData").setProperty("/",e.GetMainData);document.title=this.getModel("MainData").getProperty("/PatientData/PatientNameAgeSex");this.getCatalog();this.getValues();this.getCasesInProcess(e.GetMainData.CaseData.Einri,e.GetMainData.CaseData.Falnr,this.headers.Movement);this.getDocuments();this.getServices();var t=e.GetMainData.DefaultData.Dtid;if(t){this.byId("IconTabBar").setSelectedKey(t)}this.byId("MainPage").setBusy(false)}.bind(this),error:function(e){this.byId("MainPage").setBusy(false);try{this.displayOdataError("GetMainData",JSON.parse(e.responseText).error.message.value)}catch{this.displayOdataError("GetMainData",e.message)}}.bind(this)})},getDescriptionOfDiagnostics:function(){var e=this.getModel("GetCaseDiagnostics").getProperty("/results");var t=this.getModel("DiagnosticsSet").getProperty("/results");e.forEach(e=>{e.Description=t.find(t=>t.Code==e.Dkey1).Description})},getDiagnosticsSet:function(){this.getModel("ZISH_HCFI_SRV").read("/DiagnosticsSet",{success:function(e){this.getModel("DiagnosticsSet").setProperty("/results",e.results);this.getCaseDiagnostics()}.bind(this),error:function(e){try{this.displayOdataError("DiagnosticsSet",JSON.parse(e.responseText).error.message.value)}catch{this.displayOdataError("DiagnosticsSet",e.message)}}.bind(this)})},getCaseDiagnostics:function(){this.getModel("ZISH_HCFI_SRV").callFunction("/GetCaseDiagnostics",{urlParameters:{Case:this.headers.Case,Institution:this.headers.Institution},success:function(e){this.getModel("GetCaseDiagnostics").setProperty("/results",e.results);this.getDescriptionOfDiagnostics()}.bind(this),error:function(e){try{this.displayOdataError("GetCaseDiagnostics",JSON.parse(e.responseText).error.message.value)}catch{this.displayOdataError("GetCaseDiagnostics",e.message)}}.bind(this)})},getOrganizationUnits:function(){this.getModel("ZISH_HCFI_SRV").callFunction("/GetOrganizationUnits",{urlParameters:{Institution:this.headers.Institution},success:function(e){this.getModel("GetOrganizationUnits").setProperty("/results",e.results)}.bind(this),error:function(e){try{this.displayOdataError("GetOrganizationUnits",JSON.parse(e.responseText).error.message.value)}catch{this.displayOdataError("GetOrganizationUnits",e.message)}}.bind(this)})},getREMPeUrl:function(){this.byId("MainPage").setBusy(true);this.byId("rempeBtn").setEnabled(false);this.getModel("ZISH_HCFI_SRV").callFunction("/GetREMPeUrl",{urlParameters:{Institution:this.headers.Institution,Case:this.headers.Case,Patient:this.headers.Patient},success:function(e){this.getModel("Links").setProperty("/REMPe",e.GetREMPeUrl.link);this.byId("MainPage").setBusy(false);this.byId("rempeBtn").setEnabled(true);this.onHeaderLinkPressed("REMPe")}.bind(this),error:function(e){try{this.displayOdataError("getREMPeUrl",JSON.parse(e.responseText).error.message.value)}catch{this.displayOdataError("getREMPeUrl",e.message)}this.byId("MainPage").setBusy(false);this.byId("rempeBtn").setEnabled(true)}.bind(this)})},getRadUrl:function(){this.getModel("ZISH_HCFI_SRV").callFunction("/GetRadUrl",{urlParameters:{Institution:this.headers.Institution,Case:this.headers.Case,Patient:this.headers.Patient},success:function(e){this.getModel("Links").setProperty("/Rad",e.GetRadUrl.link)}.bind(this)})},getLabUrl:function(){this.getModel("ZISH_HCFI_SRV").callFunction("/GetLabUrl",{urlParameters:{Institution:this.headers.Institution,Case:this.headers.Case,Patient:this.headers.Patient},success:function(e){this.getModel("Links").setProperty("/Lab",e.GetLabUrl.link)}.bind(this)})},getMedicalDataOverview:function(){this.getModel("BusyModel").setProperty("/ov",true);this.getModel("ZISH_HCFI_SRV").callFunction("/GetMedicalDataOverview",{urlParameters:{Institution:this.headers.Institution,Patient:this.headers.Patient},success:function(e){this.getModel("BusyModel").setProperty("/ov",false);this.getModel("MedicalDataOverview").setSizeLimit(e.results.length);this.getModel("MedicalDataOverview").setProperty("/results",this.filterAllegiesList(e.results))}.bind(this),error:function(e){try{this.displayOdataError("GetMedicalDataOverview",JSON.parse(e.responseText).error.message.value)}catch{this.displayOdataError("GetMedicalDataOverview",e.message)}this.getModel("BusyModel").setProperty("/ov",false)}.bind(this)});this.getAntecedents();this.getPatientRiskFactor();this.getPatientAllergy()},getPatientAllergyData:function(){this.getModel("ZISH_HCFI_SRV").callFunction("/GetPatientAllergyData",{urlParameters:{Patient:this.headers.Patient},success:function(e){this.noAllergy=e.GetPatientAllergyData.StateTotal==="1";this.getModel("Allergy").setProperty("/NoAllergy",e.GetPatientAllergyData.StateTotal==="1")}.bind(this),error:function(e){try{this.displayOdataError("GetPatientAllergyData",JSON.parse(e.responseText).error.message.value)}catch{this.displayOdataError("GetPatientAllergyData",e.message)}}.bind(this)})},setNoReferredAllergy:function(){this.getModel("ZISH_HCFI_SRV").callFunction("/SetNoReferredAllergy",{method:"POST",urlParameters:{Patient:this.headers.Patient,State:this.getModel("Allergy").getProperty("/NoAllergy")?"1":"3"},success:function(e){this.noAllergy=e.SetNoReferredAllergy.StateTotal==="1";this.getModel("Allergy").setProperty("/NoAllergy",e.SetNoReferredAllergy.StateTotal==="1");this.getMedicalDataOverview()}.bind(this),error:function(e){try{this.displayOdataError("SetNoReferredAllergy",JSON.parse(e.responseText).error.message.value)}catch{this.displayOdataError("SetNoReferredAllergy",e.message)}}.bind(this)})},getDocuments:function(e,t,s=false){let i=this.getModel("MainData").getProperty("/DefaultData/FilteredBySpeciality");this.getModel("ZISH_HCFI_SRV").callFunction("/GetDocuments",{urlParameters:{Institution:i?this.headers.Institution:"",Case:i?this.headers.Case:"",Movement:i?this.headers.Movement:"",Patient:this.headers.Patient,Process:i?this.getModel("MainData").getProperty("/ProcessData/ID"):""},success:function(i){this.getModel("Documents").setProperty("/results",i.results);this.byId("MedDocuments").setBusy(false);this.byId("OtherDocuments").setBusy(false);this.byId("ResultsDocuments").setBusy(false);if(!s){if(e&&t)this.getDocumentForFill(e,t);else this.getAllowedPMD()}}.bind(this),error:function(e){try{this.displayOdataError("GetDocuments",JSON.parse(e.responseText).error.message.value)}catch{this.displayOdataError("GetDocuments",e.message)}this.byId("MedDocuments").setBusy(false);this.byId("OtherDocuments").setBusy(false);this.byId("RadiologyDocuments").setBusy(false);this.byId("AnalysisDocuments").setBusy(false);this.byId("APADocuments").setBusy(false)}.bind(this)})},getServices:function(){this.getModel("ZISH_HCFI_SRV").callFunction("/GetServices",{urlParameters:{Institution:this.headers.Institution,Case:this.headers.Case,Movement:this.headers.Movement,Patient:this.headers.Patient,Process:this.getModel("MainData").getProperty("/ProcessData/ID")},success:function(e){this.getModel("Services").setProperty("/results",e.results);this.byId("Services").setBusy(false)}.bind(this),error:function(e){try{this.displayOdataError("GetServices",JSON.parse(e.responseText).error.message.value)}catch{this.displayOdataError("GetServices",e.message)}}.bind(this)})},getServiceTree:function(){this.getModel("ZISH_HCFI_SRV").callFunction("/GetServiceTree",{urlParameters:{Institution:this.headers.Institution,Case:this.headers.Case},success:function(e){var t=e.results.filter(e=>e.Tgrkz||!e.Tgrkz&&e.Parent=="").map(function(e){e.children=this.filter(t=>t.Parent===e.Talst);return e},e.results);this.getModel("ServiceTree").setProperty("/results",t)}.bind(this),error:function(e){try{this.displayOdataError("GetServiceTree",JSON.parse(e.responseText).error.message.value)}catch{this.displayOdataError("GetServiceTree",e.message)}}.bind(this)})},getCasesInProcess:function(e,t,s){this.getModel("ZISH_HCFI_SRV").callFunction("/GetRelatedCases",{urlParameters:{Institution:e,Case:t,Movement:s},success:function(e){this.getModel("ProcessCases").setProperty("/results",e.results)}.bind(this),error:function(e){try{this.displayOdataError("GetRelatedCases",JSON.parse(e.responseText).error.message.value)}catch{this.displayOdataError("GetRelatedCases",e.message)}}.bind(this)})},getNotesCategories:function(){this.getModel("ZISH_HCFI_SRV").callFunction("/GetNotesCategories",{urlParameters:{Institution:this.headers.Institution,Case:this.headers.Case},success:function(e){this.getModel("NotesCategories").setProperty("/results",e.results)}.bind(this),error:function(e){try{this.displayOdataError("NotesCategories",JSON.parse(e.responseText).error.message.value)}catch{this.displayOdataError("NotesCategories",e.message)}}.bind(this)})},getClinicalOrders:function(){this.getModel("ZISH_HCFI_SRV").callFunction("/GetClinicalOrders",{urlParameters:{Institution:this.headers.Institution,Patient:this.headers.Patient},success:function(e){var t=e.results;t.forEach(e=>{e.CreationDate=new Date(e.CreationDate);e.CreationDate=e.CreationDate.toLocaleDateString()});this.getModel("ClinicalOrders").setProperty("/results",t);this.getModel("ClinicalOrders").refresh();if(this.getView().byId("clinicalOrders").getBusy()){this.getView().byId("clinicalOrders").setBusy(false)}}.bind(this),error:function(e){try{this.displayOdataError("ClinicalOrders",JSON.parse(e.responseText).error.message.value)}catch{this.displayOdataError("NotesCategories",e.message)}}.bind(this)})},getRiskFactors:function(){this.getModel("ZISH_HCFI_SRV").read("/RiskFactorMasterDataSet",{success:function(e){this.getModel("RiskFactor").setProperty("/results",e.results)}.bind(this),error:function(e){try{this.displayOdataError("RiskFactorMasterDataSet",JSON.parse(e.responseText).error.message.value)}catch{this.displayOdataError("RiskFactorMasterDataSet",e.message)}}.bind(this)})},getAllergies:function(){this.getModel("ZISH_HCFI_SRV").read("/AllergyMasterDataSet",{filters:[new o("Einri","EQ",this.headers.Institution)],success:function(e){let t=e.results.filter(e=>e.IsGroup).map(function(e){e.children=this.filter(t=>t.ParentBchid===e.Bchid&&t.ParentBcpid===e.Bcpid);return e},e.results).map((e,t,s)=>{e.children=[...e.children,...s.filter(t=>t.ParentBchid===e.Bchid&&t.ParentBcpid===e.Bcpid)];return e}).filter(e=>!e.BchidAgr&&!e.BcpidAgr);t.unshift({Agr:"",AgrText:"",Bchextid:"",Bchid:"",BchidAgr:"",Bchname:"",Bcpdescription:"",Bcpid:"",BcpidAgr:"",Bcpname:this.getModel("i18n").getProperty("OtherAllergies"),BcpnameAgr:"",BcpnameN:"",Bctypename:"",Einri:"",Extid:"",ExtidN:"",IsGroup:false,ParentBchid:"",ParentBcpid:"",Spras:"ES"});this.getModel("Allergy").setProperty("/results",t);this.getModel("Allergy").setProperty("/loading",false);this.getPatientAllergy()}.bind(this),error:function(e){try{this.displayOdataError("AllergyMasterDataSet",JSON.parse(e.responseText).error.message.value)}catch{this.displayOdataError("AllergyMasterDataSet",e.message)}}.bind(this)})},getAntecedents:function(){this.getBCHierarchy("ZMFH");this.getBCHierarchy("ZPMH");this.getBCHierarchy("ZPSH");this.getBCHierarchy("ZSHA")},getBCHierarchy:function(e){this.getModel("ZISH_HCFI_SRV").read("/CustomBCHierarchySet",{filters:[new o("Institution","EQ",this.headers.Institution),new o("Bcareaid","EQ","ZP"),new o("Bctypeid","EQ",e)],success:function(t){if(t.results[0]){const e=t.results.filter(e=>!e.BchidParent&&!e.BcpidParent).map(function(e){e.children=this.filter(t=>t.BchidParent===e.BchidChild&&t.BcpidParent===e.BcpidChild);return e},t.results).map((e,t,s)=>{e.children=[...e.children,...s.filter(t=>t.BchidParent===e.BchidChild&&t.BcpidParent===e.BcpidChild)];return e});this.getModel("Antecedent").setSizeLimit(t.results.length);this.getModel("Antecedent").setProperty(`/${t.results[0].Bctypeid}`,e.length?e:t.results)}switch(e){case"ZMFH":this.getPatientFamilyHistory();break;case"ZPMH":this.getPatientMedicalHistory();break;case"ZPSH":this.getPatientSurgeryHistory();break;case"ZSHA":this.getPatientSocialHabits();break}}.bind(this),error:function(t){switch(e){case"ZMFH":this.getModel("BusyModel").setProperty("/fh",false);break;case"ZPMH":this.getModel("BusyModel").setProperty("/mh",false);break;case"ZPSH":this.getModel("BusyModel").setProperty("/sh",false);break;case"ZSHA":this.getModel("BusyModel").setProperty("/oh",false);break;default:break}try{this.displayOdataError("CustomBCHierarchySet",JSON.parse(t.responseText).error.message.value)}catch{this.displayOdataError("CustomBCHierarchySet",t.message)}}.bind(this)})},getFieldKeyValues:function(){this.getModel("ZISH_HCFI_SRV").read("/FieldKeyValueSet",{success:function(e){const t=this.groupBy(e.results,"Field");Object.values(t).map(e=>e.sort((e,t)=>{if(e.Field==="MOV_FDTYPE"||e.Field==="MOV_CSTRAS"||e.Field==="MOV_FSTYDA")return 1;if(e.KeyValue==="")return-1;return e.KeyValue>t.KeyValue?1:-1}));this.getModel("KeyValue").setProperty("/",t)}.bind(this),error:function(e){try{this.displayOdataError("FieldKeyValueSet",JSON.parse(e.responseText).error.message.value)}catch{this.displayOdataError("FieldKeyValueSet",e.message)}}.bind(this)})},getProfessionalData:function(){this.getModel("ZISH_HCFI_SRV").read("/GetProfessionalData",{success:function(e){this.getModel("ProfessionalData").setProperty("/",e.GetProfessionalData)}.bind(this),error:function(e){try{this.displayOdataError("GetProfessionalData",JSON.parse(e.responseText).error.message.value)}catch{this.displayOdataError("GetProfessionalData",e.message)}}.bind(this)})},getCatalog:function(){const e=this.getModel("MainData").getProperty("/MovementData");this.getModel("MVS_VITAL_SIGNS_SRV").read("/catalogSet",{urlParameters:{caseid:this.headers.Case,deptunit:e.Orgpf,institutionid:this.headers.Institution,movementid:e.Lfdnr,nursunit:e.Orgfa,patientid:this.headers.Patient},success:function(e){const t=e.results.filter(e=>e.dataType==="N"||e.dataType==="T");this.createCustomTableCss(t);this.getModel("VitalSigns").setSizeLimit(1e3);this.getModel("VitalSigns").setProperty("/catalogs/results",t);this.getConfig();this.getTimeFilter()}.bind(this),error:function(e){try{this.displayOdataError("catalogSet",JSON.parse(e.responseText).error.message.value)}catch{this.displayOdataError("catalogSet",e.message)}}.bind(this)})},getConfig:function(){const e=this.getModel("MainData").getProperty("/MovementData");this.getModel("MVS_VITAL_SIGNS_SRV").read("/configurationSet",{urlParameters:{caseid:this.headers.Case,deptunit:e.Orgpf,institutionid:this.headers.Institution,movementid:e.Lfdnr,nursunit:e.Orgfa,patientid:this.headers.Patient,$expand:"configurationToPositions"},success:function(e){this.getModel("Config").setProperty("/results",e.results);const t=e.results.find(e=>e.default)||e.results[0];if(t)this.byId("sConfigs").fireChange({selectedItem:this.byId("sConfigs").getItemByKey(t.id)})}.bind(this),error:function(e){try{this.displayOdataError("configurationSet",JSON.parse(e.responseText).error.message.value)}catch{this.displayOdataError("configurationSet",e.message)}}})},getTimeFilter:function(){const e=this.getModel("MainData").getProperty("/MovementData");this.getModel("MVS_VITAL_SIGNS_SRV").read("/timeFilterSet",{urlParameters:{caseid:this.headers.Case,deptunit:e.Orgpf,institutionid:this.headers.Institution,movementid:e.Lfdnr,nursunit:e.Orgfa,patientid:this.headers.Patient},success:function(e){const t=this.headers;const s=this.getModel("ProcessCases").getProperty("/results").map(e=>e.Falnr);const i=e.results.filter(e=>e.id.indexOf(t.Institution)===-1||s.find(t=>e.id.indexOf(t)>=0));i.forEach(e=>{if(e.description=="Hoy"){e.start=new Date((new Date).setHours(0,0,0,0));e.end=new Date((new Date).setHours(23,59,59,59))}});this.getModel("TimeFilter").setProperty("/results",i);const r=i.find(e=>e.default)||i.find(e=>e.id===t.Institution+t.Case)||i[0];this.byId("sTimeFilter").setSelectedKey(r.id);if(r)this.byId("sTimeFilter").fireChange({selectedItem:this.byId("sTimeFilter").getItemByKey(r.id)})}.bind(this),error:function(e){try{this.displayOdataError("timeFilterSet",JSON.parse(e.responseText).error.message.value)}catch{this.displayOdataError("timeFilterSet",e.message)}}})},getValues:function(e=false){const t=this.getModel("MainData").getProperty("/MovementData");this.getModel("MVS_VITAL_SIGNS_SRV").read("/measuredValueSet",{urlParameters:{caseid:this.headers.Case,deptunit:t.Orgpf,institutionid:this.headers.Institution,movementid:t.Lfdnr,nursunit:t.Orgfa,patientid:this.headers.Patient},success:function(t){this.getModel("VitalSigns").setProperty("/values/results",t.results);this.byId("vitalSignsTable").setBusy(false);this.getModel("VitalSigns").setProperty("/CAD_AETable/results",t.results.map(function(e){e.catalog=this.getModel("VitalSigns").getProperty("/catalogs/results").find(t=>t.catalogId===e.catalogId&&t.positionId===e.positionId);e.valueId=e.valueId.split("|")[0];return e},this).sort((e,t)=>e.dateTime.getTime()<t.dateTime.getTime()?1:-1));if(e){this.getTimeFilter();const e=this.byId("sTimeFilter").getSelectedItem().getBindingContext("TimeFilter").getObject();this.addTableColumns(this.byId("cbVitalSigns").getSelectedItems().map(e=>e.getAdditionalText()),[e.start,e.end])}}.bind(this),error:function(e){try{this.displayOdataError("measuredValueSet",JSON.parse(e.responseText).error.message.value)}catch{this.displayOdataError("measuredValueSet",e.message)}}})},getSummary:function(){this.getModel("ISH_PAT_SUMM_SRV").read("/summarySet",{urlParameters:{institutionId:this.headers.Institution,patientId:this.headers.Patient,caseId:this.headers.Case},success:this.getSummarySuccess.bind(this),error:function(e){try{this.displayOdataError("summarySet",JSON.parse(e.responseText).error.message.value)}catch{this.displayOdataError("summarySet",e.message)}this.byId("Timeline").setBusy(false);this.byId("Summary").setBusy(false)}.bind(this)})},getSummarySuccess:function(e){const t=e.results.map(function(e){e.typeText=this.getModel("SummaryType").getProperty("/results").filter(t=>e.type===t.type)[0].description;return e}.bind(this));this.getModel("Summary").setProperty("/results",t);this.byId("Timeline").setBusy(false);this.byId("Summary").setBusy(false);const s=e.results.filter((e,t,s)=>s.map(e=>e.type).indexOf(e.type)===t).map(e=>({type:e.type}));this.getModel("TypesReduced").setProperty("/results",s);const i=e.results.filter((e,t,s)=>s.map(e=>e.documentationUnit).indexOf(e.documentationUnit)===t).map(e=>({unit:e.documentationUnit}));this.getModel("DocumentationUnitsReduced").setProperty("/results",i);const r=e.results.filter((e,t,s)=>s.map(e=>e.responsible).indexOf(e.responsible)===t).map(e=>({responsible:e.responsible}));this.getModel("ResponsiblesReduced").setProperty("/results",r);const a=e.results.filter((e,t,s)=>s.map(e=>e.responsibleGroup).indexOf(e.responsibleGroup)===t).map(e=>({responsibleGroup:e.responsibleGroup}));this.getModel("ResponsiblesGroupReduced").setProperty("/results",a)},getSummaryTypes:function(){this.getModel("ISH_PAT_SUMM_SRV").read("/summaryTypeSet",{success:function(e){this.getModel("SummaryType").setProperty("/results",e.results);this.getSummary()}.bind(this),error:function(e){try{this.displayOdataError("summaryTypeSet",JSON.parse(e.responseText).error.message.value)}catch{this.displayOdataError("summaryTypeSet",e.message)}}.bind(this)})},getAllowedPMD:function(){this.getModel("ZISH_HCFI_SRV").read("/AllowedPMDSet",{filters:[new o("Einri","EQ",this.headers.Institution),new o("Case","EQ",this.headers.Case)],success:function(e){this.getModel("AllowedPMD").setProperty("/results",e.results.sort(function(e,t){if(e.Dtid<t.Dtid){return-1}if(e.Dtid>t.Dtid){return 1}return 0}));e.results.forEach(e=>{this.byId("IconTabBar").setBusy(false);this.byId(e.Dtid).setText(e.Dkbez);try{this.byId(e.Dtid).getContent()[0].getHeaderTitle().getExpandedHeading().setText(e.Dkbez)}catch{}this.getDocumentForFill(e.Dtid,e.Dtvers)},this)}.bind(this),error:function(e){try{this.displayOdataError("AllowedPMDSet",JSON.parse(e.responseText).error.message.value)}catch{this.displayOdataError("AllowedPMDSet",e.message)}}.bind(this)})},getPatientAllergy:function(){this.getModel("BusyModel").setProperty("/al",true);this.getModel("ZISH_HCFI_SRV").read("/AllergySet",{urlParameters:{$expand:"reactions"},filters:[new o("Patnr","EQ",this.headers.Patient)],success:function(e){e.results.map(function(e){e.parent=this.getModel("Allergy").getProperty("/results").find(t=>t.Bchid===e.BchidAgr&&t.Bcpid===e.BcpidAgr);return e},this);this.getModel("PatientAllergy").setProperty("/results",e.results);this.getModel("BusyModel").setProperty("/al",false)}.bind(this),error:function(e){this.getModel("BusyModel").setProperty("/al",false);try{this.displayOdataError("AllergySet",JSON.parse(e.responseText).error.message.value)}catch{this.displayOdataError("AllergySet",e.message)}}.bind(this)})},getPatientRiskFactor:function(){this.getModel("BusyModel").setProperty("/rf",true);this.getModel("ZISH_HCFI_SRV").read("/RiskFactorSet",{filters:[new o("Patnr","EQ",this.headers.Patient)],success:function(e){this.getModel("BusyModel").setProperty("/rf",false);this.getModel("PatientRiskFactor").setProperty("/results",e.results)}.bind(this),error:function(e){this.getModel("BusyModel").setProperty("/rf",false);try{this.displayOdataError("RiskFactorSet",JSON.parse(e.responseText).error.message.value)}catch{this.displayOdataError("RiskFactorSet",e.message)}}.bind(this)})},getPatientMedicalHistory:function(){this.getModel("BusyModel").setProperty("/mh",true);this.getModel("ZISH_HCFI_SRV").read("/MedicalHistorySet",{filters:[new o("Patnr","EQ",this.headers.Patient)],success:function(e){this.getModel("BusyModel").setProperty("/mh",false);e.results.map(function(e){this.getModel("Antecedent").getProperty("/ZPMH").forEach(t=>{if(t.children.find(t=>t.BchidChild===e.Bchid&&t.BcpidChild===e.Bcpid)){var s=t.children.find(t=>t.BchidChild===e.Bchid&&t.BcpidChild===e.Bcpid);e.ZPMH=s?s:e.ZPMH}else if(t.BchidChild===e.Bchid&&t.BcpidChild===e.Bcpid){var s=t;e.ZPMH=s?s:e.ZPMH}});return e},this);this.getModel("PatientMedicalHistory").setProperty("/results",e.results.map(e=>{if(e.MedHistguid==undefined){e.MedHistguid=e.MedHistid.toString()}e.MedHistid=e.MedHistid.replaceAll("-","").toUpperCase();return e}))}.bind(this),error:function(e){this.getModel("BusyModel").setProperty("/mh",false);try{this.displayOdataError("MedicalHistorySet",JSON.parse(e.responseText).error.message.value)}catch{this.displayOdataError("MedicalHistorySet",e.message)}}.bind(this)})},getPatientSurgeryHistory:function(){this.getModel("BusyModel").setProperty("/sh",true);this.getModel("ZISH_HCFI_SRV").read("/SurgeryHistorySet",{filters:[new o("Patnr","EQ",this.headers.Patient)],success:function(e){this.getModel("BusyModel").setProperty("/sh",false);e.results.map(function(e){e.ZPSH=this.getModel("Antecedent").getProperty("/ZPSH").find(t=>t.BchidChild===e.Bchid&&t.BcpidChild===e.Bcpid);return e},this);this.getModel("PatientSurgeryHistory").setProperty("/results",e.results.map(e=>{if(e.SurgHistguid==undefined)e.SurgHistguid=e.SurgHistid;e.SurgHistid=e.SurgHistid.replaceAll("-","").toUpperCase();return e}))}.bind(this),error:function(e){this.getModel("BusyModel").setProperty("/sh",false);try{this.displayOdataError("SurgeryHistorySet",JSON.parse(e.responseText).error.message.value)}catch{this.displayOdataError("SurgeryHistorySet",e.message)}}.bind(this)})},getPatientFamilyHistory:function(){this.getModel("BusyModel").setProperty("/fh",true);this.getModel("ZISH_HCFI_SRV").read("/FamilyHistorySet",{filters:[new o("Patnr","EQ",this.headers.Patient)],success:function(e){this.getModel("BusyModel").setProperty("/fh",false);e.results.map(function(e){this.getModel("Antecedent").getProperty("/ZMFH").forEach(t=>{if(t.children.find(t=>t.BchidChild===e.Bchid&&t.BcpidChild===e.Bcpid)){var s=t.children.find(t=>t.BchidChild===e.Bchid&&t.BcpidChild===e.Bcpid);e.ZMFH=s?s:e.ZMFH}else if(t.BchidChild===e.Bchid&&t.BcpidChild===e.Bcpid){var s=t;e.ZMFH=s?s:e.ZMFH}});return e},this);this.getModel("PatientFamilyHistory").setProperty("/results",e.results.map(e=>{if(e.FamilyHistguid==undefined)e.FamilyHistguid=e.FamilyHistid;e.FamilyHistid=e.FamilyHistid.replaceAll("-","").toUpperCase();return e}))}.bind(this),error:function(e){this.getModel("BusyModel").setProperty("/fh",false);try{this.displayOdataError("FamilyHistorySet",JSON.parse(e.responseText).error.message.value)}catch{this.displayOdataError("FamilyHistorySet",e.message)}}.bind(this)})},getPatientSocialHabits:function(){this.getModel("BusyModel").setProperty("/oh",true);this.getModel("ZISH_HCFI_SRV").read("/HabitSet",{filters:[new o("Patient","EQ",this.headers.Patient)],success:function(e){this.getModel("BusyModel").setProperty("/oh",false);this.getModel("PatientSocialHabitsHistory").setProperty("/results",e.results)}.bind(this),error:function(e){this.getModel("BusyModel").setProperty("/oh",false);try{this.displayOdataError("SocialHabitSet",JSON.parse(e.responseText).error.message.value)}catch{this.displayOdataError("SocialHabitSet",e.message)}}.bind(this)})},getDocumentForFill:function(e,t){const s=this.byId(e).getContent()[0];const i=this.byId(e).getContent()[1]?this.byId(e).getContent()[1]:this.byId(e).getContent()[0];this.getModel("ZISH_HCFI_SRV").callFunction("/GetDocumentForFill",{urlParameters:{Institution:this.headers.Institution,Case:this.headers.Case,Patient:this.headers.Patient,Dtid:e,Dtvers:t},success:function(e){const t=this.getModel("Documents").getProperty("/results").find(t=>t.RN2DOCDATA.Dokar===e.Dokar&&parseInt(t.RN2DOCDATA.Doknr)===parseInt(e.Doknr)&&t.RN2DOCDATA.Dokvr===e.Dokvr&&t.RN2DOCDATA.Doktl===e.Doktl);if(e.Doknr!=="9999999999999999999999999"){try{s.getHeaderTitle().getExpandedContent()[0].setText(t&&t.StatusText?t.StatusText:this.getModel("i18n").getProperty("New"))}catch{}this.getDocument(e)}else{try{s.getHeaderTitle().getExpandedContent()[0].setText(this.getModel("i18n").getProperty("New"))}catch{}e.RiskFactors=[];e.Allergies=[];e.SurgicalAntecedents=[];e.MedicalAntecedents=[];e.FamilyAntecedents=[];e.Signs=[];e.VitalSignsExamTable=[];e.Services=[];e.Diagnoses=[];e.FirstTrimester=[];e.SexT2=[];e.SexT3=[];e.SecondTrimester=[];e.ThirdTrimester=[];e.Monitors=[];e.Births=[];e.AfterbirthReview=[];e.content=this.getModel(e.Dtid).getProperty("/content");if(e.content)Object.values(e.content).map(t=>{t.Dokar=e.Dokar;t.Doknr=e.Doknr;t.Doktl=e.Doktl;t.Dokvr=e.Dokvr;return t});this.getModel(e.Dtid).setProperty("/",e);this.createNewDocument(e.Dtid);this.prefillDefaultData(e);try{s.setBusy(false).getHeaderTitle().getActions().forEach(e=>{e.setEnabled(true)});i.setBusy(false)}catch{}}}.bind(this),error:function(){try{s.setBusy(false).getHeaderTitle().getExpandedContent()[0].setText(this.getModel("i18n").getProperty("New"));i.setBusy(false)}catch{}}.bind(this)})},getDocument:function(e){this.getModel("ZISH_HCFI_SRV").read(`/DocumentSet(Dokar='${e.Dokar}',Doknr='${e.Doknr}',Dokvr='${e.Dokvr}',Doktl='${e.Doktl}')`,{urlParameters:{$expand:"content"},success:function(e){this.getModel(e.Dtid).setProperty("/",e);if(e.Dtid==="CAD_AE"){let t=e.content.results.find(e=>e.Alias==="ORD_FASST");let s=e.content.results.find(e=>e.Alias==="ORD_OPC");if(t?.Value===""&&s?.Value!==undefined&&s?.Value!==""){t.Value=s.Value}}this.getModel(e.Dtid).setProperty("/content",this.groupBy(e.content.results,"Alias"));this.createAntecedentsTab(e.Dtid,e.content);this.createVitalSignsExamTab(e.Dtid,e.content);this.createServicesTab(e.Dtid,e.content);this.createDiagnosesProceduresTab(e.Dtid,e.content);this.createDischargeTab(e.Dtid,e.content);this.createCAD_GINEView(e.Dtid,e.content);this.createCAD_MAMView(e.Dtid,e.content);this.createCAD_CTREMBView(e.Dtid,e.content);this.setRadioButtomSelectedIndex();this.byId(e.Dtid).getContent()[0].setBusy(false).getHeaderTitle().getActions().forEach(e=>{e.setEnabled(true)});try{this.byId(e.Dtid).getContent()[1].setBusy(false)}catch{}}.bind(this),error:function(e){try{this.displayOdataError("DocumentSet",JSON.parse(e.responseText).error.message.value)}catch{this.displayOdataError("DocumentSet",e.message)}}.bind(this)})},getPatientProcesses:function(){this.getModel("ZISH_HCFI_SRV").callFunction("/GetPatientProcesses",{urlParameters:{Institution:this.headers.Institution,Patient:this.headers.Patient},success:function(e){this.getModel("PatientProcess").setProperty("/results",e.results);this.getModel("PatientProcess").setProperty("/loading",false)}.bind(this),error:function(e){try{this.displayOdataError("GetPatientProcesses",JSON.parse(e.responseText).error.message.value)}catch{this.displayOdataError("GetPatientProcesses",e.message)}}.bind(this)})},createAntecedentsTab:function(e,t){if(t.MOV_FFEING)t.MOV_FFEING.Value=`${t.MOV_FFEING.Value.substr(6,2)}.${t.MOV_FFEING.Value.substr(4,2)}.${t.MOV_FFEING.Value.substr(0,4)}`;if(t.MOV_FHRING)t.MOV_FHRING.Value=`${t.MOV_FHRING.Value.substr(0,2)}:${t.MOV_FHRING.Value.substr(2,2)}:${t.MOV_FHRING.Value.substr(4,2)}`;const s=[];if(t.PAT_FRFDSC)t.PAT_FRFDSC.forEach((e,t)=>{s[t]={};s[t][e.Alias]=e.Value});if(t.PAT_FRFCOD)t.PAT_FRFCOD.forEach((e,t)=>s[t][e.Alias]=e.Value);if(t.PAT_FRFCOM)t.PAT_FRFCOM.forEach((e,t)=>s[t][e.Alias]=e.Value);if(t.PAT_FRFID)t.PAT_FRFID.forEach((e,t)=>s[t][e.Alias]=e.Value);this.getModel(e).setProperty("/RiskFactors",s);const i=[];if(t.PAT_FALLGR)t.PAT_FALLGR.forEach((e,t)=>{i[t]={};i[t][e.Alias]=e.Value});if(t.PAT_FALLDS)t.PAT_FALLDS.forEach((e,t)=>i[t][e.Alias]=e.Value);if(t.PAT_FALLID)t.PAT_FALLID.forEach((e,t)=>i[t][e.Alias]=e.Value);if(t.PAT_FALLRA)t.PAT_FALLRA.forEach((e,t)=>i[t][e.Alias]=e.Value);if(t.PAT_FALLSE)t.PAT_FALLSE.forEach((e,t)=>i[t][e.Alias]=e.Value);if(t.PAT_FALLTY)t.PAT_FALLTY.forEach((e,t)=>i[t][e.Alias]=e.Value);if(t.PAT_FALLCE)t.PAT_FALLCE.forEach((e,t)=>i[t][e.Alias]=e.Value);if(t.PAT_FALLVA)t.PAT_FALLVA.forEach((e,t)=>i[t][e.Alias]=e.Value);if(t.PAT_FALLOB)t.PAT_FALLOB.forEach((e,t)=>i[t][e.Alias]=e.Value);this.getModel(e).setProperty("/Allergies",i);const r=[];if(t.PAT_FSURNA)t.PAT_FSURNA.forEach((e,t)=>{r[t]={};r[t][e.Alias]=e.Value});if(t.PAT_FSURDT)t.PAT_FSURDT.forEach((e,t)=>{if(e.Value!="00000000")r[t][e.Alias]=new Date(e.Value.substr(0,4),e.Value.substr(4,2)-1,e.Value.substr(6,2))});if(t.PAT_FSURRM)t.PAT_FSURRM.forEach((e,t)=>r[t][e.Alias]=e.Value);if(t.PAT_FSURAN)t.PAT_FSURAN.forEach((e,t)=>r[t][e.Alias]=e.Value);if(t.PAT_FSURID)t.PAT_FSURID.forEach((e,t)=>r[t][e.Alias]=e.Value);if(t.PAT_FSURCM)t.PAT_FSURCM.forEach((e,t)=>r[t][e.Alias]=e.Value);this.getModel(e).setProperty("/SurgicalAntecedents",r);const a=[];if(t.PAT_FDISNA)t.PAT_FDISNA.forEach((e,t)=>{a[t]={};a[t][e.Alias]=e.Value});if(t.PAT_FDISDA)t.PAT_FDISDA.forEach((e,t)=>{if(e.Value!="00000000")a[t][e.Alias]=new Date(e.Value.substr(0,4),e.Value.substr(4,2)-1,e.Value.substr(6,2))});if(t.PAT_FDISTR)t.PAT_FDISTR.forEach((e,t)=>a[t][e.Alias]=e.Value);if(t.PAT_FDISRM)t.PAT_FDISRM.forEach((e,t)=>a[t][e.Alias]=e.Value);if(t.PAT_FDISID)t.PAT_FDISID.forEach((e,t)=>a[t][e.Alias]=e.Value);if(t.PAT_FDISCM)t.PAT_FDISCM.forEach((e,t)=>a[t][e.Alias]=e.Value);this.getModel(e).setProperty("/MedicalAntecedents",a);const o=[];if(t.PAT_FFHNAM)t.PAT_FFHNAM.forEach((e,t)=>{o[t]={};o[t][e.Alias]=e.Value});if(t.PAT_FFHID)t.PAT_FFHID.forEach((e,t)=>o[t][e.Alias]=e.Value);if(t.PAT_FRFAT)t.PAT_FRFAT.forEach((e,t)=>o[t][e.Alias]=e.Value==="X");if(t.PAT_FRMOM)t.PAT_FRMOM.forEach((e,t)=>o[t][e.Alias]=e.Value==="X");if(t.PAT_FRBRO)t.PAT_FRBRO.forEach((e,t)=>o[t][e.Alias]=e.Value==="X");if(t.PAT_FRSIS)t.PAT_FRSIS.forEach((e,t)=>o[t][e.Alias]=e.Value==="X");if(t.PAT_FRGRA)t.PAT_FRGRA.forEach((e,t)=>o[t][e.Alias]=e.Value==="X");if(t.PAT_FRPAGP)t.PAT_FRPAGP.forEach((e,t)=>o[t][e.Alias]=e.Value==="X");if(t.PAT_FRMAGP)t.PAT_FRMAGP.forEach((e,t)=>o[t][e.Alias]=e.Value==="X");if(t.PAT_FRSON)t.PAT_FRSON.forEach((e,t)=>o[t][e.Alias]=e.Value==="X");if(t.PAT_FFHRMK)t.PAT_FFHRMK.forEach((e,t)=>o[t][e.Alias]=e.Value);if(t.PAT_FRSIB)t.PAT_FRSIB.forEach((e,t)=>o[t][e.Alias]=e.Value);if(t.PAT_FFHROB)t.PAT_FFHROB.forEach((e,t)=>o[t][e.Alias]=e.Value);this.getModel(e).setProperty("/FamilyAntecedents",o);const n=[];if(t.P_HABIT_ID)t.P_HABIT_ID.forEach((e,t)=>{n[t]={};n[t][e.Alias]=e.Value});if(t.P_HABIT_D)t.P_HABIT_D.forEach((e,t)=>n[t][e.Alias]=e.Value);this.getModel(e).setProperty("/SocialHabits",n);this.fillDocumentHistoryModel(e)},createVitalSignsExamTab:function(e,t){const s=[];if(t.CLI_FVSDSC)t.CLI_FVSDSC.forEach((e,t)=>{s[t]={};s[t][e.Alias]=e.Value});if(t.CLI_FVSID)t.CLI_FVSID.forEach((e,t)=>s[t][e.Alias]=e.Value);if(t.CLI_FVSVAL)t.CLI_FVSVAL.forEach((e,t)=>s[t][e.Alias]=e.Value);if(t.CLI_FVSNRA)t.CLI_FVSNRA.forEach((e,t)=>s[t][e.Alias]=e.Value);if(t.CLI_FVSUNI)t.CLI_FVSUNI.forEach((e,t)=>s[t][e.Alias]=e.Value);if(t.CLI_FVSTIM)t.CLI_FVSTIM.forEach((e,t)=>s[t][e.Alias]=e.Value);this.getModel(e).setProperty("/VitalSignsExamTable",s)},createServicesTab:function(e,t){const s=[];if(t.ORD_FASSCD)t.ORD_FASSCD.forEach((e,t)=>{s[t]={};s[t][e.Alias]=`${e.Value.substr(6,2)}.${e.Value.substr(4,2)}.${e.Value.substr(0,4)}`});if(t.SRV_FIDPSR)t.SRV_FIDPSR.forEach((e,t)=>s[t][e.Alias]=e.Value);if(t.ORD_FASSD)t.ORD_FASSD.forEach((e,t)=>s[t][e.Alias]=e.Value);if(t.PMD_FREST)t.PMD_FREST.forEach((e,t)=>s[t][e.Alias]=e.Value);if(t.ORD_FERNAM)t.ORD_FERNAM.forEach((e,t)=>s[t][e.Alias]=e.Value);this.getModel(e).setProperty("/Services",s)},createDiagnosesProceduresTab:function(e,t){const s=[];if(t.PAT_FDIAD)t.PAT_FDIAD.forEach((e,t)=>{s[t]={};s[t][e.Alias]=e.Value});if(t.PAT_FDIACO)t.PAT_FDIACO.forEach((e,t)=>s[t][e.Alias]=e.Value);if(t.PAT_FDIACT)t.PAT_FDIACT.forEach((e,t)=>s[t][e.Alias]=e.Value);if(t.PAT_FDIAFT)t.PAT_FDIAFT.forEach((e,t)=>s[t][e.Alias]=e.Value);if(t.PAT_FDIAID)t.PAT_FDIAID.forEach((e,t)=>s[t][e.Alias]=e.Value);if(t.PAT_FDIAO)t.PAT_FDIAO.forEach((e,t)=>s[t][e.Alias]=e.Value);this.getModel(e).setProperty("/Diagnoses",s)},createDischargeTab:function(e,t){const s=[];if(t.PMD_FERNUM)t.PMD_FERNUM.forEach((e,t)=>{s[t]={};s[t][e.Alias]=e.Value});if(t.PMD_FERNAM)t.PMD_FERNAM.forEach((e,t)=>s[t][e.Alias]=e.Value);if(t.PMD_FERMLN)t.PMD_FERMLN.forEach((e,t)=>s[t][e.Alias]=e.Value);this.getModel(e).setProperty("/Signs",s);const i=[];if(t.PMD_FDOCV)t.PMD_FDOCV.forEach((e,t)=>{i[t]={};i[t][e.Alias]=e.Value});if(t.PMD_FDCVRD)t.PMD_FDCVRD.forEach((e,t)=>i[t][e.Alias]=e.Value);if(t.PMD_FDCVRT)t.PMD_FDCVRT.forEach((e,t)=>i[t][e.Alias]=e.Value);if(t.PMD_FDOCER)t.PMD_FDOCER.forEach((e,t)=>i[t][e.Alias]=e.Value);this.getModel(e).setProperty("/Documents",i)},createCAD_GINEView:function(e,t){["FUR_GIN","ECO_DAT"].forEach(e=>{if(t[e])t[e].Value=t[e].Value!=="00000000"?`${t[e].Value.substr(6,2)}.${t[e].Value.substr(4,2)}.${t[e].Value.substr(0,4)}`:""});const s=[];if(t.GINE_INFOR)t.GINE_INFOR.forEach((e,t)=>{s[t]={};s[t][e.Alias]=e.Value});if(t.DIA_INFORM)t.DIA_INFORM.forEach((e,t)=>s[t][e.Alias]=e.Value!=="00000000"?`${e.Value.substr(6,2)}.${e.Value.substr(4,2)}.${e.Value.substr(0,4)}`:"");if(t.VIA_GINE)t.VIA_GINE.forEach((e,t)=>s[t][e.Alias]=e.Value);if(t.PROF_GINE)t.PROF_GINE.forEach((e,t)=>s[t][e.Alias]=e.Value);if(t.ENTR_INF)t.ENTR_INF.forEach((e,t)=>s[t][e.Alias]=e.Value);if(t.VIA_GINE2)t.VIA_GINE2.forEach((e,t)=>s[t][e.Alias]=e.Value);if(t.DIA_INFOR2)t.DIA_INFOR2.forEach((e,t)=>s[t][e.Alias]=e.Value!=="00000000"?`${e.Value.substr(6,2)}.${e.Value.substr(4,2)}.${e.Value.substr(0,4)}`:"");if(t.DIAG_GIN)this.byId("DIAG_GIN").setValue(t.DIAG_GIN.Value);if(t.DERIV_GIN)this.byId("DERIV_GIN").setValue(t.DERIV_GIN.Value);this.getModel(e).setProperty("/Reports",s)},createCAD_MAMView:function(e,t){["FUR_MAM"].forEach(e=>{if(t[e])t[e].Value=t[e].Value!=="00000000"?`${t[e].Value.substr(6,2)}.${t[e].Value.substr(4,2)}.${t[e].Value.substr(0,4)}`:""});const s=[];if(t.GINE_INFOR)t.GINE_INFOR.forEach((e,t)=>{s[t]={};s[t][e.Alias]=e.Value});if(t.DIA_INFORM)t.DIA_INFORM.forEach((e,t)=>s[t][e.Alias]=e.Value!=="00000000"?`${e.Value.substr(6,2)}.${e.Value.substr(4,2)}.${e.Value.substr(0,4)}`:"");if(t.VIA_GINE)t.VIA_GINE.forEach((e,t)=>s[t][e.Alias]=e.Value);if(t.PROF_GINE)t.PROF_GINE.forEach((e,t)=>s[t][e.Alias]=e.Value);if(t.ENTR_INF)t.ENTR_INF.forEach((e,t)=>s[t][e.Alias]=e.Value);if(t.VIA_GINE2)t.VIA_GINE2.forEach((e,t)=>s[t][e.Alias]=e.Value);if(t.DIA_INFOR2)t.DIA_INFOR2.forEach((e,t)=>s[t][e.Alias]=e.Value!=="00000000"?`${e.Value.substr(6,2)}.${e.Value.substr(4,2)}.${e.Value.substr(0,4)}`:"");this.getModel(e).setProperty("/Reports",s)},createCAD_CTREMBView:function(e,t){if(e!=="CAD_CTREMB")return;["EMB_CTRFPP","EMB_CTRFUR","EMB_FURCOR","PARTOFECHA","PAT_FADM","PAT_FDOB","MOV_FDATDI"].forEach(e=>{if(t[e])t[e].Value=t[e].Value!=="00000000"?`${t[e].Value.substr(6,2)}.${t[e].Value.substr(4,2)}.${t[e].Value.substr(0,4)}`:""});["MOV_FTIMDI"].forEach(e=>{if(t[e])t[e].Value=t[e].Value!=="000000"?`${t[e].Value.substr(0,5)}`:""});const s=[];if(t.CTRECOID)t.CTRECOID.forEach((e,t)=>{s[t]={};s[t][e.Alias]=e.Value});if(t.X02_EMBID)t.X02_EMBID.forEach((e,t)=>s[t][e.Alias]=e.Value);if(t.CTRECOFECH)t.CTRECOFECH.forEach((e,t)=>s[t][e.Alias]=e.Value!=="00000000"?`${e.Value.substr(6,2)}.${e.Value.substr(4,2)}.${e.Value.substr(0,4)}`:"");if(t.EGSEMANAS)t.EGSEMANAS.forEach((e,t)=>s[t][e.Alias]=e.Value);if(t.EGDIAS)t.EGDIAS.forEach((e,t)=>s[t][e.Alias]=e.Value);if(t.CTRECOTA)t.CTRECOTA.forEach((e,t)=>s[t][e.Alias]=e.Value);if(t.CTRECOKG)t.CTRECOKG.forEach((e,t)=>s[t][e.Alias]=e.Value);if(t.CTRECOCOM)t.CTRECOCOM.forEach((e,t)=>s[t][e.Alias]=e.Value);if(t.CTRECOTROB)t.CTRECOTROB.forEach((e,t)=>s[t][e.Alias]=e.Value);if(t.CREATED_BY)t.CREATED_BY.forEach((e,t)=>s[t][e.Alias]=e.Value);this.getModel(e).setProperty("/FirstTrimester",s);const i=[];if(t.X00ECOID)t.X00ECOID.forEach((e,t)=>{i[t]={};i[t][e.Alias]=e.Value});if(t.X03_EMBID)t.X03_EMBID.forEach((e,t)=>i[t][e.Alias]=e.Value);if(t.X00ECOFECH)t.X00ECOFECH.forEach((e,t)=>i[t][e.Alias]=e.Value!=="00000000"?`${e.Value.substr(6,2)}.${e.Value.substr(4,2)}.${e.Value.substr(0,4)}`:"");if(t.X00EMANAS)t.X00EMANAS.forEach((e,t)=>i[t][e.Alias]=e.Value);if(t.X00IAS)t.X00IAS.forEach((e,t)=>i[t][e.Alias]=e.Value);if(t.X00ECOTA)t.X00ECOTA.forEach((e,t)=>i[t][e.Alias]=e.Value);if(t.X00ECOKG)t.X00ECOKG.forEach((e,t)=>i[t][e.Alias]=e.Value);if(t.X00ECOTROB)t.X00ECOTROB.forEach((e,t)=>i[t][e.Alias]=e.Value);if(t.X00ATED_BY)t.X00ATED_BY.forEach((e,t)=>i[t][e.Alias]=e.Value);if(t.CTRECOPRES)t.CTRECOPRES.forEach((e,t)=>i[t][e.Alias]=e.Value);if(t.CTRECOFC)t.CTRECOFC.forEach((e,t)=>i[t][e.Alias]=e.Value);if(t.CTRECOPFE)t.CTRECOPFE.forEach((e,t)=>i[t][e.Alias]=e.Value);if(t.CTRECOACOR)t.CTRECOACOR.forEach((e,t)=>i[t][e.Alias]=e.Value);if(t.CTRECOLA)t.CTRECOLA.forEach((e,t)=>i[t][e.Alias]=e.Value);if(t.CTRECOPLAC)t.CTRECOPLAC.forEach((e,t)=>i[t][e.Alias]=e.Value);if(t.CTRECODOPP)t.CTRECODOPP.forEach((e,t)=>i[t][e.Alias]=e.Value);if(t.CTRECOMORF)t.CTRECOMORF.forEach((e,t)=>i[t][e.Alias]=e.Value);this.getModel(e).setProperty("/SecondTrimester",i);const r=[];if(t.X01ECOID)t.X01ECOID.forEach((e,t)=>{r[t]={};r[t][e.Alias]=e.Value});if(t.X04_EMBID)t.X04_EMBID.forEach((e,t)=>r[t][e.Alias]=e.Value);if(t.X01ECOFECH)t.X01ECOFECH.forEach((e,t)=>r[t][e.Alias]=e.Value!=="00000000"?`${e.Value.substr(6,2)}.${e.Value.substr(4,2)}.${e.Value.substr(0,4)}`:"");if(t.X01EMANAS)t.X01EMANAS.forEach((e,t)=>r[t][e.Alias]=e.Value);if(t.X01IAS)t.X01IAS.forEach((e,t)=>r[t][e.Alias]=e.Value);if(t.X01ECOTA)t.X01ECOTA.forEach((e,t)=>r[t][e.Alias]=e.Value);if(t.X01ECOKG)t.X01ECOKG.forEach((e,t)=>r[t][e.Alias]=e.Value);if(t.X01ECOTROB)t.X01ECOTROB.forEach((e,t)=>r[t][e.Alias]=e.Value);if(t.X01ATED_BY)t.X01ATED_BY.forEach((e,t)=>r[t][e.Alias]=e.Value);if(t.X00ECOPRES)t.X00ECOPRES.forEach((e,t)=>r[t][e.Alias]=e.Value);if(t.X00ECOFC)t.X00ECOFC.forEach((e,t)=>r[t][e.Alias]=e.Value);if(t.X00ECOPFE)t.X00ECOPFE.forEach((e,t)=>r[t][e.Alias]=e.Value);if(t.X00ECOACOR)t.X00ECOACOR.forEach((e,t)=>r[t][e.Alias]=e.Value);if(t.X00ECOLA)t.X00ECOLA.forEach((e,t)=>r[t][e.Alias]=e.Value);if(t.X00ECOPLAC)t.X00ECOPLAC.forEach((e,t)=>r[t][e.Alias]=e.Value);if(t.X00ECODOPP)t.X00ECODOPP.forEach((e,t)=>r[t][e.Alias]=e.Value);if(t.X00ECOMORF)t.X00ECOMORF.forEach((e,t)=>r[t][e.Alias]=e.Value);this.getModel(e).setProperty("/ThirdTrimester",r);const a=[];if(t.EMB_EMBID)t.EMB_EMBID.forEach((e,t)=>{a[t]={};a[t][e.Alias]=e.Value});if(t.EMB_SEXO)t.EMB_SEXO.forEach((e,t)=>a[t][e.Alias]=e.Value);this.getModel(e).setProperty("/SexT2",a);const o=[];if(t.X00_EMBID)t.X00_EMBID.forEach((e,t)=>{o[t]={};o[t][e.Alias]=e.Value});if(t.X00_SEXO)t.X00_SEXO.forEach((e,t)=>o[t][e.Alias]=e.Value);this.getModel(e).setProperty("/SexT3",o);const n=[];if(t.EMBMONFECH)t.EMBMONFECH.forEach((e,t)=>{n[t]={};n[t][e.Alias]=e.Value});if(t.X02EMANAS)t.X02EMANAS.forEach((e,t)=>n[t][e.Alias]=e.Value);if(t.X02IAS)t.X02IAS.forEach((e,t)=>n[t][e.Alias]=e.Value);if(t.EMBMONREG)t.EMBMONREG.forEach((e,t)=>n[t][e.Alias]=e.Value);if(t.EMBMONTACT)t.EMBMONTACT.forEach((e,t)=>n[t][e.Alias]=e.Value);this.getModel(e).setProperty("/Monitors",n);const l=[];if(t.X01_EMBID)t.X01_EMBID.forEach((e,t)=>{l[t]={X01_EMBID:"",X00TOFECHA:"",X00TOHORA:"",EGAMPLIADA:"",X00TOTIPO:"",X00TOCESAR:"",DECESO:"",NACPESO:"",NACSEXO:"",APGAR:"",ALUMBRA:"",CORDON:"",PH:"",X00TOFINTP:""};l[t][e.Alias]=e.Value});if(t.X00TOFECHA)t.X00TOFECHA.forEach((e,t)=>l[t][e.Alias]=e.Value);if(t.X00TOHORA)t.X00TOHORA.forEach((e,t)=>l[t][e.Alias]=`${e.Value.substr(0,2)}:${e.Value.substr(2,2)}`);if(t.EGAMPLIADA)t.EGAMPLIADA.forEach((e,t)=>l[t][e.Alias]=e.Value);if(t.X00TOTIPO)t.X00TOTIPO.forEach((e,t)=>l[t][e.Alias]=e.Value);if(t.X00TOCESAR)t.X00TOCESAR.forEach((e,t)=>l[t][e.Alias]=e.Value);if(t.DECESO)t.DECESO.forEach((e,t)=>l[t][e.Alias]=e.Value);if(t.NACPESO)t.NACPESO.forEach((e,t)=>l[t][e.Alias]=parseFloat(e.Value));if(t.NACSEXO)t.NACSEXO.forEach((e,t)=>l[t][e.Alias]=e.Value);if(t.APGAR)t.APGAR.forEach((e,t)=>l[t][e.Alias]=e.Value);if(t.ALUMBRA)t.ALUMBRA.forEach((e,t)=>l[t][e.Alias]=e.Value);if(t.CORDON)t.CORDON.forEach((e,t)=>l[t][e.Alias]=e.Value);if(t.PH)t.PH.forEach((e,t)=>l[t][e.Alias]=parseFloat(e.Value));if(t.X00TOFINTP)t.X00TOFINTP.forEach((e,t)=>l[t][e.Alias]=e.Value);this.getModel(e).setProperty("/Births",l);const d=[];if(t.REVPPFECHA)t.REVPPFECHA.forEach((e,t)=>{d[t]={};d[t][e.Alias]=e.Value});if(t.REVPPESTGN)t.REVPPESTGN.forEach((e,t)=>d[t][e.Alias]=e.Value);if(t.REVPPECO)t.REVPPECO.forEach((e,t)=>d[t][e.Alias]=e.Value);if(t.REVPPOBS)t.REVPPOBS.forEach((e,t)=>d[t][e.Alias]=e.Value);this.getModel(e).setProperty("/AfterbirthReview",d)},onImportDialogPressed:function(e){if(e=="CAD_AE.CreateDiag"||e=="CAD_OPD.CreateDiag"){this.setModel(d.createResultsModel(),"DiagnosticsSetFiltered");this.getModel("DiagnosticsSetFiltered").setProperty("/results",this.getModel("DiagnosticsSet").getProperty("/results"))}if(e=="CAD_AE.ImportDiag"||e=="CAD_OPD.ImportDiag"){this.setModel(d.createResultsModel(),"GetCaseDiagnosticsFiltered");this.getModel("GetCaseDiagnosticsFiltered").setProperty("/results",this.getModel("GetCaseDiagnostics").getProperty("/results"))}this.loadFragment({type:"XML",name:`com.resulto.hcfi.view.${e}`}).then(e=>e.open())},onCancelImportDialog:function(e){e.getSource().getParent().close();e.getSource().getParent().destroy()},onSaveImportRiskFactorDialog:function(e,t){const s=[];e.getSource().getParent().getContent()[0].getSelectedItems().forEach(e=>{const t=e.getBindingContext("PatientRiskFactor").getObject();s.push({PAT_FRFDSC:t.Rsfna,PAT_FRFCOD:t.Rsfnr,PAT_FRFCOM:"",PAT_FRFID:"000"})});this.getModel(t).setProperty("/RiskFactors",s);this.onCancelImportDialog(e)},onDeleteDroppedHistoryModelPressed:function(e,t){let s=this.getModel(t).getProperty("/RiskFactors");let i=this.getModel(t).getProperty("/Allergies");let r=this.getModel(t).getProperty("/MedicalAntecedents");let a=this.getModel(t).getProperty("/FamilyAntecedents");let o=this.getModel(t).getProperty("/SurgicalAntecedents");let n=this.getModel(t).getProperty("/SocialHabits");var l=this.getModel(t).getProperty(e.getParameter("listItem").getBindingContextPath()).ID;if(s.find(e=>e.PAT_FRFCOD==l)){this.getModel(t).setProperty("/RiskFactors",s.filter(e=>e.PAT_FRFCOD!=l))}if(i.find(e=>e.PAT_FALLID==l)){this.getModel(t).setProperty("/Allergies",i.filter(e=>e.PAT_FALLID!=l));if(i.find(e=>e.PAT_FALLDS=="No refiere"&&e.PAT_FALLID==l)){this.getView().getModel("CAD_OPD").getData().content.PAT_FALLST.Value=""}}if(r.find(e=>e.PAT_FDISID==l)){this.getModel(t).setProperty("/MedicalAntecedents",r.filter(e=>e.PAT_FDISID!=l))}if(a.find(e=>e.PAT_FFHID==l)){this.getModel(t).setProperty("/FamilyAntecedents",a.filter(e=>e.PAT_FFHID!=l))}if(o.find(e=>e.PAT_FSURID==l)){this.getModel(t).setProperty("/SurgicalAntecedents",o.filter(e=>e.PAT_FSURID!=l))}if(n.find(e=>e.P_HABIT_ID==l)){this.getModel(t).setProperty("/SocialHabits",n.filter(e=>e.P_HABIT_ID!=l))}this.getModel(t).setProperty(e.getParameter("listItem").getBindingContextPath(),null);this.getModel(t).setProperty("/DroppedHistoryModel",this.getModel(t).getProperty("/DroppedHistoryModel").filter(Boolean));this.getModel(t).setSizeLimit(1e3);this.getModel(t).refresh()},onDeleteRiskFactorPressed:function(e,t){this.getModel(t).setProperty(e.getParameter("listItem").getBindingContextPath(),null);this.getModel(t).setProperty("/RiskFactors",this.getModel(t).getProperty("/RiskFactors").filter(Boolean))},onSaveImportAllergyDialog:function(e,t){const s=[];e.getSource().getParent().getContent()[0].getSelectedItems().forEach(e=>{const t=e.getBindingContext("PatientAllergy").getObject();var i="";if(t.parent!=undefined){i=t.parent.Bcpname}s.push({PAT_FALLDS:t.Descr,PAT_FALLGR:i,PAT_FALLID:t.AllergySeqno,PAT_FALLRA:"",PAT_FALLSE:"",PAT_FALLTY:""})});this.getModel(t).setProperty("/Allergies",s);this.onCancelImportDialog(e)},onDeleteAllergyPressed:function(e,t){this.getModel(t).setProperty(e.getParameter("listItem").getBindingContextPath(),null);this.getModel(t).setProperty("/Allergies",this.getModel(t).getProperty("/Allergies").filter(Boolean))},onSaveImportSurgicalAntecedentDialog:function(e,t){const s=[];e.getSource().getParent().getContent()[0].getSelectedItems().forEach(e=>{const t=e.getBindingContext("PatientSurgeryHistory").getObject();s.push({PAT_FSURDT:t.DateSurg,PAT_FSURNA:t.ZPSH.NameChild,PAT_FSURRM:t.RemarksInt,PAT_FSURAN:"",PAT_FSURID:t.SurgHistid})});this.getModel(t).setProperty("/SurgicalAntecedents",s);this.onCancelImportDialog(e)},onDeleteSurgicalAntecedentPressed:function(e,t){this.getModel(t).setProperty(e.getParameter("listItem").getBindingContextPath(),null);this.getModel(t).setProperty("/SurgicalAntecedents",this.getModel(t).getProperty("/SurgicalAntecedents").filter(Boolean))},onSaveImportMedicalAntecedentDialog:function(e,t){const s=[];e.getSource().getParent().getContent()[0].getSelectedItems().forEach(e=>{const t=e.getBindingContext("PatientMedicalHistory").getObject();s.push({PAT_FDISNA:t.ZPMH.NameChild,PAT_FDISDA:t.DateMedHist,PAT_FDISTR:t.Treatment,PAT_FDISRM:t.RemarksInt,PAT_FDISID:t.MedHistid})});this.getModel(t).setProperty("/MedicalAntecedents",s);this.onCancelImportDialog(e)},onDeleteMedicalAntecedentPressed:function(e,t){this.getModel(t).setProperty(e.getParameter("listItem").getBindingContextPath(),null);this.getModel(t).setProperty("/MedicalAntecedents",this.getModel(t).getProperty("/MedicalAntecedents").filter(Boolean))},onSaveImportFamilyAntecedentDialog:function(e,t){const s=[];e.getSource().getParent().getContent()[0].getSelectedItems().forEach(e=>{const t=e.getBindingContext("PatientFamilyHistory").getObject();s.push({PAT_FFHNAM:t.ZMFH.NameChild,PAT_FFHRMK:t.FamComment,PAT_FRSIB:"",PAT_FFHID:t.FamilyHistid,PAT_FRBRO:t.Brother,PAT_FRFAT:t.Father,PAT_FRGRA:"",PAT_FRMAGP:t.MaternalGrandparents,PAT_FRMOM:t.Mother,PAT_FRPAGP:t.PaternalGrandparents,PAT_FRSIS:t.Sister,PAT_FRSON:t.Son})});this.getModel(t).setProperty("/FamilyAntecedents",s);this.onCancelImportDialog(e)},onDeleteFamilyAntecedentPressed:function(e,t){this.getModel(t).setProperty(e.getParameter("listItem").getBindingContextPath(),null);this.getModel(t).setProperty("/FamilyAntecedents",this.getModel(t).getProperty("/FamilyAntecedents").filter(Boolean))},onSaveImportVitalSignDialog:function(e,t){const s=[];e.getSource().getParent().getContent()[0].getSelectedItems().forEach(e=>{const t=e.getBindingContext("VitalSigns").getObject();s.push({CLI_FVSDSC:t.catalog.description,CLI_FVSVAL:`${t.valueNum} ${t.catalog.unit}`,CLI_FVSNRA:`${t.catalog.rangeNormalLow} ${t.catalog.unit} - ${t.catalog.rangeNormalHigh} ${t.catalog.unit}`,CLI_FVSTIM:n.getDateTimeInstance({pattern:"dd.MM.yyyy/HH:mm:ss"}).format(t.dateTime),CLI_FVSID:t.valueId,CLI_FVSUNI:t.catalog.unit})});this.getModel(t).setProperty("/VitalSignsExamTable",s);this.onCancelImportDialog(e)},onDeleteVitalSignsExamTablePressed:function(e,t){this.getModel(t).setProperty(e.getParameter("listItem").getBindingContextPath(),null);this.getModel(t).setProperty("/VitalSignsExamTable",this.getModel(t).getProperty("/VitalSignsExamTable").filter(Boolean))},onDeleteServicesTablePressed:function(e,t){this.getModel(t).setProperty(e.getParameter("listItem").getBindingContextPath(),null);this.getModel(t).setProperty("/Services",this.getModel(t).getProperty("/Services").filter(Boolean))},onDeleteDiag_JudmentTablePressed:function(e,t){this.getModel(t).setProperty(e.getParameter("listItem").getBindingContextPath(),null);this.getModel(t).setProperty("/Diagnoses",this.getModel(t).getProperty("/Diagnoses").filter(Boolean))},signDocument:function(e){if(!this.getModel(e).getProperty("/Signs").find(e=>e.PMD_FERNUM===this.getModel("ProfessionalData").getProperty("/Id"))){this.getModel(e).getProperty("/Signs").push({PMD_FERMLN:"",PMD_FERNAM:this.getModel("ProfessionalData").getProperty("/Name"),PMD_FERNUM:this.getModel("ProfessionalData").getProperty("/Id")});this.getModel(e).updateBindings(true)}},onAddReport:function(e,t){var s=this.getModel(t).getProperty("/Reports");if(s==undefined||s.length==0){s=[{DIA_INFOR2:"",DIA_INFORM:"",ENTR_INF:"",GINE_INFOR:"",PROF_GINE:this.getModel("ProfessionalData").getProperty("/Id"),VIA_GINE:"",VIA_GINE2:""}];this.getModel(t).setProperty("/Reports",s)}else if(s!=undefined&&s.length>0)s.push(Object.assign({},s[s.length-1]));else s=[{DIA_INFOR2:"",DIA_INFORM:"",ENTR_INF:"",GINE_INFOR:"",PROF_GINE:this.getModel("ProfessionalData").getProperty("/Id"),VIA_GINE:"",VIA_GINE2:""}];this.getModel(t).updateBindings(true)},onDeleteReport:function(e,t){this.getModel(t).setProperty(e.getParameter("listItem").getBindingContextPath(),null);this.getModel(t).setProperty("/Reports",this.getModel(t).getProperty("/Reports").filter(Boolean))},clearDocument:function(e,t){var s=$.extend({},this.getModel(e).getData());delete s.DroppedHistoryModel;if(t)this.signDocument(e);s.Mitarb=this.getModel("ProfessionalData").getProperty("/Id");s.Orgdo=this.getModel("MainData").getProperty("/MovementData/Orgpf");if(s.content.MOV_FFEING)s.content.MOV_FFEING.Value=s.content.MOV_FFEING.Value.split(".").reverse().join("");if(s.content.MOV_FHRING)s.content.MOV_FHRING.Value=s.content.MOV_FHRING.Value.replaceAll(":","");if(s.content.MOV_FTIMDI)s.content.MOV_FTIMDI.Value=s.content.MOV_FTIMDI.Value.replaceAll(":","");["FUR_GIN","ECO_DAT","FUR_MAM","EMB_CTRFPP","EMB_CTRFUR","EMB_FURCOR","PARTOFECHA","MOV_FDATDI"].forEach(e=>{if(s.content[e])s.content[e].Value=s.content[e].Value.split(".").reverse().join("")});s.content=Object.values(s.content).filter(e=>!Array.isArray(e));["RiskFactors","Allergies","SurgicalAntecedents","MedicalAntecedents","FamilyAntecedents","Signs","VitalSignsExamTable","Services","Diagnoses","Documents","Reports","FirstTrimester","SecondTrimester","ThirdTrimester","SexT2","SexT3","Monitors","Births","AfterbirthReview","SocialHabits"].forEach(e=>{if(s[e])s[e].forEach((e,t)=>{Object.entries(e).forEach(e=>{let i=e[1];if(["PAT_FDISDA","PAT_FSURDT"].includes(e[0])){if(i){i=n.getDateTimeInstance({pattern:"yyyyMMdd"}).format(i)}else{i=""}}if(["X00TOHORA"].includes(e[0]))i=i.replaceAll(":","");if(["DIA_INFORM","DIA_INFOR2","CTRECOFECH","X00ECOFECH","X01ECOFECH","EMBMONFECH","REVPPFECHA","ORD_FASSCD"].includes(e[0]))i=i.split(".").reverse().join("");s.content.push({Dokar:s.Dokar,Doknr:s.Doknr,Dokvr:s.Dokvr,Doktl:s.Doktl,Alias:e[0],Line:t+1,Value:i})})});delete s[e]});s.content.forEach(e=>{if(e.Alias=="PAT_FRBRO"){if(e.Value==true){e.Value="X"}else if(e.Value==false){e.Value=""}}else if(e.Alias=="PAT_FRFAT"){if(e.Value==true){e.Value="X"}else if(e.Value==false){e.Value=""}}else if(e.Alias=="PAT_FRMAGP"){if(e.Value==true){e.Value="X"}else if(e.Value==false){e.Value=""}}else if(e.Alias=="PAT_FRMOM"){if(e.Value==true){e.Value="X"}else if(e.Value==false){e.Value=""}}else if(e.Alias=="PAT_FRPAGP"){if(e.Value==true){e.Value="X"}else if(e.Value==false){e.Value=""}}else if(e.Alias=="PAT_FRSIS"){if(e.Value==true){e.Value="X"}else if(e.Value==false){e.Value=""}}else if(e.Alias=="PAT_FRSON"){if(e.Value==true){e.Value="X"}else if(e.Value==false){e.Value=""}}else{e.Value=e.Value.toString().trim()}});return s},save:function(e,t="false"){if(this.getModel(e).getProperty("/Dokst")=="FR"){this.print(e);return}var s="";if(t=="true"){s=e}this.byId("Splitter").setBusy(true);if(this.getModel("CAD_AE").getProperty("/content/MOV_FDTYPE/Value")=="99"){this.displayOdataError(this.getModel("i18n").getProperty("ErrorTitle"),this.getModel("i18n").getProperty("ErrorInSelectedHighClass"));this.byId("Splitter").setBusy(false);return}this.createDocument(this.clearDocument(e),false,s)},saveSend:function(e){this.byId("Splitter").setBusy(true);this.createDocument(this.clearDocument(e,true),true)},print:function(e){const t=$.extend({},this.getModel(e).getData());this._pdfViewer.setSource(`/sap/opu/odata/sap/ZISH_HCFI_SRV/PDFSet(Dokar='${t.Dokar}',Doknr='${t.Doknr}',Dokvr='${t.Dokvr}',Doktl='${t.Doktl}')/$value`);var s=null;this.getModel("AllowedPMD").getData().results.forEach(t=>{if(t.Dtid==e){s=t.Dkbez}});this._pdfViewer.setTitle(s);this._pdfViewer.open()},createDocument:function(e,t=false,s=""){this.getModel("ZISH_HCFI_SRV").create("/DocumentSet",e,{success:function(e){this.byId("Splitter").setBusy(false);this.byId(e.Dtid).getContent()[0].setBusy(true);try{this.byId(e.Dtid).getContent()[1].setBusy(true)}catch{}this.getDocuments(e.Dtid,e.Dtvers);r.show(this.getModel("i18n").getProperty("SaveSuccessful"));if(t)this.releaseDocument(e);else this.byId("Splitter").setBusy(false);if(s!="")this.print(s)}.bind(this),error:function(e){this.byId("Splitter").setBusy(false);try{this.displayOdataError("DocumentSet",JSON.parse(e.responseText).error.message.value)}catch{this.displayOdataError("DocumentSet",e.message)}}.bind(this)})},releaseDocument:function(e){this.getModel("ZISH_HCFI_SRV").callFunction("/ReleaseDocument",{urlParameters:{Doktl:e.Doktl,Dokvr:e.Dokvr,Doknr:e.Doknr,Dokar:e.Dokar},success:function(e){this.byId("Splitter").setBusy(false);this.byId(e.ReleaseDocument.Dtid).getContent()[0].setBusy(true);try{this.byId(e.ReleaseDocument.Dtid).getContent()[1].setBusy(true)}catch{}this.getDocuments(e.ReleaseDocument.Dtid,e.ReleaseDocument.Dtvers);r.show(this.getModel("i18n").getProperty("ReleaseSuccessful"))}.bind(this),error:function(e){this.byId("Splitter").setBusy(false);try{this.displayOdataError("ReleaseDocument",JSON.parse(e.responseText).error.message.value)}catch{this.displayOdataError("ReleaseDocument",e.message)}}.bind(this)})},createNewDocument:function(e){switch(e){case"CAD_OPD":this.setModel(d.createOPDModel(e,this.headers.Institution,this.headers.Case,this.headers.Patient),e);break;case"CAD_AE":this.setModel(d.createAEModel(e,this.headers.Institution,this.headers.Case,this.headers.Patient),e);break;case"CAD_GINE":this.setModel(d.createGINEModel(e,this.headers.Institution,this.headers.Case,this.headers.Patient),e);break;case"CAD_MAM":this.setModel(d.createCADMAMModel(e,this.headers.Institution,this.headers.Case,this.headers.Patient),e);break;case"CAD_CTREMB":this.setModel(d.createCTREMBModel(e,this.headers.Institution,this.headers.Case,this.headers.Patient),e);break}this.byId(e).getContent()[0].getHeaderTitle().getExpandedContent()[0].setText(this.getModel("i18n").getProperty("New"));const t=this.getModel(e).getData();t.RiskFactors=[];t.Allergies=[];t.SurgicalAntecedents=[];t.MedicalAntecedents=[];t.FamilyAntecedents=[];t.SocialHabits=[];t.Signs=[];t.VitalSignsExamTable=[];t.Services=[];t.Diagnoses=[];t.FirstTrimester=[];t.SexT2=[];t.SexT3=[];t.SecondTrimester=[];t.ThirdTrimester=[];t.Monitors=[];t.Births=[];t.AfterbirthReview=[];t.Reports=[];switch(e){case"CAD_OPD":break;case"CAD_AE":break;case"CAD_MAM":t.content.OBS_MAM.Value=this.getModel("KeyValue").getProperty("/OBS_MAM/0/KeyText");break;case"CAD_GINE":t.content.OBS_GIN.Value=this.getModel("KeyValue").getProperty("/OBS_GIN/0/KeyText");break;case"CAD_CTREMB":t.content.PARTOEVO.Value=this.getModel("KeyValue").getProperty("/PARTOEVO/0/KeyText");t.content.PARTOEVORN.Value=this.getModel("KeyValue").getProperty("/PARTOEVORN/0/KeyText");break}this.getModel(e).updateBindings(true)},createDocumentVersion:function(e){this.byId("Splitter").setBusy(true);const t=this.getModel(e).getData();this.getModel("ZISH_HCFI_SRV").callFunction("/CreateDocVersion",{urlParameters:{Doktl:t.Doktl,Dokvr:t.Dokvr,Doknr:t.Doknr,Dokar:t.Dokar},success:function(e){this.byId("Splitter").setBusy(false);this.byId(e.CreateDocVersion.Dtid).getContent()[0].setBusy(true);try{this.byId(e.ReleaseDocument.Dtid).getContent()[1].setBusy(true)}catch{}this.getDocuments(e.CreateDocVersion.Dtid,e.CreateDocVersion.Dtvers)}.bind(this),error:function(e){this.byId("Splitter").setBusy(false);try{this.displayOdataError("CreateDocVersion",JSON.parse(e.responseText).error.message.value)}catch{this.displayOdataError("CreateDocVersion",e.message)}}.bind(this)})},onTimelineSearch:function(e){const t=e.getParameter("newValue");const s=this.byId("Timeline").getBinding("content").aFilters.length?this.byId("Timeline").getBinding("content").aFilters[0].aFilters:[];if(t){if(s.length){const e=s.findIndex(e=>e.sVariable==="search");if(e>=0)s.splice(e,1);s.push(new o({variable:"search",filters:[new o("information","Contains",t),new o("documentationUnit","Contains",t),new o("responsible","Contains",t),new o("typeText","Contains",t),new o("text","Contains",t)]}))}else s.push(new o({variable:"search",filters:[new o("information","Contains",t),new o("documentationUnit","Contains",t),new o("responsible","Contains",t),new o("typeText","Contains",t),new o("text","Contains",t)]}))}else s.splice(s.findIndex(e=>e.sVariable==="search"),1);this.byId("Timeline").getBinding("content").filter(new o(s,true))},onFilterTimelinePressed:function(e){const t=e.getSource();this._oFilterTimelineDialog?this._oFilterTimelineDialog.open(t):this.loadFragment({type:"XML",name:"com.resulto.hcfi.view.FilterTimelineDialog"}).then(function(e){this._oFilterTimelineDialog=e;e.open(t)}.bind(this))},onFilterTimelineDialogConfirm:function(e){const t=this.byId("Timeline").getBinding("content").aFilters.length?this.byId("Timeline").getBinding("content").aFilters[0].aFilters:[];const s=Object.entries(e.getParameter("filterItems").reduce((e,t)=>{if(t.getKey()==="datetime"){const s=t.getCustomControl().getItems()[1].getItems()[0].getDateValue();const i=t.getCustomControl().getItems()[1].getItems()[0].getSecondDateValue();this.previousDateRange=t.getCustomControl().getItems()[1].getItems()[0].getValue();e[t.getKey()]=[...e[t.getKey()]||[],new o(t.getKey(),"BT",s,i)]}else e[t.getParent().getKey()]=[...e[t.getParent().getKey()]||[],new o(t.getParent().getKey(),"EQ",t.getKey())];return e},{})).map(e=>new o({variable:e[0],filters:e[1]}));const i=t.find(e=>e.sVariable==="search");if(i)s.push(i);this.byId("Timeline").getBinding("content").filter(s.length?new o(s,true):null)},onFilterTimelineDialogCancel:function(e){const t=e.getSource().getFilterItems()[3];t.getCustomControl().getItems()[1].getItems()[0].setValue(this.previousDateRange);if(this.previousDateRange){t.setFilterCount(1);t.setSelected(true)}else{t.setFilterCount(0);t.setSelected(false)}},onFilterTimelineDialogReset:function(e){const t=e.getSource().getFilterItems()[3];t.getCustomControl().getItems()[1].getItems()[0].setDateValue(null);t.getCustomControl().getItems()[1].getItems()[0].setSecondDateValue(null);t.setFilterCount(0);t.setSelected(false)},onDateFilterChange:function(e){const t=e.getSource().getParent().getParent().getParent().getParent().getParent().getParent().getFilterItems()[3];if(e.getParameter("value")!==this.previousDateRange){t.setFilterCount(t.getFilterCount()+1);t.setSelected(true)}else{t.setFilterCount(t.getFilterCount()-1);t.setSelected(false)}},onClearDateRange:function(e){const t=e.getSource().getParent().getParent().getParent().getParent().getParent().getParent().getFilterItems()[3];t.getCustomControl().getItems()[1].getItems()[0].setDateValue(null);t.getCustomControl().getItems()[1].getItems()[0].setSecondDateValue(null);t.setFilterCount(0);t.setSelected(false)},onProcessPressed:function(e){const t=e.getSource();this._oProcessPopover?this._oProcessPopover.openBy(t):this.loadFragment({type:"XML",name:"com.resulto.hcfi.view.ProcessPopover"}).then(function(e){this._oProcessPopover=e;e.openBy(t)}.bind(this))},onSearchSelectProcess:function(e){const t=e.getParameter("value");e.getParameter("itemsBinding").filter(new o([new o("Case","Contains",t),new o("Dkey1","Contains",t),new o("Ditxt","Contains",t)],false))},onConfirmSelectProcess:function(e){this.byId("MainPage").setBusy(true);const t=e.getParameter("selectedItem").getBindingContext("PatientProcess").getObject();this.getModel("ZISH_HCFI_SRV").callFunction("/SetProcess",{urlParameters:{Institution:this.headers.Institution,Case:this.headers.Case,Process:t.ID},success:function(e){this.getData()}.bind(this),error:function(e){this.byId("MainPage").setBusy(false);try{this.displayOdataError("GetPatientProcesses",JSON.parse(e.responseText).error.message.value)}catch{this.displayOdataError("GetPatientProcesses",e.message)}}.bind(this)})},onAddTimelinePressed:function(){this.setModel(new c({ReferenceKey:"",Institution:this.headers.Institution,Case:this.headers.Case,Patient:this.headers.Patient,Process:this.getModel("MainData").getProperty("/ProcessData/ID"),Category:"",Content:"",Creation:"true"}),"selectedNote");this.loadFragment({type:"XML",name:"com.resulto.hcfi.view.AddTimelineDialog"}).then(function(e){this._oAddTimelineDialog=e;e.open()}.bind(this))},onAntecedentPressed:function(e){const t=e.getSource();const s=t.getBindingContext("MedicalDataOverview").getObject();const i=JSON.parse(s.Object).key;var r;switch(s.MedType){case"Alergia":r=JSON.parse(JSON.stringify(this.getModel("PatientAllergy").getData().results.find(e=>e.AllergySeqno===i)));r.Reactions=[];r.Allergy=r.parent;if(r.reactions.results&&r.reactions.results.length>0){r.Reactions=r.reactions.results;r.Reactions.forEach(function(e){if(parseInt(e.Rea)<10)e.Rea="0"+e.Rea;if(parseInt(e.Soa)<10)e.Soa="0"+e.Soa})}this.getModel("NewAllergy").setData(r);if(!this._EditAllergies){this.loadFragment({type:"XML",name:"com.resulto.hcfi.view.EditAllergies"}).then(function(e){this._EditAllergies=e;this.getView().addDependent(this._EditAllergies);e.open(t)}.bind(this))}else{this._EditAllergies.open()}break;case"Antecedente mdico":r=this.getModel("PatientMedicalHistory").getData().results.find(e=>e.MedHistid===i);r.Antecedent=r.ZPMH;r.Medication=r.Treatment;r.Comments=r.Remarks;r.Observations=r.RemarksInt;this.getModel("NewMedicalHistory").setData(r);if(!this._EditMedicalAntecedents){this.loadFragment({type:"XML",name:"com.resulto.hcfi.view.EditMedicalAntecedents"}).then(function(e){this._EditMedicalAntecedents=e;this.getView().addDependent(this._EditMedicalAntecedents);e.open(t)}.bind(this))}else{this._EditMedicalAntecedents.open()}break;case"Antecedente quirrgico":r=this.getModel("PatientSurgeryHistory").getData().results.find(e=>e.SurgHistid===i);r.Antecedent=r.ZPSH;r.Comments=r.Remarks;r.Observations=r.RemarksInt;this.getModel("NewSurgeryHistory").setData(r);if(!this._EditSurgicalAntecedents){this.loadFragment({type:"XML",name:"com.resulto.hcfi.view.EditSurgicalAntecedents"}).then(function(e){this._EditSurgicalAntecedents=e;this.getView().addDependent(this._EditSurgicalAntecedents);e.open(t)}.bind(this))}else{this._EditSurgicalAntecedents.open()}break;case"Antecedente familiar":r=JSON.parse(JSON.stringify(this.getModel("PatientFamilyHistory").getData().results.find(e=>e.FamilyHistid===i)));r.Antecedent=r.ZMFH;r.Comments=r.FamComment;r.Observations=r.RemarksInt;this.getModel("NewFamilyHistory").setData(r);if(!this._EditFamilyAntecedents){this.loadFragment({type:"XML",name:"com.resulto.hcfi.view.EditFamilyAntecedents"}).then(function(e){this._EditFamilyAntecedents=e;this.getView().addDependent(this._EditFamilyAntecedents);e.open(t)}.bind(this))}else{this._EditFamilyAntecedents.open()}break;case"Factor de riesgo":r=JSON.parse(JSON.stringify(this.getModel("PatientRiskFactor").getData().results.find(e=>e.Rsfnr===i)));this.getModel("RiskFactorFiltered").setData(r);if(!this._EditRiskFactors){this.loadFragment({type:"XML",name:"com.resulto.hcfi.view.EditRiskFactors"}).then(function(e){this._EditRiskFactors=e;this.getView().addDependent(this._EditRiskFactors);e.open(t)}.bind(this))}else{this._EditRiskFactors.open()}break;case"Hbito":var a=[];a.push(i.slice(0,8));a.push(i.slice(8,12));a.push(i.slice(12,16));a.push(i.slice(16,20));a.push(i.slice(20,32));var o=a.join("-").toLowerCase();r=JSON.parse(JSON.stringify(this.getModel("PatientSocialHabitsHistory").getData().results.find(e=>e.Habitid===o)));r.Antecedent={NameChild:r.Type};r.Quantity=r.Quantity.trim();this.getModel("NewHabit").setData(r);if(!this._EditHabitsAntecedents){this.loadFragment({type:"XML",name:"com.resulto.hcfi.view.EditHabitsAntecedents"}).then(function(e){this._EditHabitsAntecedents=e;this.getView().addDependent(this._EditHabitsAntecedents);e.open(t)}.bind(this))}else{this._EditHabitsAntecedents.open()}this.getModel("NewHabit").refresh();break;default:break}},onNoteSelected:function(e){let t=e.getParameter("listItem")||e.getParameter("selectedItem");let s=t.getBindingContext("Summary").getObject();this.setModel(new c({ReferenceKey:s.key,Institution:s.institutionId,Case:s.caseId,Patient:this.headers.Patient,Process:this.getModel("MainData").getProperty("/ProcessData/ID"),Category:s.category,Content:s.text,Interlocutor:s.responsibleId==this.getModel("MainData").getProperty("/DefaultData/Professional")}),"selectedNote");if(e.getSource().removeSelections){e.getSource().removeSelections()}this.loadFragment({type:"XML",name:"com.resulto.hcfi.view.AddTimelineDialog"}).then(function(e){this._oAddTimelineDialog=e;e.open()}.bind(this))},onAddVitalSignsPressed:function(){this.loadFragment({type:"XML",name:"com.resulto.hcfi.view.AddVitalSignsDialog"}).then(function(e){this._oAddVitalSignsDialog=e;e.open()}.bind(this))},onAddServicePressed:function(){this.loadFragment({type:"XML",name:"com.resulto.hcfi.view.AddServiceDialog"}).then(function(e){this.setModel(d.createResultsModel(),"ServiceTreeFiltered");this.getModel("ServiceTreeFiltered").setProperty("/results",this.getModel("ServiceTree").getProperty("/results"));this._oAddServiceDialog=e;e.open()}.bind(this))},readMore:function(e){e.getSource().getParent().getItems()[1].setMaxLines(0);e.getSource().setVisible(false);e.getSource().getParent().getItems()[e.getSource().getParent().getItems().length-1].setVisible(true)},readLess:function(e){e.getSource().getParent().getItems()[1].setMaxLines(4);e.getSource().setVisible(false);e.getSource().getParent().getItems()[e.getSource().getParent().getItems().length-2].setVisible(true)},onCancelAddTimelineDialog:function(e){this.destroyDialog(e)},onAnulateAddTimeLineDialog:function(e){const t=e.getSource().getParent();let s=this.getModel("selectedNote").getData();this.getModel("ZISH_HCFI_SRV").callFunction("/DeleteNote",{method:"GET",urlParameters:{ReferenceKey:s.ReferenceKey},success:function(e,s){this.getSummary();t.close();t.destroy()}.bind(this),error:function(e){try{this.displayOdataError("CancelNote",JSON.parse(e.responseText).error.message.value)}catch{this.displayOdataError("CancelNote",e.message)}}.bind(this)})},onSaveAddTimelineDialog:function(e){const t=e.getSource().getParent();let s=this.getModel("selectedNote").getData();this.getModel("ZISH_HCFI_SRV").callFunction("/CreateNote",{urlParameters:{ReferenceKey:s.ReferenceKey,Institution:s.Institution,Case:s.Case,Patient:s.Patient,Process:s.Process||"",Category:s.Category,Content:s.Content},success:function(e){this.getSummarySuccess(e);t.close();t.destroy()}.bind(this),error:function(e){try{this.displayOdataError("CreateNote",JSON.parse(e.responseText).error.message.value)}catch{this.displayOdataError("CreateNote",e.message)}}.bind(this)})},onCancelAddServiceDialog:function(e){this.getModel("ServiceTree").setProperty("/results",this.getModel("ServiceTree").getProperty("/results").map(e=>{e.children.map(e=>{delete e.Selected;return e});e.Selected=false;return e}));this.destroyDialog(e)},onSaveAddServiceDialog:function(e){const t=e.getSource().getParent();var s=this.getModel("ServiceTree").getProperty("/results").map(e=>e.children.filter(e=>e.Selected)).flat().concat(this.getModel("ServiceTree").getProperty("/results").filter(e=>e.Selected).flat());if(s.length){i.confirm(s.map(e=>`${e.Talst}: ${e.Ktxt1}`).join("\n"),{title:this.getModel("i18n").getProperty("SendBenefitsConfirmation"),actions:[i.Action.NO,i.Action.YES],emphasizedAction:i.Action.YES,onClose:function(e){if(e===i.Action.YES){t.setBusy(true);this.getModel("ZISH_HCFI_SRV").callFunction("/PerformServices",{urlParameters:{Institution:this.headers.Institution,Case:this.headers.Case,Movement:this.headers.Movement,Patient:this.headers.Patient,Process:this.getModel("MainData").getProperty("/ProcessData/ID"),Services:s.map(e=>e.Talst).join(",")},success:function(e){t.setBusy(false);this.getModel("Services").setProperty("/results",e.results);this.getModel("ServiceTree").setProperty("/results",this.getModel("ServiceTree").getProperty("/results").map(e=>{e.children.map(e=>{e.Selected=false;return e});e.Selected=false;return e}));t.close();t.destroy()}.bind(this),error:function(e){try{this.displayOdataError("PerformServices",JSON.parse(e.responseText).error.message.value)}catch{this.displayOdataError("PerformServices",e.message)}t.setBusy(false)}.bind(this)})}}.bind(this)})}else i.error(this.getModel("i18n").getProperty("MinimumBenefitsSelected"))},onCancelAddVitalSignDialog:function(e){this.byId("measure").setSelectedKey();this.byId("value").setValue();this.byId("unit").setText();this.destroyDialog(e)},destroyDialog:function(e){if(e.sId=="afterClose"){e.getSource().destroy()}else{e.getSource().getParent().close();e.getSource().getParent().destroy()}},closeUpdateDialog:function(e){e.getSource().getParent().close()},closeAddAllergiesDialog:function(e){var t;if(e.getId()!="afterClose"){e.getSource().getParent().close();t=e.getSource().getParent().getContent()[0]}else{t=e.getSource().getContent()[0]}if(e.getSource().getId().includes("addAllergiesDialog")||e.getSource().getParent().getId().includes("addAllergiesDialog")){this.getModel("AllergyFiltered").setProperty("/results",this.getModel("Allergy").getProperty("/results"));this.getModel("AllergyFiltered").setProperty("/loading",this.getModel("Allergy").getProperty("/loading"));this.getModel("AllergyFiltered").setProperty("/NoAllergy",this.getModel("Allergy").getProperty("/NoAllergy"));this.byId("AllergiesSearchField").setValue("")}if(e.getSource().getId().includes("addFamilyAntDialog")||e.getSource().getParent().getId().includes("addFamilyAntDialog"))this.getModel("AntecedentFiltered").setProperty("/ZMFH",this.getModel("Antecedent").getProperty("/ZMFH"));if(e.getSource().getId().includes("addMedicalAntDialog")||e.getSource().getParent().getId().includes("addMedicalAntDialog"))this.getModel("AntecedentFiltered").setProperty("/ZPMH",this.getModel("Antecedent").getProperty("/ZPMH"));if(e.getSource().getId().includes("addSurgicalAntDialog")||e.getSource().getParent().getId().includes("addSurgicalAntDialog"))this.getModel("AntecedentFiltered").setProperty("/ZPSH",this.getModel("Antecedent").getProperty("/ZPSH"));if(e.getSource().getId().includes("addSocialHabitsAntDialog")||e.getSource().getParent().getId().includes("addSocialHabitsAntDialog"))this.getModel("AntecedentFiltered").setProperty("/ZSHA",this.getModel("Antecedent").getProperty("/ZSHA"));if(e.getSource().getId().includes("addRiskFactorsDialog")||e.getSource().getParent().getId().includes("addRiskFactorsDialog")){this.getModel("RiskFactorFiltered").setProperty("/results",this.getModel("RiskFactor").getProperty("/results"))}else{t.discardProgress(t.getSteps()[0]);t.getSteps()[0].getContent()[1].collapseAll()}},onCloseServiceResult:function(e){e.getSource().destroy();this.oServiceResultsDialog=null;this.byId("Services").setBusy(true);this.getServices()},onCancelServiceResult:function(e){e.getSource().getParent().close()},onBeforeImageAdded:function(e){return;if(e.getSource().getIncompleteItems().length>0){i.error(this.getView().getModel("i18n").getResourceBundle().getText("ImageAlreadyAdded"));e.preventDefault();return}},onAfterItemAdded:function(e){this._oItem=e.getParameter("item");this._oItem.setUploadState(sap.m.UploadState.Complete);var t=new FileReader;t.readAsDataURL(this._oItem.getFileObject());t.onloadend=function(){var e=t.result;var s=e.split(",")[1];this._itemsToUpload.push({item:this._oItem,imageString:s})}.bind(this)},onAfterItemRemoved:function(e){this._oItem=e.getParameter("item");this._itemsToUpload=this._itemsToUpload.filter(e=>e.item!==this._oItem)},onSaveServiceResult:function(e){let t=this.byId("_IDGenUploadSet1");this._oItem=t.getIncompleteItems()[0];this._oResultsDoc=null;let s=this.getModel("selectedService").getData();let i=this._fillFIN_GENObject(s);this.oServiceResultsDialog.setBusy(true);this.signDocument("CAD_GINE");this.getModel("ZISH_HCFI_SRV").create("/DocumentSet",i,{success:function(e){r.show(this.getModel("i18n").getProperty("SaveSuccessful"));this._oResultsDoc=e;if(this._itemsToUpload.length>0){this.getModel("ZMEDIMAGE_GW_SRV").update(`/imageSet(Refkey='',Dockey='${e.Dokar}${e.Doknr}${e.Dokvr}${e.Doktl}')`,{Refkey:"",Dockey:`${e.Dokar}${e.Doknr}${e.Dokvr}${e.Doktl}`,Notation:`[${this._itemsToUpload.map(e=>`'{'data':[{'t':'I','x':827,'y':77,'color':'#3784CC','fill':'rgba(186, 157, 204, 0)','size':8,'data':'${e.imageString}','w':506,'h':489,'r':321,'b':412}]}'`).join(",")}]`,Resimage:this._itemsToUpload.map(e=>e.imageString).join(":")},{success:function(e){this._itemsToUpload=[];this._oItem.setUploadState(sap.m.UploadState.Complete);this._oItem.setVisibleRemove(false);this._oItem.setVisibleEdit(false);this.getModel("ZISH_HCFI_SRV").callFunction("/ReleaseDocument",{urlParameters:{Doktl:this._oResultsDoc.Doktl,Dokvr:this._oResultsDoc.Dokvr,Doknr:this._oResultsDoc.Doknr,Dokar:this._oResultsDoc.Dokar},success:function(e){r.show(this.getModel("i18n").getProperty("ReleaseSuccessful"));this.oServiceResultsDialog.setBusy(false);this.oServiceResultsDialog.close()}.bind(this),error:function(e){this.oServiceResultsDialog.setBusy(false);try{this.displayOdataError("ReleaseDocument",JSON.parse(e.responseText).error.message.value)}catch{this.displayOdataError("ReleaseDocument",e.message)}}.bind(this)})}.bind(this),error:function(e){this.oServiceResultsDialog.setBusy(false);try{this.displayOdataError("DocumentSet",JSON.parse(e.responseText).error.message.value)}catch{this.displayOdataError("DocumentSet",e.message)}}.bind(this)})}else{this.getModel("ZISH_HCFI_SRV").callFunction("/ReleaseDocument",{urlParameters:{Doktl:this._oResultsDoc.Doktl,Dokvr:this._oResultsDoc.Dokvr,Doknr:this._oResultsDoc.Doknr,Dokar:this._oResultsDoc.Dokar},success:function(e){r.show(this.getModel("i18n").getProperty("ReleaseSuccessful"));this.oServiceResultsDialog.setBusy(false);this.oServiceResultsDialog.close()}.bind(this),error:function(e){this.oServiceResultsDialog.setBusy(false);try{this.displayOdataError("ReleaseDocument",JSON.parse(e.responseText).error.message.value)}catch{this.displayOdataError("ReleaseDocument",e.message)}}.bind(this)})}}.bind(this),error:function(e){this.oServiceResultsDialog.setBusy(false);try{this.displayOdataError("DocumentSet",JSON.parse(e.responseText).error.message.value)}catch{this.displayOdataError("DocumentSet",e.message)}}.bind(this)})},onSendAddVitalSignDialog:function(e){let t=false;const s=e.getSource().getParent();const i=this.byId("measure");const r=this.byId("value");if(i.getSelectedItem()&&r.getValue()){s.setBusy(true);this.vitalSignBatchID=(new Date).getTime();const e=this.getModel("MainData").getProperty("/MovementData");const a=i.getSelectedItem().getBindingContext("VitalSigns").getObject();const o=r.getValue();this.getModel("MVS_VITAL_SIGNS_SRV").setDeferredGroups([this.vitalSignBatchID]);if(a.dataType=="T"){this.getModel("MVS_VITAL_SIGNS_SRV").create("/measuredValueSet",{institutionId:this.headers.Institution,patientId:this.headers.Patient,caseId:this.headers.Case,catalogId:a.catalogId,positionId:a.positionId,valueText:o,dateTime:null},{groupId:this.vitalSignBatchID,success:function(e){this.getValues(true)}.bind(this),error:function(e){t=true;s.setBusy(false);try{this.displayOdataError("measuredValueSet",JSON.parse(e.responseText).error.message.value)}catch{this.displayOdataError("measuredValueSet",e.message)}}.bind(this)})}else{this.getModel("MVS_VITAL_SIGNS_SRV").create("/measuredValueSet",{institutionId:this.headers.Institution,patientId:this.headers.Patient,caseId:this.headers.Case,catalogId:a.catalogId,positionId:a.positionId,valueNum:o,dateTime:null},{groupId:this.vitalSignBatchID,error:function(e){t=true;s.setBusy(false);try{this.displayOdataError("measuredValueSet",JSON.parse(e.responseText).error.message.value)}catch{this.displayOdataError("measuredValueSet",e.message)}}.bind(this)})}this.getModel("MVS_VITAL_SIGNS_SRV").callFunction("/saveMeasuredValues",{urlParameters:{caseid:this.headers.Case,deptunit:e.Orgpf,institutionid:this.headers.Institution,movementid:e.Lfdnr,nursunit:e.Orgfa,patientid:this.headers.Patient},groupId:this.vitalSignBatchID,error:function(e){t=true;s.setBusy(false);this.displayOdataError("saveMeasuredValues",JSON.parse(e.responseText).error.message.value)}.bind(this)});this.getModel("MVS_VITAL_SIGNS_SRV").submitChanges({success:function(){if(!t){this.getValues(true);this.byId("measure").setSelectedKey();this.byId("value").setValue();this.byId("unit").setText();s.setBusy(false).close();s.setBusy(false).destroy()}s.setBusy(false)}.bind(this),error:function(e){try{this.displayOdataError("submitChanges",JSON.parse(e.responseText).error.message.value)}catch{this.displayOdataError("submitChanges",e.message)}}.bind(this)})}else sap.m.MessageToast.show(this.getModel("i18n").getProperty("NoSelectedVitalSigns"))},onHeaderLinkPressed:function(e){if(e=="Lab"){this.getLabUrl();window.open(this.getModel("Links").getProperty(`/${e}`),"_blank")}else{window.open(this.getModel("Links").getProperty(`/${e}`),"_blank")}},onLinkPressed:function(e){const t=e.getSource().getParent().getBindingContext("Documents").getObject();if(t.PDF){this._pdfViewer.setSource(`/sap/opu/odata/sap/ZISH_HCFI_SRV/PDFSet(Dokar='${t.RN2DOCDATA.Dokar}',Doknr='${t.RN2DOCDATA.Doknr}',Dokvr='${t.RN2DOCDATA.Dokvr}',Doktl='${t.RN2DOCDATA.Doktl}')/$value`);this._pdfViewer.setTitle(t.RN2DOCDATA.Dktxt);this._pdfViewer.open()}else if(t.URL)window.open(t.Link,"_blank")},goToErrorPage:function(){this.navTo("Error",{})},timeFilterChange:function(e){const t=e.getParameter("selectedItem").getBindingContext("TimeFilter").getObject();this.addTableColumns(this.byId("cbVitalSigns").getSelectedItems().map(e=>e.getAdditionalText()),[t.start,t.end])},filterAllegiesList:function(e){var t=e;for(var s=0;s<=e.length-1;s++){switch(e[s].MedType){case"Alergia":e[s].position=1;break;case"Antecedente mdico":e[s].position=2;break;case"Antecedente quirrgico":e[s].position=3;break;case"Antecedente familiar":e[s].position=4;break;case"Factor de riesgo":e[s].position=5;break;case"Hbito":e[s].position=6;break;default:e[s].position=7;break}}t=e.sort((e,t)=>e.position-t.position);t.forEach(e=>delete e.position);return t},createCustomTableCss:function(e){const t=Array.from(document.styleSheets).find(e=>e.href?.indexOf("style.css")>0);e.forEach(function(e){t.insertRule(".catalog_"+e.code+"_Alert {background-color: "+e.colorAlert+" !important}");t.insertRule(".catalog_"+e.code+"_Warning {background-color: "+e.colorWarning+" !important}")})},onAfterTableRendering:function(){sap.ui.table.Table.prototype.onAfterRendering.apply(this);const e=this.getRows();if(e.length){for(let t=0;t<e.length;t++){const s=e[t].getCells();for(let e=0;e<s.length;e++){if(s[e].getMetadata().getName()==="sap.m.Text"&&s[e].getCustomData()[0]&&s[e].getCustomData()[0].getValue()){$("#"+s[e].getId()).parent().parent().addClass(s[e].getCustomData()[0].getValue());if(this.getColumns()[e].getMultiLabels()[1].getText().split(" ").length<2&&s[e].getCustomData()[0].getValue().indexOf("Warning")>=0)this.getColumns()[e].getMultiLabels()[1].setText(this.getColumns()[e].getMultiLabels()[1].getText().split(" ")[0]+" !");if(s[e].getCustomData()[0].getValue().indexOf("Alert")>=0)this.getColumns()[e].getMultiLabels()[1].setText(this.getColumns()[e].getMultiLabels()[1].getText().split(" ")[0]+" !!")}}}}},addTableColumns:function(e,t){const s=this.byId("vitalSignsTable");const i=s.getColumns().slice(0,3);s.removeAllColumns();for(let e=0;e<i.length;e++){s.addColumn(i[e])}const r=this.getModel("VitalSigns").getProperty("/catalogs/results");const a=this.getModel("VitalSigns").getProperty("/catalogs/results").filter(t=>e.indexOf(t.code)>-1).map(e=>e.positionId);const o=this.groupBy(this.getModel("VitalSigns").getProperty("/values/results").filter(e=>a.indexOf(e.positionId)>-1),"dateTime");const n=Object.keys(o).sort(function(e,t){return new Date(e).getTime()<new Date(t).getTime()?1:-1}).filter(function(e){return new Date(e).getTime()>this[0]&&new Date(e).getTime()<this[1]}.bind(t));const d=this.getModel("VitalSigns").getProperty("/catalogs/results").map(function(e,t){this.getModel("VitalSigns").getProperty("/values/results").filter(function(e){return e.positionId===this.positionId}.bind(t)).filter(function(e){return e.dateTime>this[0]&&e.dateTime<this[1]}.bind(e)).forEach(function(e){if(r.find(t=>t.positionId==e.positionId).dataType=="T"){this[e.dateTime]={value:e.valueText,additionalInfo:e.additionalInformation}}else{this[e.dateTime]={value:parseFloat(e.valueNum),additionalInfo:e.additionalInformation}}}.bind(t));return t}.bind(this,t)).filter(function(e){return this.indexOf(e.code)>=0}.bind(e));n.forEach(function(e,t,i){const r=i.map(e=>new Date(e).toLocaleDateString()).filter(function(e){return e===this}.bind(new Date(e).toLocaleDateString())).length;s.addColumn(new sap.ui.table.Column({width:"90px",headerSpan:r,customData:[new sap.ui.core.CustomData({key:"date",value:e})],multiLabels:[new sap.m.Label({text:{value:new Date(e),type:"sap.ui.model.type.Date"}}),new sap.m.Label({text:{value:new Date(e),type:"sap.ui.model.type.Time"},textAlign:"Center",width:"100%"})],template:new sap.m.Button({text:"{VitalSigns>"+e+"/value}",type:sap.m.ButtonType.Transparent,enabled:"{= ${VitalSigns>"+e+"/value} !== undefined }",width:"100%",dragDropConfig:[new sap.ui.core.dnd.DragInfo],customData:[new sap.ui.core.CustomData({key:"rangeColor",value:{parts:[`VitalSigns>${e}`,"VitalSigns>code","VitalSigns>rangeAlarmHigh","VitalSigns>rangeAlarmLow","VitalSigns>rangeNormalHigh","VitalSigns>rangeNormalLow","VitalSigns>rangeWarningHigh","VitalSigns>rangeWarningLow"],formatter:l.getRangeColor}})]})}))},this);this.getModel("VitalSigns").setProperty("/table/results",d)},vitalSignChange:function(e){const t=e.getSource().getSelectedItem().getBindingContext("VitalSigns").getObject();this.byId("value").setValue();this.byId("unit").setText(t.unit)},onAddRiskFactors:function(){if(!this._oAddRiskFactorsDialog){this.loadFragment({type:"XML",name:"com.resulto.hcfi.view.AddRiskFactorsDialog"}).then(function(e){this.setModel(d.createResultsModel(),"RiskFactorFiltered");this.getModel("RiskFactorFiltered").setProperty("/results",this.getModel("RiskFactor").getProperty("/results"));this._oAddRiskFactorsDialog=e;this.getView().addDependent(this._oAddRiskFactorsDialog);e.open()}.bind(this))}else{this._oAddRiskFactorsDialog.open()}},onSuggestRiskFactor:function(e){var t=e.getParameter("suggestValue"),s=[];if(t){s=[new o("Rsfna",function(e){return(e||"").toUpperCase().indexOf(t.toUpperCase())>-1})]}},onTypeRiskFactor:function(e){this.onSearchRiskFactor(e.getParameter("newValue"))},onSearchRiskFactor:function(e){var t="";var s=[];if(e.length==undefined){t=e.getParameter("query")}else{t=e}if(t!=""){if(this.getModel("RiskFactor").getProperty("/results").find(e=>e.Rsfna.toUpperCase().includes(t.toUpperCase()))){s=this.getModel("RiskFactor").getProperty("/results").filter(e=>e.Rsfna.toUpperCase().includes(t.toUpperCase()))}this.getModel("RiskFactorFiltered").setProperty("/results",s);return}this.getModel("RiskFactorFiltered").setProperty("/results",this.getModel("RiskFactor").getProperty("/results"));this.getModel("RiskFactorFiltered").refresh()},onTypeFamilyAntecedents:function(e){this.onSearchFamilyAntecedents(e.getParameter("newValue"))},onSearchFamilyAntecedents:function(e){var t="";var s=[];var i=this.getModel("Antecedent").getProperty("/ZMFH");if(e.length==undefined){t=e.getParameter("query")}else{t=e}if(t!=""){for(var r=0;r<=i.length-1;r++){if(i[r].children.find(e=>e.NameChild.toUpperCase().includes(t.toUpperCase())&&e.IsSelectable)){i[r].children.forEach(e=>{if(e.NameChild.toUpperCase().includes(t.toUpperCase())&&e.IsSelectable&&e.NameChild.toUpperCase()!="OTROS"){s.push(e)}})}}if(!s.find(e=>e.ExtidChild.toUpperCase()=="OTROS"))s.push(i.find(e=>e.ExtidChild.toUpperCase().includes("OTROS")&&e.IsSelectable==true));this.getModel("AntecedentFiltered").setProperty("/ZMFH",s);return}this.getModel("AntecedentFiltered").setProperty("/ZMFH",this.getModel("Antecedent").getProperty("/ZMFH"));this.getModel("AntecedentFiltered").refresh()},onTypeMedicalAntecedents:function(e){this.onSearchMedicalAntecedents(e.getParameter("newValue"))},onSearchMedicalAntecedents:function(e){var t="";var s=[];var i=this.getModel("Antecedent").getProperty("/ZPMH");if(e.length==undefined){t=e.getParameter("query")}else{t=e}if(t!=""){for(var r=0;r<=i.length-1;r++){if(i[r].children.find(e=>e.NameChild.toUpperCase().includes(t.toUpperCase())&&e.IsSelectable)){i[r].children.forEach(e=>{if(e.NameChild.toUpperCase().includes(t.toUpperCase())&&e.IsSelectable&&e.NameChild.toUpperCase()!="OTROS"){s.push(e)}})}}if(!s.find(e=>e.NameChild.toUpperCase()=="OTROS"))s.push(i.find(e=>e.NameChild.toUpperCase().includes("OTROS")&&e.IsSelectable==true));this.getModel("AntecedentFiltered").setProperty("/ZPMH",s);return}this.getModel("AntecedentFiltered").setProperty("/ZPMH",this.getModel("Antecedent").getProperty("/ZPMH"));this.getModel("AntecedentFiltered").refresh()},onTypeSurgicalAntecedents:function(e){this.onSearchSurgicalAntecedents(e.getParameter("newValue"))},onSearchSurgicalAntecedents:function(e){var t="";var s=[];var i=this.getModel("Antecedent").getProperty("/ZPSH");if(e.length==undefined){t=e.getParameter("query")}else{t=e}if(t!=""){if(i.find(e=>e.NameChild.toUpperCase().includes(t.toUpperCase())&&e.IsSelectable&&e.NameChild.toUpperCase()!="OTROS")){s=i.filter(e=>e.NameChild.toUpperCase().includes(t.toUpperCase())&&e.IsSelectable)}if(!s.find(e=>e.NameChild.toUpperCase()=="OTROS"))s.push(i.find(e=>e.NameChild.toUpperCase().includes("OTROS")&&e.IsSelectable==true));this.getModel("AntecedentFiltered").setProperty("/ZPSH",s);return}this.getModel("AntecedentFiltered").setProperty("/ZPSH",this.getModel("Antecedent").getProperty("/ZPSH"));this.getModel("AntecedentFiltered").refresh()},onTypeSocialHabits:function(e){this.onSearchSocialHabits(e.getParameter("newValue"))},onSearchSocialHabits:function(e){var t="";var s=[];var i=this.getModel("Antecedent").getProperty("/ZSHA");if(e.length==undefined){t=e.getParameter("query")}else{t=e}if(t!=""){if(i.find(e=>e.NameChild.toUpperCase().includes(t.toUpperCase())&&e.IsSelectable&&e.NameChild.toUpperCase()!="OTROS")){s=i.filter(e=>e.NameChild.toUpperCase().includes(t.toUpperCase())&&e.IsSelectable)}if(!s.find(e=>e.NameChild.toUpperCase()=="OTROS"))s.push(i.find(e=>e.NameChild.toUpperCase().includes("OTROS")&&e.IsSelectable==true));this.getModel("AntecedentFiltered").setProperty("/ZSHA",s);return}this.getModel("AntecedentFiltered").setProperty("/ZSHA",this.getModel("Antecedent").getProperty("/ZSHA"));this.getModel("AntecedentFiltered").refresh()},onTypeAllergies:function(e){this.onSearchAllergies(e.getParameter("newValue"))},onSearchAllergies:function(e){var t="";var s=[];var i=this.getModel("Allergy").getProperty("/results");if(e.length==undefined){t=e.getParameter("query")}else{t=e}if(t){for(var r=1;r<=i.length-1;r++){if(i[r].children!=undefined){i[r].children.forEach(e=>{if(e.children==undefined){if(e.Bcpname.toUpperCase().includes(t.toUpperCase())){s.push(e)}}else{e.children.forEach(e=>{if(e.Bcpname.toUpperCase().includes(t.toUpperCase())){s.push(e)}})}})}}s.push(i.find(e=>e.Extid==""));this.getModel("AllergyFiltered").setProperty("/results",s);return}this.getModel("AllergyFiltered").setProperty("/results",this.getModel("Allergy").getProperty("/results"));this.getModel("AllergyFiltered").refresh()},onTypeDiag_Judgment:function(e){this.onSearchDiag_Judgment(e.getParameter("newValue"))},onSearchDiag_Judgment:function(e){var t="";var s=this.getModel("DiagnosticsSet").getProperty("/results");if(e.length==undefined){t=e.getParameter("query")}else{t=e}if(t!=""){this.getModel("DiagnosticsSetFiltered").setProperty("/results",s.filter(e=>e.Description.toUpperCase().includes(t.toUpperCase())));return}this.getModel("DiagnosticsSetFiltered").setProperty("/results",this.getModel("DiagnosticsSet").getProperty("/results"));this.getModel("DiagnosticsSetFiltered").refresh()},onTypeImportDiag_Judgment:function(e){this.onSearchImportDiag_Judgment(e.getParameter("newValue"))},onSearchImportDiag_Judgment:function(e){var t="";var s=this.getModel("GetCaseDiagnostics").getProperty("/results");if(e.length==undefined){t=e.getParameter("query")}else{t=e}if(t!=""){this.getModel("GetCaseDiagnosticsFiltered").setProperty("/results",s.filter(e=>e.Description.toUpperCase().includes(t.toUpperCase())));return}this.getModel("GetCaseDiagnosticsFiltered").setProperty("/results",this.getModel("GetCaseDiagnostics").getProperty("/results"));this.getModel("GetCaseDiagnosticsFiltered").refresh()},onTypeServiceDialog:function(e){this.onSearchServiceDialog(e.getParameter("newValue"))},onSearchServiceDialog:function(e){var t="";var s=[];var i=this.getModel("ServiceTree").getProperty("/results");if(e.length==undefined){t=e.getParameter("query")}else{t=e}if(t!=""){for(var r=0;r<=i.length-1;r++){if(i[r].children.find(e=>e.Ktxt1.toUpperCase().includes(t.toUpperCase()))){i[r].children.forEach(e=>{if(e.Ktxt1.toUpperCase().includes(t.toUpperCase())){s.push(e)}})}}this.getModel("ServiceTreeFiltered").setProperty("/results",s);return}this.getModel("ServiceTreeFiltered").setProperty("/results",this.getModel("ServiceTree").getProperty("/results"));this.getModel("ServiceTreeFiltered").refresh()},onCancelAddRiskFactorsDialog:function(e){this.byId("RiskFactorsList").removeSelections(true);this.byId("RiskFactorSearchField").setValue("");this.closeAddAllergiesDialog(e)},onSaveAddRiskFactorsDialog:function(e,t){const s=e.getSource().getParent();s.setBusy(true);const i=this.byId("RiskFactorsList").getSelectedItems().map(e=>e.getBindingContext("RiskFactorFiltered").getProperty("Rsfnr"));this.getModel("ZISH_HCFI_SRV").callFunction("/AddRiskFactors",{urlParameters:{Institution:this.headers.Institution,Patient:this.headers.Patient,RiskFactors:i.join(",")},success:function(){s.setBusy(false);this.getMedicalDataOverview();this.byId("RiskFactorsList").removeSelections(true);this.byId("RiskFactorSearchField").clear();if(!t){s.close()}}.bind(this),error:function(e){s.setBusy(false);try{this.displayOdataError("AddRiskFactors",JSON.parse(e.responseText).error.message.value)}catch{this.displayOdataError("AddRiskFactors",e.message)}}.bind(this)})},onCancelDiagJudgment:function(e){this.byId("DiagList").removeSelections(true);this.destroyDialog(e)},onSaveDiagJudgment:function(e,t){const s=e.getSource().getParent();const i=this.byId("DiagList").getSelectedItems().map(e=>e.getBindingContext("DiagnosticsSetFiltered").getProperty("Code"));const r=this.byId("DiagList").getSelectedItems().map(e=>e.getBindingContext("DiagnosticsSetFiltered").getProperty("Description"));var a=this.getModel(t).getProperty("/Diagnoses");s.setBusy(true);i.forEach((e,t)=>{if(!a.find(t=>t.PAT_FDIACO==e))a.push({PAT_FDIACO:e,PAT_FDIACT:"",PAT_FDIAD:r[t],PAT_FDIAFT:"",PAT_FDIAID:"",PAT_FDIAO:""})});s.setBusy(false);this.byId("DiagList").removeSelections(true);s.close();s.destroy();this.getModel(t).refresh();this.onCancelDiagJudgment(e)},onSaveImportDiagJudgment:function(e,t){const s=e.getSource().getParent();const i=this.byId("DiagList").getSelectedItems().map(e=>e.getBindingContext("GetCaseDiagnosticsFiltered").getProperty("Dkey1"));const r=this.byId("DiagList").getSelectedItems().map(e=>e.getBindingContext("GetCaseDiagnosticsFiltered").getProperty("Dkat1"));const a=this.byId("DiagList").getSelectedItems().map(e=>e.getBindingContext("GetCaseDiagnosticsFiltered").getProperty("Lfdnr"));const o=this.byId("DiagList").getSelectedItems().map(e=>e.getBindingContext("GetCaseDiagnosticsFiltered").getProperty("Description"));const n=this.byId("DiagList").getSelectedItems().map(e=>e.getBindingContext("GetCaseDiagnosticsFiltered").getProperty("Ditxt"));var l=this.getModel(t).getProperty("/Diagnoses");s.setBusy(true);i.forEach((e,t)=>{if(!l.find(t=>t.PAT_FDIACO==e))l.push({PAT_FDIACO:e,PAT_FDIACT:r[t],PAT_FDIAD:o[t],PAT_FDIAFT:n[t],PAT_FDIAID:a[t],PAT_FDIAO:""})});s.setBusy(false);this.byId("DiagList").removeSelections(true);s.close();s.destroy();this.getModel(t).refresh();this.onCancelDiagJudgment(e)},onAddFamilyAntecedents:function(){if(!this._oAddFamilyAntecedentsDialog){this.loadFragment({type:"XML",name:"com.resulto.hcfi.view.AddFamilyAntecedentsDialog"}).then(function(e){this.setModel(d.createResultsModel(),"AntecedentFiltered");this.setModel(d.createResultsModel(),"NewFamilyHistory");this.getModel("AntecedentFiltered").setProperty("/ZMFH",this.getModel("Antecedent").getProperty("/ZMFH"));this._oAddFamilyAntecedentsDialog=e;this.getView().addDependent(this._oAddFamilyAntecedentsDialog);e.open()}.bind(this))}else{this._oAddFamilyAntecedentsDialog.open()}},onAddMedicalAntecedents:function(){if(!this._oAddMedicalAntecedentsDialog){this.loadFragment({type:"XML",name:"com.resulto.hcfi.view.AddMedicalAntecedentsDialog"}).then(function(e){this.setModel(d.createResultsModel(),"AntecedentFiltered");this.setModel(d.createResultsModel(),"NewMedicalHistory");this.getModel("AntecedentFiltered").setProperty("/ZPMH",this.getModel("Antecedent").getProperty("/ZPMH"));this._oAddMedicalAntecedentsDialog=e;this.getView().addDependent(this._oAddMedicalAntecedentsDialog);e.open()}.bind(this))}else{this._oAddMedicalAntecedentsDialog.open()}},onAddSurgicalAntecedents:function(){if(!this._oAddSurgicalAntecedentsDialog){this.loadFragment({type:"XML",name:"com.resulto.hcfi.view.AddSurgicalAntecedentsDialog"}).then(function(e){this.setModel(d.createResultsModel(),"AntecedentFiltered");this.setModel(d.createResultsModel(),"NewSurgeryHistory");this.getModel("AntecedentFiltered").setProperty("/ZPSH",this.getModel("Antecedent").getProperty("/ZPSH"));this._oAddSurgicalAntecedentsDialog=e;this.getView().addDependent(this._oAddSurgicalAntecedentsDialog);e.open()}.bind(this))}else{this._oAddSurgicalAntecedentsDialog.open()}},onAddSocialHabits:function(){this.setModel(d.createResultsModel(),"NewHabit");this.getModel("NewHabit").setProperty("/ZMEDMB_HAB_EVAL",this.getModel("KeyValue").getProperty("/ZMEDMB_HAB_EVAL/0"));this.getModel("NewHabit").setProperty("/ZMEDMB_FREQ",this.getModel("KeyValue").getProperty("/ZMEDMB_FREQ/0"));this.getModel("NewHabit").setProperty("/ZMEDMB_TOBACCO",this.getModel("KeyValue").getProperty("/ZMEDMB_TOBACCO/0"));this.getModel("NewHabit").setProperty("/ZMEDMB_FREQ_UNIT",this.getModel("KeyValue").getProperty("/ZMEDMB_FREQ_UNIT/0"));this.getModel("NewHabit").setProperty("/ZMEDMB_FREQ_COND",this.getModel("KeyValue").getProperty("/ZMEDMB_FREQ_COND/0"));if(!this._oAddSocialHabitsDialog){this.loadFragment({type:"XML",name:"com.resulto.hcfi.view.AddSocialHabitsDialog"}).then(function(e){this.setModel(d.createResultsModel(),"AntecedentFiltered");this.getModel("AntecedentFiltered").setProperty("/ZSHA",this.getModel("Antecedent").getProperty("/ZSHA"));this._oAddSocialHabitsDialog=e;this.getView().addDependent(this._oAddSocialHabitsDialog);e.open()}.bind(this))}else{this._oAddSocialHabitsDialog.open()}},onAddAllergies:function(){this.getModel("NewAllergy").setProperty("/",{Allergy:{},Adcomment:"",Evaluation:this.getModel("KeyValue").getProperty("/N2AD_EVALUATION/0/KeyValue"),Typ:this.getModel("KeyValue").getProperty("/N2AD_TYP/0/KeyValue"),Cer:this.getModel("KeyValue").getProperty("/N2AD_CER/0/KeyValue"),Reactions:[]});if(!this._AddAllergies){this.loadFragment({type:"XML",name:"com.resulto.hcfi.view.AddAllergiesDialog"}).then(function(e){this._AddAllergies=e;this.getView().addDependent(this._AddAllergies);this.setModel(d.createResultsModel(),"AllergyFiltered");this.getModel("AllergyFiltered").setProperty("/results",this.getModel("Allergy").getProperty("/results"));this.getModel("AllergyFiltered").setProperty("/loading",this.getModel("Allergy").getProperty("/loading"));this.getModel("AllergyFiltered").setProperty("/NoAllergy",this.getModel("Allergy").getProperty("/NoAllergy"));e.open()}.bind(this))}else{this._AddAllergies.open()}},configChange:function(e){const t=[];const s=e.getParameter("selectedItem").getBindingContext("Config").getObject().configurationToPositions.results.map(e=>e.positionId);s.forEach(function(e){t.push(this.byId("cbVitalSigns").getItemByKey(e))},this);this.byId("cbVitalSigns").setSelectedItems(t).fireSelectionFinish({selectedItems:t.filter(Boolean)})},vitalSignsSelectionFinish:function(e){if(this.byId("sTimeFilter").getSelectedItem()){const t=this.byId("sTimeFilter").getSelectedItem().getBindingContext("TimeFilter").getObject();if(e.getParameter("selectedItems").length)this.addTableColumns(e.getParameter("selectedItems").map(e=>e.getAdditionalText()),[t.start,t.end]);else this.addTableColumns(e.getSource().getItems().map(e=>e.getAdditionalText()),[t.start,t.end])}},onAllergySelect:function(e){const t=e.getSource().getParent().getParent();const s=e.getParameter("listItem");const i=JSON.parse(JSON.stringify(s.getBindingContext("AllergyFiltered").getObject()));const r=s.getBindingContext("AllergyFiltered").getPath().split("/").map(e=>parseInt(e)).filter(Number.isInteger).reduce((e,t)=>e+1+t,-1);s.setSelected(false);if(!i.IsGroup){if(i.Bcpname=="Otras alergias")i.Bcpname=this.byId("AllergiesSearchField").getValue();const e={...i};t.setCurrentStep(t.getSteps()[0]).nextStep();this.getModel("NewAllergy").setProperty("/Allergy",e)}else s.getExpanded()?e.getSource().collapse(r):e.getSource().expand(r)},onN2AD_CERChange:function(e){this.getModel("NewAllergy").setProperty("/Cer",e.getSource().getSelectedItem().getBindingContext("KeyValue").getProperty("KeyValue"))},onN2AD_EVALUATIONChange:function(e){this.getModel("NewAllergy").setProperty("/Evaluation",e.getSource().getSelectedItem().getBindingContext("KeyValue").getProperty("KeyValue"))},onN2AD_TYPChange:function(e){this.getModel("NewAllergy").setProperty("/Typ",e.getSource().getSelectedItem().getBindingContext("KeyValue").getProperty("KeyValue"))},onN2AD_REAChange:function(e){const t=e.getSource().getSelectedItem().getBindingContext("KeyValue").getProperty("KeyValue");const s=e.getSource().getParent().getBindingContext("NewAllergy").getPath();this.getModel("NewAllergy").setProperty(`${s}/Rea`,t)},onN2AD_SOAChange:function(e){const t=e.getSource().getSelectedItem().getBindingContext("KeyValue").getProperty("KeyValue");const s=e.getSource().getParent().getBindingContext("NewAllergy").getPath();this.getModel("NewAllergy").setProperty(`${s}/Soa`,t)},onEXPLO_MAMXSelect:function(e){this.getModel("CAD_GINE").setProperty("/content/EXPLO_MAMX/Value",e.getParameter("selected")?"X":"")},onSelect:function(e,t,s){this.getModel(t).setProperty(`/content/${s}/Value`,e.getParameter("selected")?"X":"");switch(s){case"EXPLO_MAMX":if(t==="CAD_MAM"){this.getModel(t).setProperty("/content/MAMA_DER2/Value",e.getParameter("selected")?this.getModel("KeyValue").getProperty("/MAMA_DER2/0/KeyText"):"");this.getModel(t).setProperty("/content/X00LA_DER/Value",e.getParameter("selected")?this.getModel("KeyValue").getProperty("/X00LA_DER/0/KeyText"):"");this.getModel(t).setProperty("/content/MAMA_IZQ2/Value",e.getParameter("selected")?this.getModel("KeyValue").getProperty("/MAMA_IZQ2/0/KeyText"):"");this.getModel(t).setProperty("/content/X00LA_IZQ/Value",e.getParameter("selected")?this.getModel("KeyValue").getProperty("/X00LA_IZQ/0/KeyText"):"")}else{this.getModel(t).setProperty("/content/MAMA_DER/Value",e.getParameter("selected")?this.getModel("KeyValue").getProperty("/MAMA_DER/0/KeyText"):"");this.getModel(t).setProperty("/content/MAMA_IZQ/Value",e.getParameter("selected")?this.getModel("KeyValue").getProperty("/MAMA_IZQ/0/KeyText"):"")}break;case"ECOX_GIN":this.getModel(t).setProperty("/content/UTERO_GIN/Value",e.getParameter("selected")?this.getModel("KeyValue").getProperty("/UTERO_GIN/0/KeyText"):"");this.getModel(t).setProperty("/content/ENDOM_GIN/Value",e.getParameter("selected")?this.getModel("KeyValue").getProperty("/ENDOM_GIN/0/KeyText"):"");this.getModel(t).setProperty("/content/OVARIO_DER/Value",e.getParameter("selected")?this.getModel("KeyValue").getProperty("/OVARIO_DER/0/KeyText"):"");this.getModel(t).setProperty("/content/OVARIO_IZQ/Value",e.getParameter("selected")?this.getModel("KeyValue").getProperty("/OVARIO_IZQ/0/KeyText"):"");this.getModel(t).setProperty("/content/ECO_GIN_OB/Value",e.getParameter("selected")?"":"");break;case"ECOX_MAM":if(t==="CAD_MAM"){this.getModel(t).setProperty("/content/ECO_MAM_T2/Value",e.getParameter("selected")?this.getModel("KeyValue").getProperty("/ECO_MAM_T2/0/KeyText"):"")}else{this.getModel(t).setProperty("/content/ECO_MAM_TX/Value",e.getParameter("selected")?this.getModel("KeyValue").getProperty("/ECO_MAM_TX/0/KeyText"):"")}break;case"MOV_FTRADI":var i=this.byId("container-hcfi---Main--cadae--rMOV_FTRADC");if(t==="CAD_AE"&&e.getParameter("selected")){i.setSelectedIndex(1);this.getModel("CAD_AE").setProperty("/content/MOV_FTRADC/Value",i.getSelectedButton().getBindingContext("KeyValue").getObject().KeyValue)}else{i.setSelectedIndex(0);this.getModel("CAD_AE").setProperty("/content/MOV_FTRADC/Value","")}}},onDIAG_GINChange:function(e){this.getModel("CAD_GINE").setProperty("/content/DIAG_GIN/Value",e.getParameter("value"))},onDIAG_MAMChange:function(e){this.getModel("CAD_MAM").setProperty("/content/DIAG_MAM/Value",e.getParameter("value"))},onDERIV_GINChange:function(e){this.getModel("CAD_GINE").setProperty("/content/DERIV_GIN/Value",e.getParameter("value"))},onENTR_INFSelect:function(e){this.getModel("CAD_GINE").setProperty(`${e.getSource().getParent().getBindingContext("CAD_GINE").getPath()}/ENTR_INF`,e.getParameter("selected")?"X":"")},onEMB_CTRFURChange:function(e){if(!this.getModel("CAD_CTREMB").getProperty("/content/EMB_FURCOR/Value"))this.onEMB_FURCORChange(e)},onEMB_FURCORChange:function(e){const t=e.getSource().getDateValue();const s=new Date;if(t){s.setTime(t.getTime()+7*40*24*60*60*1e3);this.getModel("CAD_CTREMB").setProperty("/content/EMB_CTRFPP/Value",n.getDateTimeInstance({pattern:"dd.MM.yyy"}).format(s));this.getModel("CAD_CTREMB").getProperty("/FirstTrimester").map(e=>{const s=e.CTRECOFECH.split(".");const i=new Date(s[2],s[1]-1,s[0]);e.EGSEMANAS=Math.floor((i.getTime()-t.getTime())/(1e3*3600*24)/7);e.EGDIAS=Math.floor((i.getTime()-t.getTime())/(1e3*3600*24)%7)});this.getModel("CAD_CTREMB").getProperty("/SecondTrimester").map(e=>{const s=e.X00ECOFECH.split(".");const i=new Date(s[2],s[1]-1,s[0]);e.X00EMANAS=Math.floor((i.getTime()-t.getTime())/(1e3*3600*24)/7);e.X00IAS=Math.floor((i.getTime()-t.getTime())/(1e3*3600*24)%7)});this.getModel("CAD_CTREMB").getProperty("/ThirdTrimester").map(e=>{const s=e.CTRECOFECH.split(".");const i=new Date(s[2],s[1]-1,s[0]);e.X01EMANAS=Math.floor((i.getTime()-t.getTime())/(1e3*3600*24)/7);e.X01IAS=Math.floor((i.getTime()-t.getTime())/(1e3*3600*24)%7)});this.getModel("CAD_CTREMB").getProperty("/Monitors").map(e=>{const s=e.EMBMONFECH.split(".");const i=new Date(s[2],s[1]-1,s[0]);e.X02EMANAS=Math.floor((i.getTime()-t.getTime())/(1e3*3600*24)/7);e.X02IAS=Math.floor((i.getTime()-t.getTime())/(1e3*3600*24)%7)});this.getModel("CAD_CTREMB").getProperty("/Births").map(e=>{const s=e.X00TOFECHA.split(".");const i=new Date(s[2],s[1]-1,s[0]);const r=Math.floor((i.getTime()-t.getTime())/(1e3*3600*24)/7);const a=Math.floor((i.getTime()-t.getTime())/(1e3*3600*24)%7);e.X00EMANAS=`${r} SS ${a} d`});this.getModel("CAD_CTREMB").updateBindings(true)}},onTIPOEMBARChange:function(e){this.getModel("CAD_CTREMB").setProperty("/content/TIPOEMBAR/Value",e.getParameter("value"))},onPARTOFECHAChange:function(e){const t=e.getSource().getDateValue();const s=this.getModel("CAD_CTREMB").getProperty("/content/EMB_FURCOR/Value").split(".");const i=new Date(s[2],s[1]-1,s[0]);this.getModel("CAD_CTREMB").setProperty("/content/X03EMANAS/Value",Math.floor((t.getTime()-i.getTime())/(1e3*3600*24)/7))},onMOV_FDATDIChange:function(e){const t=e.getSource().getDateValue();this.getModel("CAD_CTREMB").setProperty("/content/MOV_FDATDI/Value",n.getDateTimeInstance({pattern:"dd.MM.yyyy"}).format(t))},onEMBRIONESChange:function(e){const t=parseInt(e.getParameter("value"));const s=this.getModel("CAD_CTREMB").getProperty("/SexT2");const i=this.getModel("CAD_CTREMB").getProperty("/SexT3");const r=s.length;const a=this.getModel("CAD_CTREMB").getProperty("/Births");const o=this.getModel("CAD_CTREMB").getProperty("/FirstTrimester");const n=[];const l=this.getModel("CAD_CTREMB").getProperty("/SecondTrimester");const d=[];const c=this.getModel("CAD_CTREMB").getProperty("/ThirdTrimester");const g=[];if(r>t){s.length=t;i.length=t;a.length=t;for(let e=0;e<o.length;e+=r){const s=o.slice(e,e+r);s.length=t;n.push(s)}for(let e=0;e<l.length;e+=r){const s=l.slice(e,e+r);s.length=t;d.push(s)}for(let e=0;e<c.length;e+=r){const s=c.slice(e,e+r);s.length=t;g.push(s)}}else{for(let e=s.length;e<t;e++)s.push({EMB_EMBID:e+1,EMB_SEXO:this.getModel("KeyValue").getProperty("/EMB_SEXO/0")});for(let e=i.length;e<t;e++)i.push({X00_EMBID:e+1,X00_SEXO:this.getModel("KeyValue").getProperty("/X00_SEXO/0")});for(let e=a.length;e<t;e++)a.push({X01_EMBID:e+1,X00TOFECHA:"",X00TOHORA:"",EGAMPLIADA:"",X00TOTIPO:"",X00TOCESAR:"",DECESO:"",NACPESO:"",NACSEXO:"",APGAR:"",ALUMBRA:"",CORDON:"",PH:"",X00TOFINTP:""});for(let e=0;e<o.length;e+=r){const s=o.slice(e,e+r);for(let e=r;e<t;e++)s.push({CTRECOID:s[0].CTRECOID,CTRECOFECH:s[0].CTRECOFECH,X02_EMBID:e+1,EGSEMANAS:s[0].EGSEMANAS,EGDIAS:s[0].EGDIAS,CTRECOTA:s[0].CTRECOTA,CTRECOKG:s[0].CTRECOKG,CTRECOCOM:s[0].CTRECOCOM,CTRECOTROB:s[0].CTRECOTROB,CREATED_BY:s[0].CREATED_BY});n.push(s)}for(let e=0;e<l.length;e+=r){const s=l.slice(e,e+r);for(let e=r;e<t;e++)s.push({X00ECOID:s[0].X00ECOID,X00ECOFECH:s[0].X00ECOFECH,X03_EMBID:e+1,X00EMANAS:s[0].X00EMANAS,X00IAS:s[0].X00IAS,X00ECOTA:s[0].X00ECOTA,X00ECOKG:s[0].X00ECOKG,CTRECOPRES:s[0].CTRECOPRES,CTRECOFC:s[0].CTRECOFC,CTRECOPFE:s[0].CTRECOPFE,CTRECOACOR:s[0].CTRECOACOR,CTRECOLA:s[0].CTRECOLA,CTRECOPLAC:s[0].CTRECOPLAC,CTRECODOPP:s[0].CTRECODOPP,CTRECOMORF:s[0].CTRECOMORF,X00ECOTROB:s[0].X00ECOTROB,X00ATED_BY:s[0].X00ATED_BY});d.push(s)}for(let e=0;e<c.length;e+=r){const s=c.slice(e,e+r);for(let e=r;e<t;e++)s.push({X01ECOID:s[0].X01ECOID,X01ECOFECH:s[0].X01ECOFECH,X04_EMBID:e+1,X01EMANAS:s[0].X01EMANAS,X01IAS:s[0].X01IAS,X01ECOTA:s[0].X01ECOTA,X01ECOKG:s[0].X01ECOKG,X00ECOPRES:s[0].X00ECOPRES,X00ECOFC:s[0].X00ECOFC,X00ECOPFE:s[0].X00ECOPFE,X00ECOACOR:s[0].X00ECOACOR,X00ECOLA:s[0].X00ECOLA,X00ECOPLAC:s[0].X00ECOPLAC,X00ECODOPP:s[0].X00ECODOPP,X00ECOMORF:s[0].X00ECOMORF,X01ECOTROB:s[0].X01ECOTROB,X01ATED_BY:s[0].X01ATED_BY});g.push(s)}}this.getModel("CAD_CTREMB").setProperty("/FirstTrimester",n.flat());this.getModel("CAD_CTREMB").setProperty("/SecondTrimester",d.flat());this.getModel("CAD_CTREMB").setProperty("/ThirdTrimester",g.flat())},onPARTOTIPOChange:function(e){this.getModel("CAD_CTREMB").setProperty("/content/PARTOTIPO/Value",e.getParameter("value"))},onAddUltrasoundControlPressed:function(e){const t=this.getModel("CAD_CTREMB").getProperty("/content/EMB_FURCOR/Value")||this.getModel("CAD_CTREMB").getProperty("/content/EMB_CTRFUR/Value");const s=parseInt(this.getModel("CAD_CTREMB").getProperty("/content/EMBRIONES/Value")||0);if(!t)i.error(this.getModel("i18n").getProperty("FURRequiredField"));if(!s)i.error(this.getModel("i18n").getProperty("EMBRIONESRequiredField"));else{const s=t.split(".");const i=new Date(s[2],s[1]-1,s[0]);this.loadFragment({type:"XML",name:"com.resulto.hcfi.view.CAD_CTREMB.AddUltrasoundControlDialog"}).then(t=>{t.getContent()[1].setMaxDate(new Date).setMinDate(i);t.setModel(new sap.ui.model.json.JSONModel({table:e})).open()})}},onCancelAddUltrasoundControlDialog:function(e){e.getSource().getParent().close();e.getSource().getParent().destroy()},onSaveAddUltrasoundControlDialog:function(e){const t=e.getSource().getParent().getContent()[1].getDateValue();const s=e.getSource().getParent().getContent()[3].getValue();const r=e.getSource().getParent().getContent()[5].getValue();if(!t)i.error(this.getModel("i18n").getProperty("NewUltrasoundControlRequiredField"));else{const i=this.getModel("CAD_CTREMB").getProperty("/content/EMB_FURCOR/Value")||this.getModel("CAD_CTREMB").getProperty("/content/EMB_CTRFUR/Value");const a=i.split(".");const o=new Date(a[2],a[1]-1,a[0]);const l=e.getSource().getParent().getModel().getProperty("/table");const d=e.getSource().getParent().getModel().getProperty("/id");const c=this.uuidv4();for(let e=0;e<parseInt(this.getModel("CAD_CTREMB").getProperty("/content/EMBRIONES/Value"));e++){switch(l){case"/FirstTrimester":if(d){const i=this.getModel("CAD_CTREMB").getProperty(l).find(t=>t.CTRECOID===d&&t.X02_EMBID==e+1);i.CTRECOFECH=n.getDateTimeInstance({pattern:"dd.MM.yyy"}).format(t);i.EGSEMANAS=Math.floor((t.getTime()-o.getTime())/(1e3*3600*24)/7);i.EGDIAS=Math.floor((t.getTime()-o.getTime())/(1e3*3600*24)%7);i.CTRECOTA=s;i.CTRECOKG=r}else this.getModel("CAD_CTREMB").getProperty(l).push({CTRECOID:c,CTRECOFECH:n.getDateTimeInstance({pattern:"dd.MM.yyy"}).format(t),X02_EMBID:e+1,EGSEMANAS:Math.floor((t.getTime()-o.getTime())/(1e3*3600*24)/7),EGDIAS:Math.floor((t.getTime()-o.getTime())/(1e3*3600*24)%7),CTRECOTA:s,CTRECOKG:r,CTRECOCOM:this.getModel("KeyValue").getProperty("/CTRECOCOM/0/KeyText"),CREATED_BY:""});break;case"/SecondTrimester":if(d){const i=this.getModel("CAD_CTREMB").getProperty(l).find(t=>t.X00ECOID===d&&t.X03_EMBID==e+1);i.X00ECOFECH=n.getDateTimeInstance({pattern:"dd.MM.yyy"}).format(t);i.X00EMANAS=Math.floor((t.getTime()-o.getTime())/(1e3*3600*24)/7);i.X00IAS=Math.floor((t.getTime()-o.getTime())/(1e3*3600*24)%7);i.X00ECOTA=s;i.X00ECOKG=r}else this.getModel("CAD_CTREMB").getProperty(l).push({X00ECOID:c,X00ECOFECH:n.getDateTimeInstance({pattern:"dd.MM.yyy"}).format(t),X03_EMBID:e+1,X00EMANAS:Math.floor((t.getTime()-o.getTime())/(1e3*3600*24)/7),X00IAS:Math.floor((t.getTime()-o.getTime())/(1e3*3600*24)%7),X00ECOTA:s,X00ECOKG:r,CTRECOPRES:"",CTRECOFC:"",CTRECOPFE:"",CTRECOACOR:"",CTRECOLA:"",CTRECOPLAC:"",CTRECODOPP:"",CTRECOMORF:"",X00ATED_BY:""});break;case"/ThirdTrimester":if(d){const i=this.getModel("CAD_CTREMB").getProperty(l).find(t=>t.X01ECOID===d&&t.X04_EMBID==e+1);i.X01ECOFECH=n.getDateTimeInstance({pattern:"dd.MM.yyy"}).format(t);i.X01EMANAS=Math.floor((t.getTime()-o.getTime())/(1e3*3600*24)/7);i.X01IAS=Math.floor((t.getTime()-o.getTime())/(1e3*3600*24)%7);i.X01ECOTA=s;i.X01ECOKG=r}else this.getModel("CAD_CTREMB").getProperty(l).push({X01ECOID:c,X01ECOFECH:n.getDateTimeInstance({pattern:"dd.MM.yyy"}).format(t),X04_EMBID:e+1,X01EMANAS:Math.floor((t.getTime()-o.getTime())/(1e3*3600*24)/7),X01IAS:Math.floor((t.getTime()-o.getTime())/(1e3*3600*24)%7),X01ECOTA:s,X01ECOKG:r,X00ECOPRES:"",X00ECOFC:"",X00ECOPFE:"",X00ECOACOR:"",X00ECOLA:"",X00ECOPLAC:"",X00ECODOPP:"",X00ECOMORF:"",X01ATED_BY:""});break}}this.getModel("CAD_CTREMB").updateBindings(true);this.onCancelAddUltrasoundControlDialog(e)}},onEditUltrasoundControl:function(e,t){const s=this.getModel("CAD_CTREMB").getProperty("/content/EMB_FURCOR/Value")||this.getModel("CAD_CTREMB").getProperty("/content/EMB_CTRFUR/Value");const r=parseInt(this.getModel("CAD_CTREMB").getProperty("/content/EMBRIONES/Value")||0);if(!s)i.error(this.getModel("i18n").getProperty("FURRequiredField"));if(!r)i.error(this.getModel("i18n").getProperty("EMBRIONESRequiredField"));else{const i=s.split(".");const r=new Date(i[2],i[1]-1,i[0]);const a=e.getParameter("item").getBindingContext("CAD_CTREMB").getObject();this.loadFragment({type:"XML",name:"com.resulto.hcfi.view.CAD_CTREMB.AddUltrasoundControlDialog"}).then(e=>{switch(t){case"/FirstTrimester":e.getContent()[1].setMaxDate(new Date).setMinDate(r).setValue(a.CTRECOFECH);e.getContent()[3].setValue(a.CTRECOTA);e.getContent()[5].setValue(parseFloat(a.CTRECOKG));e.setModel(new sap.ui.model.json.JSONModel({table:t,id:a.CTRECOID})).open();break;case"/SecondTrimester":e.getContent()[1].setMaxDate(new Date).setMinDate(r).setValue(a.X00ECOFECH);e.getContent()[3].setValue(a.X00ECOTA);e.getContent()[5].setValue(parseFloat(a.X00ECOKG));e.setModel(new sap.ui.model.json.JSONModel({table:t,id:a.X00ECOID})).open();break;case"/ThirdTrimester":e.getContent()[1].setMaxDate(new Date).setMinDate(r).setValue(a.X01ECOFECH);e.getContent()[3].setValue(a.X01ECOTA);e.getContent()[5].setValue(parseFloat(a.X01ECOKG));e.setModel(new sap.ui.model.json.JSONModel({table:t,id:a.X01ECOID})).open();break}})}},onDeleteUltrasoundControl:function(e,t){const s=e.getParameter("item").getBindingContext("CAD_CTREMB").getObject();this.getModel("CAD_CTREMB").setProperty(t,this.getModel("CAD_CTREMB").getProperty(t).filter(e=>{switch(t){case"/FirstTrimester":return e["CTRECOID"]!==s["CTRECOID"];case"/SecondTrimester":return e["X00ECOID"]!==s["X00ECOID"];case"/ThirdTrimester":return e["X01ECOID"]!==s["X01ECOID"]}return true}))},onAddMonitorsPressed:function(){const e=new Date;const t=this.getModel("CAD_CTREMB").getProperty("/content/EMB_FURCOR/Value")||this.getModel("CAD_CTREMB").getProperty("/content/EMB_CTRFUR/Value");if(t){const s=t.split(".");const i=new Date(s[2],s[1]-1,s[0]);this.getModel("CAD_CTREMB").getProperty("/Monitors").push({EMBMONFECH:n.getDateTimeInstance({pattern:"dd.MM.yyyy"}).format(e),X02EMANAS:Math.floor((e.getTime()-i.getTime())/(1e3*3600*24)/7),X02IAS:Math.floor((e.getTime()-i.getTime())/(1e3*3600*24)%7),EMBMONREG:"",EMBMONTACT:""});this.getModel("CAD_CTREMB").updateBindings(true)}else i.error(this.getModel("i18n").getProperty("FURRequiredField"))},onEMBMONFECHChange:function(e){const t=e.getSource().getDateValue();const s=this.getModel("CAD_CTREMB").getProperty("/content/EMB_FURCOR/Value")||this.getModel("CAD_CTREMB").getProperty("/content/EMB_CTRFUR/Value");const i=s.split(".");const r=new Date(i[2],i[1]-1,i[0]);const a=e.getSource().getBindingContext("CAD_CTREMB").getObject();a.X02EMANAS=Math.floor((t.getTime()-r.getTime())/(1e3*3600*24)/7);a.X02IAS=Math.floor((t.getTime()-r.getTime())/(1e3*3600*24)%7);this.getModel("CAD_CTREMB").updateBindings(true)},onDeleteMonitors:function(e){this.getModel("CAD_CTREMB").setProperty(e.getParameter("listItem").getBindingContextPath(),null);this.getModel("CAD_CTREMB").setProperty("/Monitors",this.getModel("CAD_CTREMB").getProperty("/Monitors").filter(Boolean))},onAddAfterbirthReviewPressed:function(){this.getModel("CAD_CTREMB").getProperty("/AfterbirthReview").push({REVPPFECHA:n.getDateTimeInstance({pattern:"dd.MM.yyyy"}).format(new Date),REVPPESTGN:"",REVPPECO:"",REVPPOBS:""});this.getModel("CAD_CTREMB").updateBindings(true)},onDeleteAfterbirthReview:function(e){this.getModel("CAD_CTREMB").setProperty(e.getParameter("listItem").getBindingContextPath(),null);this.getModel("CAD_CTREMB").setProperty("/AfterbirthReview",this.getModel("CAD_CTREMB").getProperty("/AfterbirthReview").filter(Boolean))},onAddReaction:function(){const e=this.getModel("NewAllergy").getProperty("/Reactions");e.push({Patnr:this.headers.Patient,AllergySeqno:"99999",ReactSeqno:e.length,Rea:this.getModel("KeyValue").getProperty("/N2AD_REA/0/KeyValue"),Soa:this.getModel("KeyValue").getProperty("/N2AD_SOA/0/KeyValue")});this.getModel("NewAllergy").refresh(true)},onRemoveSelectedSamples:function(e){const t=this.getModel("NewAllergy").getProperty("/Reactions");e.getSource().getParent().getParent().getSelectedItems().forEach(e=>{e.getBindingContext("NewAllergy").getObject().ReactSeqno=null});this.getModel("NewAllergy").setProperty("/Reactions",t.filter(e=>e.ReactSeqno!==null));e.getSource().getParent().getParent().removeSelections(true)},onCancelAddAllergiesAntecedentsDialog:function(e){this.getModel("Allergy").setProperty("/NoAllergy",this.noAllergy);this.getModel("NewFamilyHistory").setProperty("/",{Antecedent:{},Father:false,Mother:false,Brother:false,Sister:false,PaternalGrandparent:false,MaternalGrandparent:false,Children:false,Comments:"",Observations:""});this.getModel("NewMedicalHistory").setProperty("/",{Antecedent:{},Date:null,Medication:"",Comments:"",Observations:""});this.getModel("NewSurgeryHistory").setProperty("/",{Antecedent:{},Date:null,Comments:"",Observations:""});this.getModel("NewHabit").setProperty("/",{Antecedent:{},ZMEDMB_HAB_EVAL:{},From:"",To:"",ZMEDMB_FREQ:{},ZMEDMB_TOBACCO:{},ZMEDMB_FREQ_UNIT:{},ZMEDMB_FREQ_COND:{},GrWeek:"",Comments:""});if(this.byId("N2AD_CER"))this.byId("N2AD_CER").setSelectedKey();if(this.byId("N2AD_EVALUATION"))this.byId("N2AD_EVALUATION").setSelectedKey();if(this.byId("N2AD_TYP"))this.byId("N2AD_TYP").setSelectedKey();if(this.byId("ZMEDMB_HAB_EVAL"))this.byId("ZMEDMB_HAB_EVAL").setSelectedKey();if(this.byId("ZMEDMB_FREQ"))this.byId("ZMEDMB_FREQ").setSelectedKey();if(this.byId("ZMEDMB_TOBACCO"))this.byId("ZMEDMB_TOBACCO").setSelectedKey();if(this.byId("ZMEDMB_FREQ_UNIT"))this.byId("ZMEDMB_FREQ_UNIT").setSelectedKey();if(this.byId("ZMEDMB_FREQ_COND"))this.byId("ZMEDMB_FREQ_COND").setSelectedKey();this.closeAddAllergiesDialog(e)},onSaveAddAllergiesDialog:function(e,t){const s=e.getSource().getParent();const i=e.getSource().getParent().getContent()[0];s.setBusy(true);const r=this.getModel("NewAllergy").getData();if(this.noAllergy!==this.getModel("Allergy").getProperty("/NoAllergy"))this.setNoReferredAllergy();if(!this.getModel("Allergy").getProperty("/NoAllergy")){const e={Patnr:this.headers.Patient,AllergySeqno:"99999",Bchid:r.Allergy.Bchid,Bcpid:r.Allergy.Bcpid,BchidAgr:r.Allergy.BchidAgr,BcpidAgr:r.Allergy.BcpidAgr,Adcomment:r.Adcomment,Evaluation:r.Evaluation,Typ:r.Typ,Cer:r.Cer,Agr:"",Mdtyp:"",Drugid:null,Agentid:null,Descr:"",DescrOt:"",AdcommentLt:false,BchidTyp:"",BcpidTyp:"",BchidCer:"",BcpidCer:"",Responsible:"",Ereason:"",CancelReason:"",CancelFlag:false,Nor:"",reactions:r.Reactions.map((e,t)=>({Patnr:this.headers.Patient,AllergySeqno:"99999",ReactSeqno:t.toString(),Rea:e.Rea,Soa:e.Soa,BchidRea:"",BcpidRea:"",BchidSoa:"",BcpidSoa:"",Ereason:"",CreateDate:null,CreateTime:"PT00H00M00S",CreateUser:"",UpdateDate:null,UpdateTime:"PT00H00M00S",UpdateUser:"",CancelDate:null,CancelTime:"PT00H00M00S",CancelUser:"",CancelReason:"",CancelFlag:false}))};if(!r.Allergy.Bchid&&!r.Allergy.Bcpid){e.Descr=r.Allergy.Bcpname}this.getModel("ZISH_HCFI_SRV").create("/AllergySet",e,{success:function(){i.discardProgress(i.getSteps()[0]);i.getSteps()[0].getContent()[1].collapseAll();this.getMedicalDataOverview();s.setBusy(false);this.byId("N2AD_CER").setSelectedKey("");this.byId("N2AD_EVALUATION").setSelectedKey("");this.byId("N2AD_TYP").setSelectedKey("");this.byId("reactionType").setSelectedKey("");this.byId("gravity").setSelectedKey("");this.getModel("NewAllergy").setProperty("/",{Allergy:{},Adcomment:"",Evaluation:this.getModel("KeyValue").getProperty("/N2AD_EVALUATION/0/KeyValue"),Typ:this.getModel("KeyValue").getProperty("/N2AD_TYP/0/KeyValue"),Cer:this.getModel("KeyValue").getProperty("/N2AD_CER/0/KeyValue"),Reactions:[]});if(!t){s.close()}}.bind(this),error:function(e){s.setBusy(false);try{this.displayOdataError("AllergySet",JSON.parse(e.responseText).error.message.value)}catch{this.displayOdataError("AllergySet",e.message)}}.bind(this)})}else{this.getMedicalDataOverview();s.setBusy(false);s.close()}},onUpdateAllergies:function(e){let t=this.getModel("NewAllergy").getData();const s={Patnr:this.headers.Patient,AllergySeqno:t.AllergySeqno,Bchid:t.Bchid,Bcpid:t.Bcpid,BchidAgr:t.Allergy.Bchid,BcpidAgr:t.Allergy.Bcpid,Adcomment:t.Adcomment,Evaluation:t.Evaluation,Typ:t.Typ,Cer:t.Cer,Agr:t.Agr,Mdtyp:t.Mdtyp,Drugid:t.Drugid,Agentid:t.Agentid,Descr:t.Descr,DescrOt:t.DescrOt,AdcommentLt:t.AdcommentLt,BchidTyp:t.BchidTyp,BcpidTyp:t.BcpidTyp,BchidCer:t.BchidCer,BcpidCer:t.BcpidCer,Responsible:t.Responsible,Ereason:t.Ereason,CancelReason:t.CancelReason,CancelFlag:t.CancelFlag,Nor:t.Nor,reactions:t.Reactions.map((e,s)=>({Patnr:this.headers.Patient,AllergySeqno:t.AllergySeqno,ReactSeqno:s.toString(),Rea:e.Rea,Soa:e.Soa,BchidRea:e.BchidRea,BcpidRea:e.BcpidRea,BchidSoa:e.BchidSoa,BcpidSoa:e.BcpidSoa,Ereason:e.Ereason,CreateDate:null,CreateTime:"PT00H00M00S",CreateUser:e.CreateUser,UpdateDate:null,UpdateTime:"PT00H00M00S",UpdateUser:e.UpdateUser,CancelDate:null,CancelTime:"PT00H00M00S",CancelUser:e.CancelUser,CancelReason:e.CancelReason,CancelFlag:e.CancelFlag}))};this.getModel("ZISH_HCFI_SRV").create("/AllergySet",s,{method:"PUT",success:function(){e.getParent().close();this.getMedicalDataOverview()}.bind(this),error:function(e){try{this.displayOdataError("AllergySet",JSON.parse(e.responseText).error.message.value)}catch{this.displayOdataError("AllergySet",e.message)}}.bind(this)})},onUpdateFamilyAntecedents:function(e){const t=this.getModel("MainData").getProperty("/MovementData");let s=this.getModel("NewFamilyHistory").getData();let i=new Date;if(s.Erdat){i=new Date(s.Erdat);i.setDate(i.getDate()+1);i.setHours(8)}const r={FamilyHistid:s.FamilyHistguid,Einri:this.headers.Institution,Patnr:this.headers.Patient,Bchid:s.Antecedent.BchidChild,Bcpid:s.Antecedent.BcpidChild,Problem:s.Problem,Father:s.Father,Mother:s.Mother,Brother:s.Brother,Sister:s.Sister,GrandParent:s.GrandParent,MaternalGrandparents:s.MaternalGrandparents,PaternalGrandparents:s.PaternalGrandparents,Son:s.Son,FamComment:s.Comments,RemarksInt:s.Observations,RespEmp:s.RespEmp,Departmentou:t.Orgfa,Treatou:t.Orgpf,Erusr:s.Erusr,Erdat:i,Ertim:"PT00H00M00S",Upusr:s.Upusr,Updat:null,Uptim:"PT00H00M00S",Storn:false,Stusr:s.Stusr,Stdat:null,Sttim:"PT00H00M00S"};this.getModel("ZISH_HCFI_SRV").update("/FamilyHistorySet(guid'"+s.FamilyHistguid+"')",r,{success:function(){e.getParent().close();this.getMedicalDataOverview()}.bind(this),error:function(e){try{this.displayOdataError("UpdateFamilyAntecedents",JSON.parse(e.responseText).error.message.value)}catch{this.displayOdataError("UpdateFamilyAntecedents",e.message)}}.bind(this)})},onUpdateMedicalAntecedents:function(e){let t=this.getModel("NewMedicalHistory").getData();const s=this.getModel("MainData").getProperty("/MovementData");if(t.DateMedHist)t.DateMedHist.setHours(8);const i={MedHistid:t.MedHistguid,Einri:this.headers.Institution,Patnr:this.headers.Patient,Bchid:t.Antecedent.BchidChild,Bcpid:t.Antecedent.BcpidChild,Remarks:t.Comments,RemarksInt:t.Observations,Treatment:t.Medication,DateMedHist:t.DateMedHist,RespEmp:t.RespEmp,Departmentou:s.Orgfa,Treatou:s.Orgpf,Erusr:t.Erusr,Erdat:t.Erdat,Ertim:"PT00H00M00S",Upusr:"",Updat:null,Uptim:"PT00H00M00S",Storn:false,Stusr:"",Stdat:null,Sttim:"PT00H00M00S"};this.getModel("ZISH_HCFI_SRV").update("/MedicalHistorySet(guid'"+t.MedHistguid+"')",i,{success:function(){e.getParent().close();this.getMedicalDataOverview()}.bind(this),error:function(e){try{this.displayOdataError("AllergySet",JSON.parse(e.responseText).error.message.value)}catch{this.displayOdataError("AllergySet",e.message)}}.bind(this)})},onUpdateSurgicalAntecedents:function(e){let t=this.getModel("NewSurgeryHistory").getData();const s=this.getModel("MainData").getProperty("/MovementData");if(t.DateSurg)t.DateSurg.setHours(8);const i={SurgHistid:t.SurgHistguid,Einri:this.headers.Institution,Patnr:this.headers.Patient,Bchid:t.Antecedent.BchidChild,Bcpid:t.Antecedent.BcpidChild,Remarks:t.Comments,RemarksInt:t.Observations,DateSurg:t.DateSurg,RespEmp:t.RespEmp,Departmentou:s.Orgfa,Treatou:s.Orgpf,Erusr:t.Erusr,Erdat:t.Erdat,Ertim:"PT00H00M00S",Upusr:t.Upusr,Updat:null,Uptim:"PT00H00M00S",Storn:false,Stusr:"",Stdat:null,Sttim:"PT00H00M00S"};this.getModel("ZISH_HCFI_SRV").update("/SurgeryHistorySet(guid'"+t.SurgHistguid+"')",i,{success:function(){this.getMedicalDataOverview();e.getParent().close()}.bind(this),error:function(e){try{this.displayOdataError("UpdateSurgery",JSON.parse(e.responseText).error.message.value)}catch{this.displayOdataError("UpdateSurgery",e.message)}}.bind(this)})},onUpdateSocialHabits:function(e){let t=this.getModel("NewHabit").getData();var s=this.getModel("Antecedent").getProperty("/ZSHA").find(e=>e.ExtidChild==t.Type);var i=t.Evaluation=="2";if(!t.From&&i){this.displayOdataError(this.getModel("i18n").getProperty("RequiredField"),this.getModel("i18n").getProperty("NewHabitRequiredField"));return}if(!i){t.Frequency="1";t.FrequencyUnit="D";t.TobaccoType="1";t.FrequencyCond="SO";t.From="";t.To="";t.Status="";t.Quantity="";t.HabitOrder="";t.Comment="";t.OtherTypeText=""}const r={Habitid:t.Habitid,Frequency:t.Frequency,FrequencyUnit:t.FrequencyUnit,Evaluation:t.Evaluation,TobaccoType:t.TobaccoType,FrequencyCond:t.FrequencyCond,From:t.From,To:t.To,Type:"",OtherTypeText:t.OtherTypeText,Status:t.Status,Quantity:t.Quantity,HabitOrder:t.HabitOrder,Patient:this.headers.Patient,Comment:t.Comment,Bchid:s.BchidChild,Bcpid:s.BcpidChild,Institution:this.headers.Institution,Case:this.headers.Case};this.getModel("ZISH_HCFI_SRV").update("/HabitSet(Habitid=guid'"+t.Habitid+"',Bcpid='"+s.BcpidChild+"')",r,{success:function(){e.getParent().close();this.getMedicalDataOverview()}.bind(this),error:function(e){try{this.displayOdataError("AllergySet",JSON.parse(e.responseText).error.message.value)}catch{this.displayOdataError("AllergySet",e.message)}}.bind(this)})},onFamilyAntecedentsSelect:function(e){const t=e.getSource().getParent().getParent();const s=e.getParameter("listItem");const i=JSON.parse(JSON.stringify(s.getBindingContext("AntecedentFiltered").getObject()));const r=s.getBindingContext("AntecedentFiltered").getPath().split("/").map(e=>parseInt(e)).filter(Number.isInteger).reduce((e,t)=>e+1+t,-1);s.setSelected(false);if(i.IsSelectable){if(i.ExtidChild=="Otros")this.getModel("NewFamilyHistory").setProperty("/Comments",this.byId("familyAntecedentsSearchField").getValue());t.setCurrentStep(t.getSteps()[0]).nextStep();this.getModel("NewFamilyHistory").setProperty("/Antecedent",i)}else s.getExpanded()?e.getSource().collapse(r):e.getSource().expand(r)},onSaveAddFamilyAntecedentsDialog:function(e,t){const s=e.getSource().getParent();const i=e.getSource().getParent().getContent()[0];s.setBusy(true);const r=this.getModel("NewFamilyHistory").getData();const a=this.getModel("MainData").getProperty("/MovementData");const o={FamilyHistid:"99999999-9999-9999-9999-999999999999",Einri:this.headers.Institution,Patnr:this.headers.Patient,Bchid:r.Antecedent.BchidChild,Bcpid:r.Antecedent.BcpidChild,Problem:"",Father:r.Father,Mother:r.Mother,Brother:r.Brother,Sister:r.Sister,GrandParent:false,MaternalGrandparents:r.MaternalGrandparent,PaternalGrandparents:r.PaternalGrandparent,Son:r.Children,FamComment:r.Comments,RemarksInt:r.Observations,RespEmp:"",Departmentou:a.Orgfa,Treatou:a.Orgpf,Erusr:"",Erdat:new Date,Ertim:"PT00H00M00S",Upusr:"",Updat:null,Uptim:"PT00H00M00S",Storn:false,Stusr:"",Stdat:null,Sttim:"PT00H00M00S"};this.getModel("ZISH_HCFI_SRV").create("/FamilyHistorySet",o,{success:function(){i.discardProgress(i.getSteps()[0]);i.getSteps()[0].getContent()[1].collapseAll();s.setBusy(false);this.getMedicalDataOverview();this.byId("familyAntecedentsSearchField").setValue("");this.byId("familyAntecedentsSearchField").clear();this.getModel("NewFamilyHistory").setProperty("/",{Antecedent:{},Father:false,Mother:false,Brother:false,Sister:false,PaternalGrandparent:false,MaternalGrandparent:false,Children:false,Comments:"",Observations:""});if(!t){s.close()}}.bind(this),error:function(e){s.setBusy(false);try{this.displayOdataError("FamilyHistorySet",JSON.parse(e.responseText).error.message.value)}catch{this.displayOdataError("FamilyHistorySet",e.message)}}.bind(this)})},onMedicalAntecedentsSelect:function(e){const t=e.getSource().getParent().getParent();const s=e.getParameter("listItem");const i=s.getBindingContext("AntecedentFiltered").getObject();const r=s.getBindingContext("AntecedentFiltered").getPath().split("/").map(e=>parseInt(e)).filter(Number.isInteger).reduce((e,t)=>e+1+t,-1);s.setSelected(false);if(i.IsSelectable){if(i.ExtidChild=="Otros")this.getModel("NewMedicalHistory").setProperty("/Comments",this.byId("SearchMedicalAntecedents").getValue());t.setCurrentStep(t.getSteps()[0]).nextStep();this.getModel("NewMedicalHistory").setProperty("/Antecedent",i)}else s.getExpanded()?e.getSource().collapse(r):e.getSource().expand(r)},onMedicalAntecedentsDateChange:function(e){this.getModel("NewMedicalHistory").setProperty("/Date",e.getSource().getProperty("dateValue"))},onSaveAddMedicalAntecedentsDialog:function(e,t){const s=e.getSource().getParent();const i=e.getSource().getParent().getContent()[0];s.setBusy(true);const r=this.getModel("NewMedicalHistory").getData();const a=this.getModel("MainData").getProperty("/MovementData");if(r.Date)r.Date.setHours(8);const o={MedHistid:"99999999-9999-9999-9999-999999999999",Einri:this.headers.Institution,Patnr:this.headers.Patient,Bchid:r.Antecedent.BchidChild,Bcpid:r.Antecedent.BcpidChild,Remarks:r.Comments,RemarksInt:r.Observations,Treatment:r.Medication,DateMedHist:r.Date,RespEmp:"",Departmentou:a.Orgfa,Treatou:a.Orgpf,Erusr:"",Erdat:new Date,Ertim:"PT00H00M00S",Upusr:"",Updat:null,Uptim:"PT00H00M00S",Storn:false,Stusr:"",Stdat:null,Sttim:"PT00H00M00S"};this.getModel("ZISH_HCFI_SRV").create("/MedicalHistorySet",o,{success:function(){i.discardProgress(i.getSteps()[0]);i.getSteps()[0].getContent()[1].collapseAll();this.getMedicalDataOverview();s.setBusy(false);this.getModel("NewMedicalHistory").setProperty("/",{Antecedent:{},Date:null,Medication:"",Comments:"",Observations:""});this.byId("dateMedicalAntecedents").setDateValue();if(!t){s.close()}}.bind(this),error:function(e){s.setBusy(false);try{this.displayOdataError("MedicalHistorySet",JSON.parse(e.responseText).error.message.value)}catch{this.displayOdataError("MedicalHistorySet",e.message)}}.bind(this)})},onSurgicalAntecedentsSelect:function(e){const t=e.getSource().getParent().getParent();const s=e.getParameter("listItem");const i=s.getBindingContext("AntecedentFiltered").getObject();const r=s.getBindingContext("AntecedentFiltered").getPath().split("/").map(e=>parseInt(e)).filter(Number.isInteger).reduce((e,t)=>e+1+t,-1);s.setSelected(false);if(i.IsSelectable){if(i.ExtidChild=="Otros")this.getModel("NewSurgeryHistory").setProperty("/Comments",this.byId("SearchSurgicalAntecedents").getValue());t.setCurrentStep(t.getSteps()[0]).nextStep();this.getModel("NewSurgeryHistory").setProperty("/Antecedent",i)}else s.getExpanded()?e.getSource().collapse(r):e.getSource().expand(r)},onSurgicalAntecedentsDateChange:function(e){this.getModel("NewSurgeryHistory").setProperty("/Date",e.getSource().getProperty("dateValue"))},onSaveAddSurgicalAntecedentsDialog:function(e,t){const s=e.getSource().getParent();const i=e.getSource().getParent().getContent()[0];s.setBusy(true);const r=this.getModel("NewSurgeryHistory").getData();const a=this.getModel("MainData").getProperty("/MovementData");if(r.Date)r.Date.setHours(8);const o={SurgHistid:"99999999-9999-9999-9999-999999999999",Einri:this.headers.Institution,Patnr:this.headers.Patient,Bchid:r.Antecedent.BchidChild,Bcpid:r.Antecedent.BcpidChild,Remarks:r.Comments,RemarksInt:r.Observations,DateSurg:r.Date,RespEmp:"",Departmentou:a.Orgfa,Treatou:a.Orgpf,Erusr:"",Erdat:new Date,Ertim:"PT00H00M00S",Upusr:"",Updat:null,Uptim:"PT00H00M00S",Storn:false,Stusr:"",Stdat:null,Sttim:"PT00H00M00S"};this.getModel("ZISH_HCFI_SRV").create("/SurgeryHistorySet",o,{success:function(){i.discardProgress(i.getSteps()[0]);i.getSteps()[0].getContent()[1].collapseAll();this.getMedicalDataOverview();s.setBusy(false);this.getModel("NewSurgeryHistory").setProperty("/",{Antecedent:{},Date:null,Comments:"",Observations:""});this.byId("dateSurginalAntecedents").setDateValue();if(!t){s.close()}}.bind(this),error:function(e){s.setBusy(false);try{this.displayOdataError("SurgeryHistorySet",JSON.parse(e.responseText).error.message.value)}catch{this.displayOdataError("SurgeryHistorySet",e.message)}}.bind(this)})},ClearFamilyAntecedents:function(e){this.getModel("NewFamilyHistory").setData({});this.closeAddAllergiesDialog(e);this.byId("familyAntecedentsSearchField").setValue("")},ClearMedicalAntecedents:function(e){this.getModel("NewMedicalHistory").setData({});this.byId("SearchMedicalAntecedents").setValue("");this.closeAddAllergiesDialog(e)},ClearSurgicalAntecedents:function(e){this.getModel("NewSurgeryHistory").setData({});this.byId("SearchSurgicalAntecedents").setValue("");this.closeAddAllergiesDialog(e)},ClearSocialAntecedents:function(e){this.getModel("NewHabit").setData({});this.byId("SearchSocialHabits").setValue("");this.closeAddAllergiesDialog(e)},onZMEDMB_HAB_EVALChange:function(e){this.getModel("NewHabit").setProperty("/ZMEDMB_HAB_EVAL",e.getParameter("selectedItem").getBindingContext("KeyValue").getObject())},onZMEDMB_FREQChange:function(e){this.getModel("NewHabit").setProperty("/ZMEDMB_FREQ",e.getParameter("selectedItem").getBindingContext("KeyValue").getObject())},onZMEDMB_TOBACCOChange:function(e){this.getModel("NewHabit").setProperty("/ZMEDMB_TOBACCO",e.getParameter("selectedItem").getBindingContext("KeyValue").getObject())},onZMEDMB_FREQ_UNITChange:function(e){this.getModel("NewHabit").setProperty("/ZMEDMB_FREQ_UNIT",e.getParameter("selectedItem").getBindingContext("KeyValue").getObject())},onZMEDMB_FREQ_CONDChange:function(e){this.getModel("NewHabit").setProperty("/ZMEDMB_FREQ_COND",e.getParameter("selectedItem").getBindingContext("KeyValue").getObject())},onSocialHabitsSelect:function(e){const t=e.getSource().getParent().getParent();const s=e.getParameter("listItem");const i=s.getBindingContext("AntecedentFiltered").getObject();const r=s.getBindingContext("AntecedentFiltered").getPath().split("/").map(e=>parseInt(e)).filter(Number.isInteger).reduce((e,t)=>e+1+t,-1);s.setSelected(false);if(i.IsSelectable){t.setCurrentStep(t.getSteps()[0]).nextStep();this.getModel("NewHabit").setProperty("/Antecedent",i)}else s.getExpanded()?e.getSource().collapse(r):e.getSource().expand(r)},onSaveAddSocialHabitsDialog:function(e,t){const s=this.getModel("NewHabit").getData();if(!s.From&&this.getModel("NewHabit").getData().ZMEDMB_HAB_EVAL.KeyValue==="2")this.displayOdataError(this.getModel("i18n").getProperty("RequiredField"),this.getModel("i18n").getProperty("NewHabitRequiredField"));else{const i=e.getSource().getParent();const r=e.getSource().getParent().getContent()[0];i.setBusy(true);const a={Habitid:"99999999-9999-9999-9999-999999999999",Frequency:s.ZMEDMB_FREQ.KeyValue,FrequencyUnit:s.ZMEDMB_FREQ_UNIT.KeyValue,Evaluation:s.ZMEDMB_HAB_EVAL.KeyValue,TobaccoType:s.ZMEDMB_TOBACCO.KeyValue,FrequencyCond:s.ZMEDMB_FREQ_COND.KeyValue,From:s.From,To:s.To,OtherTypeText:s.OtherTypeText,Type:"",Status:"",Quantity:s.GrWeek,HabitOrder:"",Patient:this.headers.Patient,Comment:s.Comments,Bchid:s.Antecedent.BchidChild,Bcpid:s.Antecedent.BcpidChild,Institution:this.headers.Institution,Case:this.headers.Case};this.getModel("ZISH_HCFI_SRV").create("/HabitSet",a,{success:function(){r.discardProgress(r.getSteps()[0]);r.getSteps()[0].getContent()[1].collapseAll();this.getMedicalDataOverview();i.setBusy(false);this.getModel("NewHabit").setProperty("/",{Antecedent:{},ZMEDMB_HAB_EVAL:{},From:"",To:"",ZMEDMB_FREQ:{},ZMEDMB_TOBACCO:{},ZMEDMB_FREQ_UNIT:{},ZMEDMB_FREQ_COND:{},GrWeek:"",Comments:""});this.byId("ZMEDMB_HAB_EVAL").setSelectedKey("0");if(!t){i.close()}}.bind(this),error:function(e){i.setBusy(false);try{this.displayOdataError("HabitSet",JSON.parse(e.responseText).error.message.value)}catch{this.displayOdataError("HabitSet",e.message)}}.bind(this)})}},onEditMedicalAntecedents:function(e){let t=e.getSource();if(!this.editAnt_Allergies){this.editAnt_Allergies=new sap.m.Dialog({type:sap.m.DialogType.Message,title:this.getModel("i18n").getProperty("Confirm"),content:new sap.m.Text({text:this.getModel("i18n").getProperty("ConfirmSave")}),beginButton:new sap.m.Button({type:sap.m.ButtonType.Emphasized,text:this.getModel("i18n").getProperty("Confirm"),press:function(){this.editAnt_Allergies.close();this.onUpdateMedicalAntecedents(t)}.bind(this)}),endButton:new sap.m.Button({text:this.getModel("i18n").getProperty("Cancel"),press:function(){this.editAnt_Allergies.close()}.bind(this)})})}this.editAnt_Allergies.open()},onDeleteMedicalAntecedents:function(e){let t=e.getSource();if(!this.confirmMedicalAntecedentsDialog){this.confirmMedicalAntecedentsDialog=new sap.m.Dialog({type:sap.m.DialogType.Message,title:this.getModel("i18n").getProperty("Eliminate"),content:new sap.m.Text({text:this.getModel("i18n").getProperty("ConfirmDelete")}),beginButton:new sap.m.Button({type:sap.m.ButtonType.Emphasized,text:this.getModel("i18n").getProperty("Confirm"),press:function(){this.confirmMedicalAntecedentsDialog.close();this.deleteMedicalAntecedents(t)}.bind(this)}),endButton:new sap.m.Button({text:this.getModel("i18n").getProperty("Cancel"),press:function(){this.confirmMedicalAntecedentsDialog.close()}.bind(this)})})}this.confirmMedicalAntecedentsDialog.open()},deleteMedicalAntecedents:function(e){let t=this.getModel("NewMedicalHistory").getData();this.getModel("ZISH_HCFI_SRV").remove("/MedicalHistorySet(guid'"+t.MedHistguid+"')",{success:function(){this.getMedicalDataOverview();e.getParent().close()}.bind(this),error:function(e){try{this.displayOdataError("DeleteMedicalAntecedents",JSON.parse(e.responseText).error.message.value)}catch{this.displayOdataError("DeleteMedicalAntecedents",e.message)}}.bind(this)})},onEditFamilyAntecedents:function(e){let t=e.getSource();if(!this.confirmEditFamilyAntecedent){this.confirmEditFamilyAntecedent=new sap.m.Dialog({type:sap.m.DialogType.Message,title:this.getModel("i18n").getProperty("Confirm"),content:new sap.m.Text({text:this.getModel("i18n").getProperty("ConfirmSave")}),beginButton:new sap.m.Button({type:sap.m.ButtonType.Emphasized,text:this.getModel("i18n").getProperty("Confirm"),press:function(){this.confirmEditFamilyAntecedent.close();this.onUpdateFamilyAntecedents(t)}.bind(this)}),endButton:new sap.m.Button({text:this.getModel("i18n").getProperty("Cancel"),press:function(){this.confirmEditFamilyAntecedent.close()}.bind(this)})})}this.confirmEditFamilyAntecedent.open()},onDeleteFamilyAntecedents:function(e){let t=e.getSource();if(!this.confirmDeleteFamilyAntecedents){this.confirmDeleteFamilyAntecedents=new sap.m.Dialog({type:sap.m.DialogType.Message,title:this.getModel("i18n").getProperty("Eliminate"),content:new sap.m.Text({text:this.getModel("i18n").getProperty("ConfirmDelete")}),beginButton:new sap.m.Button({type:sap.m.ButtonType.Emphasized,text:this.getModel("i18n").getProperty("Confirm"),press:function(){this.confirmDeleteFamilyAntecedents.close();this.deleteFamilyAntecedents(t)}.bind(this)}),endButton:new sap.m.Button({text:this.getModel("i18n").getProperty("Cancel"),press:function(){this.confirmDeleteFamilyAntecedents.close()}.bind(this)})})}this.confirmDeleteFamilyAntecedents.open()},deleteFamilyAntecedents:function(e){let t=this.getModel("NewFamilyHistory").getData();this.getModel("ZISH_HCFI_SRV").remove("/FamilyHistorySet(guid'"+t.FamilyHistguid+"')",{success:function(){this.getMedicalDataOverview();e.getParent().close()}.bind(this),error:function(e){try{this.displayOdataError("DeleteFamilyAntecedents",JSON.parse(e.responseText).error.message.value)}catch{this.displayOdataError("DeleteFamilyAntecedents",e.message)}}.bind(this)})},onEditSocialHabits:function(e){let t=e.getSource();if(!this.editSocialHabits){this.editSocialHabits=new sap.m.Dialog({type:sap.m.DialogType.Message,title:this.getModel("i18n").getProperty("Confirm"),content:new sap.m.Text({text:this.getModel("i18n").getProperty("ConfirmSave")}),beginButton:new sap.m.Button({type:sap.m.ButtonType.Emphasized,text:this.getModel("i18n").getProperty("Confirm"),press:function(){this.editSocialHabits.close();this.onUpdateSocialHabits(t)}.bind(this)}),endButton:new sap.m.Button({text:this.getModel("i18n").getProperty("Cancel"),press:function(){this.editSocialHabits.close()}.bind(this)})})}this.editSocialHabits.open()},onDeleteSocialHabits:function(e){let t=e.getSource();if(!this.confirmDeleteSocialHabits){this.confirmDeleteSocialHabits=new sap.m.Dialog({type:sap.m.DialogType.Message,title:this.getModel("i18n").getProperty("Eliminate"),content:new sap.m.Text({text:this.getModel("i18n").getProperty("ConfirmDelete")}),beginButton:new sap.m.Button({type:sap.m.ButtonType.Emphasized,text:this.getModel("i18n").getProperty("Confirm"),press:function(){this.confirmDeleteSocialHabits.close();this.deleteSocialHabits(t)}.bind(this)}),endButton:new sap.m.Button({text:this.getModel("i18n").getProperty("Cancel"),press:function(){this.confirmDeleteSocialHabits.close()}.bind(this)})})}this.confirmDeleteSocialHabits.open()},deleteSocialHabits:function(e){let t=this.getModel("NewHabit").getData();var s=this.getModel("Antecedent").getProperty("/ZSHA").find(e=>e.ExtidChild==t.Type).BcpidChild;this.getModel("ZISH_HCFI_SRV").remove("/HabitSet(Habitid=guid'"+t.Habitid+"',Bcpid='"+s+"')",{success:function(){e.getParent().close();this.getMedicalDataOverview()}.bind(this),error:function(e){try{this.displayOdataError("DeleteSocialHabits",JSON.parse(e.responseText).error.message.value)}catch{this.displayOdataError("DeleteSocialHabits",e.message)}}.bind(this)})},onEditSurgicalAntecedents:function(e){let t=e.getSource();if(!this.confirmEditSurgicalAntecedents){this.confirmEditSurgicalAntecedents=new sap.m.Dialog({type:sap.m.DialogType.Message,title:this.getModel("i18n").getProperty("Confirm"),content:new sap.m.Text({text:this.getModel("i18n").getProperty("ConfirmSave")}),beginButton:new sap.m.Button({type:sap.m.ButtonType.Emphasized,text:this.getModel("i18n").getProperty("Confirm"),press:function(){this.confirmEditSurgicalAntecedents.close();t.getParent().close();this.onUpdateSurgicalAntecedents(t)}.bind(this)}),endButton:new sap.m.Button({text:this.getModel("i18n").getProperty("Cancel"),press:function(){this.confirmEditSurgicalAntecedents.close()}.bind(this)})})}this.confirmEditSurgicalAntecedents.open()},onDeleteSurgicalAntecedent:function(e){let t=e.getSource();if(!this.confirmDeleteSurgicalAntecedent){this.confirmDeleteSurgicalAntecedent=new sap.m.Dialog({type:sap.m.DialogType.Message,title:this.getModel("i18n").getProperty("Eliminate"),content:new sap.m.Text({text:this.getModel("i18n").getProperty("ConfirmDelete")}),beginButton:new sap.m.Button({type:sap.m.ButtonType.Emphasized,text:this.getModel("i18n").getProperty("Confirm"),press:function(){this.confirmDeleteSurgicalAntecedent.close();t.getParent().close();this.deleteSurgicalAntecedents(t)}.bind(this)}),endButton:new sap.m.Button({text:this.getModel("i18n").getProperty("Cancel"),press:function(){this.confirmDeleteSurgicalAntecedent.close()}.bind(this)})})}this.confirmDeleteSurgicalAntecedent.open()},deleteSurgicalAntecedents:function(e){let t=this.getModel("NewSurgeryHistory").getData();this.getModel("ZISH_HCFI_SRV").remove("/SurgeryHistorySet(guid'"+t.SurgHistguid+"')",{success:function(){e.getParent().close();this.getMedicalDataOverview()}.bind(this),error:function(e){try{this.displayOdataError("DeleteAnt_Allergies",JSON.parse(e.responseText).error.message.value)}catch{this.displayOdataError("DeleteAnt_Allergies",e.message)}}.bind(this)})},onDeleteRiskFactors:function(e){let t=e.getSource();if(!this.deleteRiskFactor){this.deleteRiskFactor=new sap.m.Dialog({type:sap.m.DialogType.Message,title:this.getModel("i18n").getProperty("Eliminate"),content:new sap.m.Text({text:this.getModel("i18n").getProperty("ConfirmDelete")}),beginButton:new sap.m.Button({type:sap.m.ButtonType.Emphasized,text:this.getModel("i18n").getProperty("Confirm"),press:function(){this.deleteRiskFactor.close();this.deleteRiskFactors(t)}.bind(this)}),endButton:new sap.m.Button({text:this.getModel("i18n").getProperty("Cancel"),press:function(){this.deleteRiskFactor.close()}.bind(this)})})}this.deleteRiskFactor.open()},deleteRiskFactors:function(e){let t=this.getModel("RiskFactorFiltered").getData();this.getModel("ZISH_HCFI_SRV").callFunction("/DeleteRiskFactors",{urlParameters:{Institution:this.headers.Institution,Patient:t.Patnr,RiskFactors:t.Rsfnr},success:function(){e.getParent().close();this.getMedicalDataOverview()}.bind(this),error:function(e){try{this.displayOdataError("DeleteRiskFactors",JSON.parse(e.responseText).error.message.value)}catch{this.displayOdataError("DeleteRiskFactors",e.message)}}.bind(this)})},onEditAllergies:function(e){let t=e.getSource();if(!this.confirmEditAllergies){this.confirmEditAllergies=new sap.m.Dialog({type:sap.m.DialogType.Message,title:this.getModel("i18n").getProperty("Confirm"),content:new sap.m.Text({text:this.getModel("i18n").getProperty("ConfirmSave")}),beginButton:new sap.m.Button({type:sap.m.ButtonType.Emphasized,text:this.getModel("i18n").getProperty("Confirm"),press:function(){this.confirmEditAllergies.close();this.onUpdateAllergies(t)}.bind(this)}),endButton:new sap.m.Button({text:this.getModel("i18n").getProperty("Cancel"),press:function(){this.confirmEditAllergies.close()}.bind(this)})})}this.confirmEditAllergies.open()},onDeleteAllergies:function(e){let t=e.getSource();if(!this.deleteConfirmationDialog){this.deleteConfirmationDialog=new sap.m.Dialog({type:sap.m.DialogType.Message,title:this.getModel("i18n").getProperty("Eliminate"),content:new sap.m.Text({text:this.getModel("i18n").getProperty("ConfirmDelete")}),beginButton:new sap.m.Button({type:sap.m.ButtonType.Emphasized,text:this.getModel("i18n").getProperty("Confirm"),press:function(){this.deleteConfirmationDialog.close();this.deleteAllergies(t)}.bind(this)}),endButton:new sap.m.Button({text:this.getModel("i18n").getProperty("Cancel"),press:function(){this.deleteConfirmationDialog.close()}.bind(this)})})}this.deleteConfirmationDialog.open()},deleteAllergies:function(e){let t=this.getModel("NewAllergy").getData();this.getModel("ZISH_HCFI_SRV").remove("/AllergySet(Patnr='"+t.Patnr+"',AllergySeqno='"+t.AllergySeqno+"')",{success:function(){this.getMedicalDataOverview();e.getParent().close()}.bind(this),error:function(e){try{this.displayOdataError("DeleteAnt_Allergies",JSON.parse(e.responseText).error.message.value)}catch{this.displayOdataError("DeleteAnt_Allergies",e.message)}}.bind(this)})},onRelatedCaseSelection:function(e){if(e.getParameters().listItem.getBindingContext("ProcessCases").getObject().Falnr!=this.getModel("MainData").getData().CaseData.Falnr){let t=e.getParameters().listItem.getBindingContext("ProcessCases").getObject();e.getSource().getParent().close();location.hash=`#?Institution=${t.Einri}&Case=${t.Falnr}&Movement=${t.Lfdnr||"00001"}&Patient=${this.headers.Patient}`;location.reload()}},bringDocument:function(e,t){const s=e.getSource();this._oRelatedDocsPopover?this._oRelatedDocsPopover.openBy(s):this.loadFragment({type:"XML",name:"com.resulto.hcfi.view.RelatedDocumentsPopover"}).then(function(e){this._oRelatedDocsPopover=e;e.openBy(s)}.bind(this))},onRelatedDocSelection:function(e){this.selectedDoc={...e.getParameters().listItem.getBindingContext("FilteredDocuments").getObject()};let t=e.getSource();if(!this.oApproveDialog){this.oApproveDialog=new sap.m.Dialog({type:sap.m.DialogType.Message,title:"Importar datos",content:new sap.m.Text({text:"Confirma que  se deben importar los datos del documento seleccionado?"}),beginButton:new sap.m.Button({type:sap.m.ButtonType.Emphasized,text:"Confirmar",press:function(){this.getRelatedDocument(this.selectedDoc.RN2DOCDATA);this.oApproveDialog.close();t.getParent().close()}.bind(this)}),endButton:new sap.m.Button({text:"Cancelar",press:function(){this.oApproveDialog.close()}.bind(this)})})}this.oApproveDialog.open()},getRelatedDocument:function(e){this.getModel("ZISH_HCFI_SRV").read(`/DocumentSet(Dokar='${e.Dokar}',Doknr='${e.Doknr}',Dokvr='${e.Dokvr}',Doktl='${e.Doktl}')`,{urlParameters:{$expand:"content"},success:function(e){let t=this.getModel("MainData").getData();e.Einri=t.MovementData.Einri;e.Falnr=t.MovementData.Falnr;e.Orgdo=t.MovementData.Orgpf;e.Mitarb=this.getModel("ProfessionalData").getProperty("/Id");e.Doknr="9999999999999999999999999";e.Dokst="";e.Dokvr="00";this.getModel(e.Dtid).setProperty("/",e);this.getModel(e.Dtid).setProperty("/content",this.groupBy(e.content.results,"Alias"));this.createAntecedentsTab(e.Dtid,e.content);this.createVitalSignsExamTab(e.Dtid,e.content);this.createServicesTab(e.Dtid,e.content);this.createDiagnosesProceduresTab(e.Dtid,e.content);this.createDischargeTab(e.Dtid,e.content);this.createCAD_GINEView(e.Dtid,e.content);this.createCAD_MAMView(e.Dtid,e.content);this.byId(e.Dtid).getContent()[0].setBusy(false).getHeaderTitle().getActions().forEach(e=>{e.setEnabled(true)});try{this.byId(e.ReleaseDocument.Dtid).getContent()[1].setBusy(false)}catch{}}.bind(this),error:function(e){try{this.displayOdataError("DocumentSet",JSON.parse(e.responseText).error.message.value)}catch{this.displayOdataError("DocumentSet",e.message)}}.bind(this)})},onPopoverClose:function(e){this.getView().getModel("FilteredDocuments").setData({})},onPopoverOpen:function(e){let t=this.getView().getModel("Documents").oData.results.filter(e=>e.RN2DOCDATA.Dtid==this.byId("IconTabBar").getSelectedKey());this.getView().setModel(new c,"FilteredDocuments");this.getView().getModel("FilteredDocuments").setProperty("/results",t)},onPARTORECALPressed:function(e){let t=this.getModel("KeyValue").getProperty(`/${e}/0/KeyText`);if(t)this.getModel("CAD_CTREMB").setProperty("/content/PARTORECAL/Value",t)},onBirthsTemplatePress:function(e){let t=e.getParameter("selected");this.getModel("CAD_CTREMB").setProperty(`/content/PARTOPLGEN/Value`,t?"X":"");let s=this.getView().getModel("i18n").getResourceBundle();var i="";if(t){let e=this.getModel("CAD_CTREMB").getProperty("/Births");let t=this.getModel("CAD_CTREMB").getProperty("/content/PARTOEPISI/Value");let r=this.getModel("CAD_CTREMB").getProperty("/content/PARTODESGR/Value");let a=this.getModel("KeyValue").getProperty("/PARTODESGR").find(e=>e.KeyValue==r)?.KeyText||r;let o=this.getModel("CAD_CTREMB").getProperty("/content/LIGADURA_T/Value");let n=this.getModel("CAD_CTREMB").getProperty("/content/PARTOTSANG/Value");let l=this.getModel("CAD_CTREMB").getProperty("/content/BANCOSANGR/Value");let d=this.getModel("KeyValue").getProperty("/BANCOSANGR").find(e=>e.KeyValue==l)?.KeyText||l;e.forEach(e=>{let t=this.getModel("KeyValue").getProperty("/PARTOTIPO").find(t=>t.KeyValue==e.X00TOTIPO)?.KeyText||e.X00TOTIPO;let r=this.getModel("KeyValue").getProperty("/PARTOCESAR").find(t=>t.KeyValue==e.X00TOCESAR)?.KeyText||e.X00TOCESAR;let a=this.getModel("KeyValue").getProperty("/NACSEXO").find(t=>t.KeyValue==e.NACSEXO)?.KeyText||e.NACSEXO;let o=this.getModel("KeyValue").getProperty("/DECESO").find(t=>t.KeyValue==e.DECESO)?.KeyText||e.DECESO;let n=this.getModel("KeyValue").getProperty("/ALUMBRA").find(t=>t.KeyValue==e.ALUMBRA)?.KeyText||e.ALUMBRA;let l=this.getModel("KeyValue").getProperty("/CORDON").find(t=>t.KeyValue==e.CORDON)?.KeyText||e.CORDON;i=`${i}${s.getText("template10a")} ${e.X00TOFECHA}`;i=`${i} ${s.getText("template10b")} ${e.X00TOHORA} ${s.getText("template10c")}`;if(e.X00TOTIPO!=""){i=`${i} ${s.getText("template10c1")} ${t}.`}else if(e.X00TOCESAR!=""){i=`${i} ${s.getText("template10c2")} ${r}.`}i=`${i} ${s.getText("template10d")} ${o} ${s.getText("template10d2")} ${a}`;i=`${i} ${s.getText("template10e")} ${parseFloat(e.NACPESO)} ${s.getText("template10f")} ${e.APGAR}.`;if(e.ALUMBRA==="03"){i=`${i} ${n}.`}else{i=`${i} ${s.getText("template10g")} ${n}.`}i=`${i} ${s.getText("template10h")} ${l}.`;i=`${i} ${s.getText("template10i")} ${parseFloat(e.PH)}.`;i=`${i}\n\n`});if(t==""&&r=="")i=`${i}${s.getText("template20")}`;if(t=="X"&&r=="")i=`${i}${s.getText("template21")}`;if(t=="X"&&r!="")i=`${i}${s.getText("template22a")} ${a} ${s.getText("template22b")}`;if(t==""&&r!="")i=`${i}${s.getText("template23a")} ${a} ${s.getText("template23b")}`;if(n=="X")i=`${i} ${s.getText("template24")} ${d}.`;if(o=="X")i=`${i} ${s.getText("template25")}`;i=`${i} ${s.getText("template26")}`}this.getModel("CAD_CTREMB").setProperty("/content/PARTOPL/Value",i)},onDischargeButtonPress:function(e,t){var s=this.getModel(t).getProperty("/content/MOV_FDISFL/Value")==="X";if(!s){this.getModel(t).setProperty("/content/MOV_FDISFL/Value","X");var i=new Date,r=""+(i.getMonth()+1).toString().padStart(2,0),a=""+i.getDate().toString().padStart(2,0),o=i.getFullYear(),n=i.getHours().toString().padStart(2,0),l=i.getMinutes().toString().padStart(2,0),d=i.getSeconds().toString().padStart(2,0);this.getModel(t).setProperty("/content/MOV_FDATDI/Value",`${a}.${r}.${o}`);this.getModel(t).setProperty("/content/MOV_FTIMDI/Value",`${n}:${l}`);if(t=="CAD_AE"){const e=this.byId("CAD_AE").getContent()[0];this.byId("container-hcfi---Main--cadae--rMOV_FDTYPE").setSelectedIndex(9);this.getModel(t).setProperty("/content/MOV_FDTYPE/Value",this.byId("container-hcfi---Main--cadae--rMOV_FDTYPE").getSelectedButton().getBindingContext("KeyValue").getObject().KeyValue);this.byId("container-hcfi---Main--cadae--rMOV_FSTYDA").setSelectedIndex(0);this.getModel(t).setProperty("/content/MOV_FSTYDA/Value",this.byId("container-hcfi---Main--cadae--rMOV_FSTYDA").getSelectedButton().getBindingContext("KeyValue").getObject().KeyValue);this.byId("container-hcfi---Main--cadae--rMOV_FTRADC").setSelectedIndex(0);this.getModel(t).setProperty("/content/MOV_FTRADC/Value",this.byId("container-hcfi---Main--cadae--rMOV_FTRADC").getSelectedButton().getBindingContext("KeyValue").getObject().KeyValue)}}else{this.getModel(t).setProperty("/content/MOV_FDISFL/Value","");this.getModel(t).setProperty("/content/MOV_FDATDI/Value","");this.getModel(t).setProperty("/content/MOV_FTIMDI/Value","");this.getModel(t).setProperty("/content/MOV_FDTYPE/Value","");this.getModel(t).setProperty("/content/MOV_CSTRAS/Value","");this.getModel(t).setProperty("/content/MOV_FSTYDA/Value","");this.getModel(t).setProperty("/content/MOV_FTRADI/Value","");this.getModel(t).setProperty("/content/MOV_FTRADC/Value","");this.getModel(t).setProperty("/content/MOV_FREADI/Value","");if(t=="CAD_AE"){this.getModel(t).setProperty("/content/MOV_UO/Value","");this.byId("container-hcfi---Main--cadae--labelSpeciality").setProperty("visible",false);this.byId("container-hcfi---Main--cadae--selectSpecialty").setProperty("visible",false);this.byId("container-hcfi---Main--cadae--selectSpecialty").setSelectedKey(this.getModel(t).getProperty("/content/MOV_UO/Value"))}}},DisChargeUrgeRadioButtom:function(e){var t=this.byId(e.mParameters.id).getSelectedButton().getBindingContext("KeyValue").getObject();if(t.KeyValue=="02"&&t.Field=="MOV_FDTYPE"){var s=this.byId(e.mParameters.id.substring(0,30)+"rMOV_FSTYDA").aRBs.find(e=>e.getBindingContext("KeyValue").getObject().KeyValue=="08"&&e.getBindingContext("KeyValue").getObject().Field=="MOV_FSTYDA");if(s.sId.length==54){s.getParent().setSelectedIndex(parseInt(s.sId.substring(s.sId.length-1,s.sId.length)))}else{s.getParent().setSelectedIndex(parseInt(s.sId.substring(s.sId.length-2,s.sId.length)))}this.getModel("CAD_AE").setProperty("/content/MOV_FSTYDA/Value",s.getBindingContext("KeyValue").getObject().KeyValue);var i=this.byId(e.mParameters.id.substring(0,30)+"rMOV_CSTRAS").aRBs.find(e=>e.getBindingContext("KeyValue").getObject().KeyValue=="OTR"&&e.getBindingContext("KeyValue").getObject().Field=="MOV_CSTRAS");if(i.sId.length==54){i.getParent().setSelectedIndex(parseInt(i.sId.substring(i.sId.length-1,i.sId.length)))}else{i.getParent().setSelectedIndex(parseInt(i.sId.substring(i.sId.length-2,i.sId.length)))}this.getModel("CAD_AE").setProperty("/content/MOV_CSTRAS/Value",i.getBindingContext("KeyValue").getObject().KeyValue)}if(t.KeyValue=="10"&&t.Field=="MOV_FDTYPE"){var r=this.byId(e.mParameters.id.substring(0,30)+"rMOV_FSTYDA").aRBs.find(e=>e.getBindingContext("KeyValue").getObject().KeyValue=="02"&&e.getBindingContext("KeyValue").getObject().Field=="MOV_FSTYDA");if(r.sId.length==54){r.getParent().setSelectedIndex(parseInt(r.sId.substring(r.sId.length-1,r.sId.length)))}else{r.getParent().setSelectedIndex(parseInt(r.sId.substring(r.sId.length-2,r.sId.length)))}this.getModel("CAD_AE").setProperty("/content/MOV_FSTYDA/Value",r.getBindingContext("KeyValue").getObject().KeyValue)}if(t.KeyValue=="99"&&t.Field=="MOV_FDTYPE"){var r=this.byId(e.mParameters.id.substring(0,30)+"rMOV_FDTYPE").aRBs.find(e=>e.getBindingContext("KeyValue").getObject().KeyValue=="99"&&e.getBindingContext("KeyValue").getObject().Field=="MOV_FDTYPE");this.getModel("CAD_AE").setProperty("/content/MOV_FDTYPE/Value",r.getBindingContext("KeyValue").getObject().KeyValue)}if(t.KeyValue=="05"&&t.Field=="MOV_FDTYPE"){var r=this.byId(e.mParameters.id.substring(0,30)+"rMOV_CSTRAS").aRBs.find(e=>e.getBindingContext("KeyValue").getObject().KeyValue=="OTR"&&e.getBindingContext("KeyValue").getObject().Field=="MOV_CSTRAS");if(r.sId.length==54){r.getParent().setSelectedIndex(parseInt(r.sId.substring(r.sId.length-1,r.sId.length)))}else{r.getParent().setSelectedIndex(parseInt(r.sId.substring(r.sId.length-2,r.sId.length)))}this.getModel("CAD_AE").setProperty("/content/MOV_CSTRAS/Value",r.getBindingContext("KeyValue").getObject().KeyValue)}if(t.KeyValue!="02"&&t.Field=="MOV_FDTYPE"){this.byId("container-hcfi---Main--cadae--rMOV_CSTRAS").setSelectedIndex(-1);this.getModel("CAD_AE").setProperty("/content/MOV_CSTRAS/Value","")}this.activateSpecialtyVisibility();this.getModel("CAD_AE").setProperty("/content/"+t.Field+"/Value",t.KeyValue)},activateSpecialtyVisibility:function(){if(this.byId("container-hcfi---Main--cadae--rMOV_FDTYPE").getSelectedButton().getBindingContext("KeyValue").getObject().KeyValue=="01"&&this.byId("container-hcfi---Main--cadae--rMOV_FSTYDA").getSelectedButton().getBindingContext("KeyValue").getObject().KeyValue=="10"){this.byId("container-hcfi---Main--cadae--labelSpeciality").setProperty("visible",true);this.byId("container-hcfi---Main--cadae--selectSpecialty").setProperty("visible",true)}else{this.getModel("CAD_AE").setProperty("/content/MOV_UO/Value","");this.byId("container-hcfi---Main--cadae--labelSpeciality").setProperty("visible",false);this.byId("container-hcfi---Main--cadae--selectSpecialty").setProperty("visible",false);this.byId("container-hcfi---Main--cadae--selectSpecialty").setSelectedKey(this.getModel("CAD_AE").getProperty("/content/MOV_UO/Value"))}},setRadioButtomSelectedIndex:function(){var e=this.byId("container-hcfi---Main--cadae--rMOV_FDTYPE").aRBs.find(e=>e.getBindingContext("KeyValue").getObject().KeyValue==this.getModel("CAD_AE").getProperty("/content/MOV_FDTYPE/Value"));if(e)if(e.sId.length==54){e.getParent().setSelectedIndex(parseInt(e.sId.substring(e.sId.length-1,e.sId.length)))}else{const t=this.byId("CAD_AE").getContent()[0];if(t.getHeaderTitle().getExpandedContent()[0].getText()==this.getModel("i18n").getProperty("New")){e.getParent().setSelectedIndex(9)}else{e.getParent().setSelectedIndex(parseInt(e.sId.substring(e.sId.length-2,e.sId.length)))}}var t=this.byId("container-hcfi---Main--cadae--rMOV_CSTRAS").aRBs.find(e=>e.getBindingContext("KeyValue").getObject().KeyValue==this.getModel("CAD_AE").getProperty("/content/MOV_CSTRAS/Value"));if(t!=""&&t)if(t.sId.length==54){t.getParent().setSelectedIndex(parseInt(t.sId.substring(t.sId.length-1,t.sId.length)))}else{t.getParent().setSelectedIndex(parseInt(t.sId.substring(t.sId.length-2,t.sId.length)))}var s=this.byId("container-hcfi---Main--cadae--rMOV_FSTYDA").aRBs.find(e=>e.getBindingContext("KeyValue").getObject().KeyValue==this.getModel("CAD_AE").getProperty("/content/MOV_FSTYDA/Value")&&e.getBindingContext("KeyValue").getObject().KeyValue!="");if(s)if(s.sId.length==54){s.getParent().setSelectedIndex(parseInt(s.sId.substring(s.sId.length-1,s.sId.length)))}else{s.getParent().setSelectedIndex(parseInt(s.sId.substring(s.sId.length-2,s.sId.length)))}var i=this.byId("container-hcfi---Main--cadae--rMOV_FTRADC").aRBs.find(e=>e.getBindingContext("KeyValue").getObject().KeyValue==this.getModel("CAD_AE").getProperty("/content/MOV_FTRADC/Value")&&e.getBindingContext("KeyValue").getObject().KeyValue!="");if(i)if(i.sId.length==54){i.getParent().setSelectedIndex(parseInt(i.sId.substring(i.sId.length-1,i.sId.length)))}else{i.getParent().setSelectedIndex(parseInt(i.sId.substring(i.sId.length-2,i.sId.length)))}this.byId("container-hcfi---Main--cadae--selectSpecialty").setSelectedKey(this.getModel("CAD_AE").getProperty("/content/MOV_UO/Value"));this.activateSpecialtyVisibility()},setSpecialty:function(e){this.getModel("CAD_AE").setProperty("/content/MOV_UO/Value",e.getParameter("selectedItem").getKey())},updateSexT3:function(e){let t=this.getModel("CAD_CTREMB").getProperty("/SexT2");var s=this.getModel("CAD_CTREMB").getProperty("/SexT3");s.forEach((e,s)=>{e["X00_SEXO"]=t[s]["EMB_SEXO"]})},onChangePARTOFECHA:function(e){const t=this.getModel("CAD_CTREMB").getProperty("/content/EMB_FURCOR/Value")||this.getModel("CAD_CTREMB").getProperty("/content/EMB_CTRFUR/Value");const s=t.split(".");const i=new Date(s[2],s[1]-1,s[0]);var r=e.getSource().getParent().getBindingContext("CAD_CTREMB").getObject();const a=r.X00TOFECHA.split(".");const o=new Date(a[2],a[1]-1,a[0]);const n=Math.floor((o.getTime()-i.getTime())/(1e3*3600*24)/7);const l=Math.floor((o.getTime()-i.getTime())/(1e3*3600*24)%7);const d=l===0?`${n} sem.`:`${n} sem. ${l} d.`;this.getModel("CAD_CTREMB").setProperty(`/Births/${r.X01_EMBID-1}/EGAMPLIADA`,d)},onDropHistory:function(e,t){if(this.getModel(t).getProperty("/Dokst")==="FR")return;let s=e.getParameter("draggedControl").getBindingContext("MedicalDataOverview").getObject();let i=JSON.parse(s.Object).key;var r={};if(this.getModel(t).getProperty("/DroppedHistoryModel")?.find(e=>e.ID===i))return;switch(s.MedType){case"Alergia":r=this.getModel("PatientAllergy").getData().results.find(e=>e.AllergySeqno===i);var a=this.getModel(t).getProperty("/Allergies");if(s.Description=="No refiere"){a.push({PAT_FALLDS:s.Description,PAT_FALLGR:"",PAT_FALLID:i,PAT_FALLRA:"",PAT_FALLSE:"",PAT_FALLTY:"",PAT_FALLCE:"",PAT_FALLVA:"",PAT_FALLOB:""});this.getView().getModel(t).getData().content.PAT_FALLST.Value="Ninguna alergia"}else{a.push({PAT_FALLDS:r.Descr,PAT_FALLGR:r.parent.Bcpname,PAT_FALLID:r.AllergySeqno,PAT_FALLRA:"",PAT_FALLSE:"",PAT_FALLTY:r.Typ,PAT_FALLCE:r.Cer,PAT_FALLVA:r.Evaluation,PAT_FALLOB:r.Adcomment});this.getView().getModel(t).getData().content.PAT_FALLST.Value="Existen alergias"}this.getModel(t).setProperty("/Allergies",a);break;case"Antecedente mdico":r=this.getModel("PatientMedicalHistory").getData().results.find(e=>e.MedHistid===i);var o=this.getModel(t).getProperty("/MedicalAntecedents");o.push({PAT_FDISNA:r.ZPMH.NameChild,PAT_FDISDA:r.DateMedHist,PAT_FDISTR:r.Treatment,PAT_FDISRM:r.RemarksInt,PAT_FDISID:r.MedHistid,PAT_FDISCM:r.Remarks});this.getModel(t).setProperty("/MedicalAntecedents",o);break;case"Antecedente quirrgico":r=this.getModel("PatientSurgeryHistory").getData().results.find(e=>e.SurgHistid===i);var n=this.getModel(t).getProperty("/SurgicalAntecedents");n.push({PAT_FSURDT:r.DateSurg,PAT_FSURNA:r.ZPSH.NameChild,PAT_FSURRM:r.RemarksInt,PAT_FSURAN:"",PAT_FSURID:r.SurgHistid,PAT_FSURCM:r.Remarks});this.getModel(t).setProperty("/SurgicalAntecedents",n);break;case"Antecedente familiar":r=this.getModel("PatientFamilyHistory").getData().results.find(e=>e.FamilyHistid===i);var l=this.getModel(t).getProperty("/FamilyAntecedents");l.push({PAT_FFHNAM:r.ZMFH.NameChild,PAT_FFHRMK:r.FamComment,PAT_FRSIB:"",PAT_FFHID:r.FamilyHistid,PAT_FRBRO:r.Brother,PAT_FRFAT:r.Father,PAT_FRGRA:"",PAT_FRMAGP:r.MaternalGrandparents,PAT_FRMOM:r.Mother,PAT_FRPAGP:r.PaternalGrandparents,PAT_FRSIS:r.Sister,PAT_FRSON:r.Son,PAT_FFHROB:r.RemarksInt});this.getModel(t).setProperty("/FamilyAntecedents",l);break;case"Factor de riesgo":r=this.getModel("PatientRiskFactor").getData().results.find(e=>e.Rsfnr===i);var d=this.getModel(t).getProperty("/RiskFactors");d.push({PAT_FRFDSC:r.Rsfna,PAT_FRFCOD:r.Rsfnr,PAT_FRFCOM:"",PAT_FRFID:"000"});this.getModel(t).setProperty("/RiskFactors",d);break;case"Hbito":if(t=="CAD_GINE")return;var n=this.getModel(t).getProperty("/SocialHabits")||[];n.push({P_HABIT_ID:i,P_HABIT_D:s.Description});this.getModel(t).setProperty("/SocialHabits",n);break;default:break}this.fillDocumentHistoryModel(t)},onDropVitalSigns:function(e,t){if(this.getModel(t).getProperty("/Dokst")==="FR")return;var s={};try{s=e.getParameter("draggedControl").getParent().getBindingContext("VitalSigns").getObject()}catch(e){return}let i=e.getParameter("draggedControl").getText();let r=new Date(e.getParameter("draggedControl").getBinding("text").getPath().split("/value")[0]);var a=this.getModel(t).getProperty("/VitalSignsExamTable");a.push({CLI_FVSDSC:s.description,CLI_FVSVAL:`${i} ${s.unit}`,CLI_FVSNRA:`${s.rangeNormalLow} ${s.unit} - ${s.rangeNormalHigh} ${s.unit}`,CLI_FVSTIM:n.getDateTimeInstance({pattern:"dd.MM.yyyy/HH:mm:ss"}).format(r),CLI_FVSID:s.positionId,CLI_FVSUNI:s.unit});this.getModel(t).setProperty("/VitalSignsExamTable",a)},onDropServices:function(e,t){if(this.getModel(t).getProperty("/Dokst")==="FR")return;let s={};try{s=e.getParameter("draggedControl").getBindingContext("Services").getObject()}catch(e){return}if(this.getModel(t).getProperty("/Services").find(e=>e.SRV_FIDPSR==s.Service.Lnrls))return;var i=this.getModel(t).getProperty("/Services");i.push({ORD_FASSCD:n.getDateTimeInstance({pattern:"dd.MM.yyyy"}).format(s.Service.Erdat),SRV_FIDPSR:s.Service.Lnrls,ORD_FASSD:s.Text,PMD_FREST:s.ResultsData,ORD_FERNAM:s.DrText});this.getModel(t).setProperty("/Services",i)},onServiceResultsButtonPress:function(e){this._itemsToUpload=[];let t=e.getSource().getParent().getBindingContext("Services").getObject();this.setModel(new c(t),"selectedService");if(t.ResultsDocument.Doknr&&t.ResultsDocument.Dokst==="FR"){this._pdfViewer.setSource(`/sap/opu/odata/sap/ZISH_HCFI_SRV/PDFSet(Dokar='${t.ResultsDocument.Dokar}',Doknr='${t.ResultsDocument.Doknr}',Dokvr='${t.ResultsDocument.Dokvr}',Doktl='${t.ResultsDocument.Doktl}')/$value`);this._pdfViewer.setTitle(t.ResultsDocument.Dktxt);this._pdfViewer.open()}else{this.oServiceResultsDialog?this.oServiceResultsDialog.open():this.loadFragment({type:"XML",name:"com.resulto.hcfi.view.ServiceResult"}).then(function(e){this.oServiceResultsDialog=e;e.open()}.bind(this))}},fillDroppedHistoryModel:function(e){let t=this.getModel(e).getProperty("/RiskFactors")||[];let s=this.getModel(e).getProperty("/Allergies")||[];let i=this.getModel(e).getProperty("/MedicalAntecedents")||[];let r=this.getModel(e).getProperty("/FamilyAntecedents")||[];let a=this.getModel(e).getProperty("/SurgicalAntecedents")||[];let o=this.getModel(e).getProperty("/SocialHabits")||[];var n=this.getModel("MedicalDataOverview").getData().results;var l=[];s.forEach(e=>{try{if(e.PAT_FALLDS=="No refiere"){l.push({medtype:"Alergias",description:e.PAT_FALLDS,ID:e.PAT_FALLID})}else if(e.PAT_FALLDS!="No refiere"){let t=n.find(t=>JSON.parse(t.Object).key===e.PAT_FALLID);l.push({medtype:"Alergias",description:t.Description,ID:e.PAT_FALLID})}}catch(e){}});i.forEach(e=>{try{let t=n.find(t=>JSON.parse(t.Object).key===e.PAT_FDISID);l.push({medtype:"Antecedente mdico",description:t.Description,ID:e.PAT_FDISID})}catch(e){}});a.forEach(e=>{try{let t=n.find(t=>JSON.parse(t.Object).key===e.PAT_FSURID);l.push({medtype:"Antecedente quirrgico",description:t.Description,ID:e.PAT_FSURID})}catch(e){}});r.forEach(e=>{try{let t=n.find(t=>JSON.parse(t.Object).key===e.PAT_FFHID);if(t!=undefined){l.push({medtype:"Antecedente familiar",description:t.Description,ID:e.PAT_FFHID})}}catch(e){}});t.forEach(e=>{try{let t=n.find(t=>JSON.parse(t.Object).key===e.PAT_FRFCOD);l.push({medtype:"Factor de riesgo",description:t.Description,ID:e.PAT_FRFCOD})}catch(e){}});o.forEach(e=>{try{l.push({medtype:"Hbito Social",description:e.P_HABIT_D,ID:e.P_HABIT_ID})}catch(e){}});this.getModel(e).setProperty("/DroppedHistoryModel",l)},fillDocumentHistoryModel:function(e){let t=this.getModel(e).getProperty("/RiskFactors")||[];let s=this.getModel(e).getProperty("/Allergies")||[];let i=this.getModel(e).getProperty("/MedicalAntecedents")||[];let r=this.getModel(e).getProperty("/FamilyAntecedents")||[];let a=this.getModel(e).getProperty("/SurgicalAntecedents")||[];let o=this.getModel(e).getProperty("/SocialHabits")||[];var l=[];s.forEach(e=>{try{if(e.PAT_FALLDS=="No refiere"){l.push({medtype:"Alergias",description:e.PAT_FALLDS,ID:e.PAT_FALLID})}else if(e.PAT_FALLDS!="No refiere"){let t="";let s=this.getModel("KeyValue").getData().N2AD_TYP.find(t=>t.KeyValue==e.PAT_FALLTY)?.KeyText;let i=this.getModel("KeyValue").getData().N2AD_EVALUATION.find(t=>t.KeyValue==e.PAT_FALLVA)?.KeyText;let r=this.getModel("KeyValue").getData().N2AD_CER.find(t=>t.KeyValue==e.PAT_FALLCE)?.KeyText;if(e.PAT_FALLDS)t+=""+e.PAT_FALLDS;if(e.PAT_FALLOB)t+="\n"+"Observaciones: "+e.PAT_FALLOB;if(r)t+="\n"+"Certeza: "+r;if(i)t+="\n"+"Valoracin: "+i;if(s)t+="\n"+"Tipo: "+s;l.push({medtype:"Alergias",description:t,ID:e.PAT_FALLID})}}catch(e){}});i.forEach(e=>{try{let s="";if(e.PAT_FDISNA)s+=""+e.PAT_FDISNA+" - ";if(e.PAT_FDISDA){var t=n.getDateTimeInstance({pattern:"dd.MM.yyyy"}).format(new Date(e.PAT_FDISDA));s+=""+t}if(e.PAT_FDISTR)s+="\n"+"Tratamiento: "+e.PAT_FDISTR;if(e.PAT_FDISRM)s+="\n"+"Observaciones: "+e.PAT_FDISRM;if(e.PAT_FDISCM)s+="\n"+"Comentarios: "+e.PAT_FDISCM;l.push({medtype:"Antecedente mdico",description:s,ID:e.PAT_FDISID})}catch(e){}});a.forEach(e=>{try{let s="";if(e.PAT_FSURNA)s+=""+e.PAT_FSURNA;if(e.PAT_FSURDT){var t=n.getDateTimeInstance({pattern:"dd.MM.yyyy"}).format(new Date(e.PAT_FSURDT));s+=" - "+t}if(e.PAT_FSURRM)s+="\n"+"Observaciones: "+e.PAT_FSURRM;if(e.PAT_FSURCM)s+="\n"+"Comentarios: "+e.PAT_FSURCM;l.push({medtype:"Antecedente quirrgico",description:s,ID:e.PAT_FSURID})}catch(e){}});r.forEach(e=>{try{let t="";if(e.PAT_FFHNAM)t+=""+e.PAT_FFHNAM;if(e.PAT_FRMOM||e.PAT_FRMAGP||e.PAT_FRPAGP||e.PAT_FRSIS||e.PAT_FRSON||e.PAT_FRBRO||e.PAT_FRFAT){t+=" (";if(e.PAT_FRMOM)t+=" "+this.getModel("i18n").getProperty("PAT_FRMOM");if(e.PAT_FRFAT)t+=" "+this.getModel("i18n").getProperty("PAT_FRFAT");if(e.PAT_FRBRO)t+=" "+this.getModel("i18n").getProperty("PAT_FRBRO");if(e.PAT_FRSIS)t+=" "+this.getModel("i18n").getProperty("PAT_FRSIS");if(e.PAT_FRSON)t+=" "+this.getModel("i18n").getProperty("PAT_FRSON");if(e.PAT_FRMAGP)t+=" "+this.getModel("i18n").getProperty("PAT_FRMAGP");if(e.PAT_FRPAGP)t+=" "+this.getModel("i18n").getProperty("PAT_FRPAGP");t+=" )"}if(e.PAT_FFHROB)t+="\n"+"Observaciones: "+e.PAT_FFHROB;if(e.PAT_FFHRMK)t+="\n"+"Comentarios: "+e.PAT_FFHRMK;l.push({medtype:"Antecedente familiar",description:t,ID:e.PAT_FFHID})}catch(e){}});t.forEach(e=>{try{l.push({medtype:"Factor de riesgo",description:e.PAT_FRFDSC,ID:e.PAT_FRFCOD})}catch(e){}});o.forEach(e=>{try{l.push({medtype:"Hbito Social",description:e.P_HABIT_D,ID:e.P_HABIT_ID})}catch(e){}});this.getModel(e).setSizeLimit(1e3);this.getModel(e).setProperty("/DroppedHistoryModel",l)},_fillFIN_GENObject:function(e){let t=this.getModel("MainData").getData();return{Dokar:"FIN",Doknr:e.ResultsDocument.Doknr||"9999999999999999999999999",Dokst:e.ResultsDocument.Dokst||"",Dokvr:e.ResultsDocument.Dokvr||"00",Doktl:e.ResultsDocument.Doktl||"000",Dotim:{ms:0,__edmType:"Edm.Time"},Einri:e.Service.Einri,Patnr:t.CaseData.Patnr,Falnr:e.Service.Falnr,Orgdo:e.Service.Anpoe,Mitarb:this.getModel("ProfessionalData").getProperty("/Id"),Dtid:"FIN_GEN",Dtvers:"001",Dodat:new Date,Service:e.Service.Lnrls,InitializationFields:"",content:[{Alias:"PMD_FREST",Dokar:"",Doknr:"",Doktl:"",Dokvr:"",Line:0,Value:e.ResultsData},{Alias:"SRV_FIDSRV",Dokar:"",Doknr:"",Doktl:"",Dokvr:"",Line:1,Value:e.Service.Lnrls},{Alias:"SRV_FPSRV",Dokar:"",Doknr:"",Doktl:"",Dokvr:"",Line:1,Value:e.Text},{Alias:"PMD_FERNAM",Dokar:"",Doknr:"",Doktl:"",Dokvr:"",Line:1,Value:this.getModel("ProfessionalData").getProperty("/Name")},{Alias:"PMD_FERMLN",Dokar:"",Doknr:"",Doktl:"",Dokvr:"",Line:1,Value:""},{Alias:"PMD_FERNUM",Dokar:"",Doknr:"",Doktl:"",Dokvr:"",Line:1,Value:this.getModel("ProfessionalData").getProperty("/Id")}]}},onOcPrintPressed:function(e){var t=this.getView().byId("clinicalOrders").getSelectedItems();var s=this.getView().getModel("ClinicalOrders").getProperty("/results");t.forEach(t=>{var i=t.oBindingContexts.ClinicalOrders.sPath;i=i.split("/");t=s[i[2]];this.__onOcPrint(e,t)})},__onOcPrint:function(e,t){this.setModel(d.createResultsModel(),"OCPrint");const s=e.getSource();this.byId("clinicalOrders").setBusy(true);var i=t.CorderId;this.getModel("ZISH_HCFI_SRV").callFunction("/PrintClinicalOrder",{urlParameters:{CorderID:i},success:function(e){var t=e;if(t.results.lenght<=1){var i=t.results[0].Base64;var r=atob(i);var a=new Uint8Array(r.length);for(var o=0;o<r.length;o++){a[o]=r.charCodeAt(o)}var n=new Blob([a.buffer],{type:"application/pdf"});var l=URL.createObjectURL(n);this.byId("clinicalOrders").setBusy(false);this._pdfViewer.setSource(l);this._pdfViewer.open()}else{var d=[];var c=0;var g="";t.results.forEach(e=>{g=e.TypeDescription;var t=e.Base64;var s=atob(t);var i=new Uint8Array(s.length);for(var r=0;r<s.length;r++){i[r]=s.charCodeAt(r)}c++;var a=new Blob([i.buffer],{type:"application/pdf"});var o=URL.createObjectURL(a);d.push({URL:o,NameDoc:g})});this.getModel("OCPrint").setProperty("/Docs",d);this.byId("clinicalOrders").setBusy(false);if(!this._OCPrintFragment){this.loadFragment({type:"XML",name:"com.resulto.hcfi.view.PrintClinicalOrderDialog"}).then(function(e){e.open(s);this._OCPrintFragment=e;this.getView().addDependent(this._OCPrintFragment)})}else{this._OCPrintFragment.open()}}}.bind(this),error:function(e){try{this.byId("clinicalOrders").setBusy(false);this.displayOdataError("PrintClinicalOrder",JSON.parse(e.responseText).error.message.value)}catch{this.displayOdataError("PrintClinicalOrder",e.message)}}.bind(this)})},onOCDialogClose:function(e){e.getSource().getParent().close();e.getSource().getParent().destroy()},onOCDialogObjectPress:function(e){var t=e.getSource().getBindingContext("OCPrint").getObject().URL;this._pdfViewer.setSource(t);this._pdfViewer.open()},onOcUpdatePressed:function(e){var t=null;var s=this.getView().getModel("ClinicalOrders").getProperty("/results");var i=e.oSource.oBindingContexts.ClinicalOrders.sPath;i=i.split("/");t=s[i[2]];var r=t.CorderPositionID;var a=this.headers.Patient;var o=this.headers.Institution;var n=this.headers.Case;var l=t.TreatmentUnit;var d=t.MedicalUnit;var c=new URL("https://sapdes.gruporecoletas.com/sap/bc/ui5_ui5/sap/zsmartlab/index.html#");c.searchParams.set("requestid",r);c.searchParams.set("patientid",a);c.searchParams.set("institutionid",o);c.searchParams.set("caseid",n);c.searchParams.set("orgid",l);c.searchParams.set("deptid",d);sap.m.URLHelper.redirect(c,true)},onOcAddPressed:function(){var e=null;var t=this.getView().getModel("ClinicalOrders").getProperty("/results");e=t[0];var s=this.headers.Patient;var i=this.headers.Institution;var r=this.headers.Case;var a=e.TreatmentUnit;var o=e.MedicalUnit;var n=new URL("https://sapdes.gruporecoletas.com/sap/bc/ui5_ui5/sap/zsmartlab/index.html#?");n.searchParams.append("patientid",s);n.searchParams.append("institutionid",i);n.searchParams.append("caseid",r);n.searchParams.append("orgid",a);n.searchParams.append("deptid",o);sap.m.URLHelper.redirect(n,true)},onOcDeletePressed:function(e){let t=e.getSource();if(!this.deleteOcConfirmationDialog){this.deleteOcConfirmationDialog=new sap.m.Dialog({type:sap.m.DialogType.Message,title:this.getModel("i18n").getProperty("Eliminate"),content:new sap.m.Text({text:this.getModel("i18n").getProperty("ConfirmDelete")}),beginButton:new sap.m.Button({type:sap.m.ButtonType.Emphasized,text:this.getModel("i18n").getProperty("Confirm"),press:function(){this.deleteOcConfirmationDialog.close();this.byId("clinicalOrders").setBusy(true);this.onOcDelete(t)}.bind(this)}),endButton:new sap.m.Button({text:this.getModel("i18n").getProperty("Cancel"),press:function(){this.deleteOcConfirmationDialog.close()}.bind(this)})})}this.deleteOcConfirmationDialog.open()},onOcDelete:function(){var e=this.getView().byId("clinicalOrders").getSelectedItems();var t=this.getView().getModel("ClinicalOrders").getProperty("/results");e.forEach(e=>{var s=e.oBindingContexts.ClinicalOrders.sPath;s=s.split("/");e=t[s[2]];this.getModel("ZISH_HCFI_SRV").callFunction("/DeleteClinicalOrderPosition",{urlParameters:{CorderPositionID:e.CorderPositionID},success:function(e){if(!this.deleteConfirmedDialog){this.deleteConfirmedDialog=new sap.m.Dialog({type:sap.m.DialogType.Message,title:this.getModel("i18n").getProperty("Eliminate"),content:new sap.m.Text({text:this.getModel("i18n").getProperty("deletionComplete")}),endButton:new sap.m.Button({text:this.getModel("i18n").getProperty("close"),press:function(){this.deleteConfirmedDialog.close();this.getClinicalOrders();this.getModel("ClinicalOrders").refresh();this.byId("clinicalOrders").setBusy(false);this.getView().byId("clinicalOrders").removeSelections(true)}.bind(this)})})}this.deleteConfirmedDialog.open()}.bind(this),error:function(e){try{this.byId("clinicalOrders").setBusy(false);this.displayOdataError("DeleteClinicalOrderPosition",JSON.parse(e.responseText).error.message.value);this.getClinicalOrders();this.getModel("ClinicalOrders").refresh();this.getView().byId("clinicalOrders").removeSelections(true)}catch{this.displayOdataError("DeleteClinicalOrderPosition",e.message);this.getView().byId("clinicalOrders").removeSelections(true)}}.bind(this)})})},prefillDefaultData:function(e){var t="";if(e.InitializationFields){let s=JSON.parse(e.InitializationFields);s.forEach(s=>{if(this.getModel(e.Dtid).getProperty("/content/"+s.alias)){switch(s.alias){case"MOV_FFEING":t=`${s.value.substr(6,2)}.${s.value.substr(4,2)}.${s.value.substr(0,4)}`;break;case"MOV_FHRING":t=`${s.value.substr(0,2)}:${s.value.substr(2,2)}:${s.value.substr(4,2)}`;break;default:t=s.value}this.getModel(e.Dtid).setProperty("/content/"+s.alias+"/Value",t)}})}},onOcRefreshPressed:function(e){this.sleep(1e3);this.getClinicalOrders();this.getView().byId("clinicalOrders").removeSelections(true)},onChangeFilteredBySpecialityStatus:function(e){let t=e.getParameter("pressed");this.getModel("ZISH_HCFI_SRV").callFunction("/SetFilteredBySpeciality",{method:"POST",urlParameters:{FilteredBySpeciality:t}});this.byId("MedDocuments").setBusy(false);this.byId("OtherDocuments").setBusy(false);this.byId("ResultsDocuments").setBusy(false);this.getDocuments(null,null,true)},sleep:function(e){this.getView().byId("clinicalOrders").setBusy(true);const t=Date.now();let s=null;do{s=Date.now()}while(s-t<e)},onLiveChangeMaxLength:function(e){if(e.getParameter("value").length>e.getSource().getMaxLength())e.getSource().setValue(e.getParameter("value").substr(0,e.getSource().getMaxLength()))},ExpandedDialogOpen:function(e){var t=new c;this.getView().setModel(t,"expandedModel");var s=this.getView().getModel("expandedModel");var i=this.getView().byId(e.oSource.oParent.mAggregations.items[0].sId);s.setProperty("/expandedText");var r="";if(e.oSource.sId.includes("AEBtnCon")){r=e.oSource.oParent.oParent.oParent.oParent.getHeaderText()}else if(e.oSource.sId.includes("AEBtnAlt")){r=e.oSource.oParent.oParent.oParent.oParent.oParent.oParent.getHeaderText()}else{r=e.oSource.oParent.oParent.getHeaderText()}var a={title:r,ogModel:i.mBindingInfos.value.parts[0].model,ogPath:i.mBindingInfos.value.parts[0].path,content:i.mBindingInfos.value.binding.oValue};s.setProperty("/expandedText",a);if(!this.oExpandedDialog){this.oExpandedDialog=new g({title:this.getView().getModel("expandedModel").getProperty("/expandedText").title,contentWidth:"1024px",content:[new sap.m.TextArea({value:this.getView().getModel("expandedModel").getProperty("/expandedText").content,rows:7,width:"100%",maxLength:i.mProperties.maxLength,showExceededText:true})],type:"Message",beginButton:new h({type:"Emphasized",text:"Grabar",press:function(){var e=s.getProperty("/expandedText").ogPath;e=e.split("/");e.pop();e.shift();this.getView().getModel(s.getProperty("/expandedText").ogModel).getProperty("/"+e[0]+"/"+e[1]).Value=this.oExpandedDialog.getContent()[0].getValue();this.oExpandedDialog.close();this.getView().getModel(s.getProperty("/expandedText").ogModel).refresh()}.bind(this)}),dialogAfterclose:function(e){this._oDialog.destroy();s.destroy()},endButton:new h({text:"Cancelar",press:function(){this.oExpandedDialog.close()}.bind(this)})});this.getView().addDependent(this.oExpandedDialog)}else{this.oExpandedDialog.setTitle(this.getView().getModel("expandedModel").getProperty("/expandedText").title);this.oExpandedDialog.destroyContent();this.oExpandedDialog.destroyBeginButton();this.oExpandedDialog.addContent(new sap.m.TextArea({value:this.getView().getModel("expandedModel").getProperty("/expandedText").content,rows:7,width:"100%",maxLength:i.mProperties.maxLength,showExceededText:true}));this.oExpandedDialog.setBeginButton(new h({type:"Emphasized",text:"Grabar",press:function(){var e=s.getProperty("/expandedText").ogPath;e=e.split("/");e.pop();e.shift();this.getView().getModel(s.getProperty("/expandedText").ogModel).getProperty("/"+e[0]+"/"+e[1]).Value=this.oExpandedDialog.getContent()[0].getValue();this.oExpandedDialog.close();this.getView().getModel(s.getProperty("/expandedText").ogModel).refresh()}.bind(this)}))}this.oExpandedDialog.open()},importAll:function(e){var t=e.oSource.oParent.oParent.mBindingInfos.items.model;var s=this.getModel("MedicalDataOverview").getProperty("/results");var i={};this.getModel(t).setProperty("/Allergies",[]);this.getModel(t).setProperty("/MedicalAntecedents",[]);this.getModel(t).setProperty("/SurgicalAntecedents",[]);this.getModel(t).setProperty("/FamilyAntecedents",[]);this.getModel(t).setProperty("/RiskFactors",[]);this.getModel(t).setProperty("/SocialHabits",[]);s.forEach(e=>{var s=JSON.parse(e.Object).key;switch(e.MedType){case"Alergia":i=this.getModel("PatientAllergy").getData().results.find(e=>e.AllergySeqno===s);var r=this.getModel(t).getProperty("/Allergies");if(e.Description=="No refiere"){r.push({PAT_FALLDS:e.Description,PAT_FALLGR:"",PAT_FALLID:s,PAT_FALLRA:"",PAT_FALLSE:"",PAT_FALLTY:"",PAT_FALLCE:"",PAT_FALLVA:"",PAT_FALLOB:""});this.getView().getModel(t).getData().content.PAT_FALLST.Value="Ninguna alergia"}else{r.push({PAT_FALLDS:i.Descr,PAT_FALLGR:i.parent.Bcpname,PAT_FALLID:i.AllergySeqno,PAT_FALLRA:"",PAT_FALLSE:"",PAT_FALLTY:i.Typ,PAT_FALLCE:i.Cer,PAT_FALLVA:i.Evaluation,PAT_FALLOB:i.Adcomment});this.getView().getModel(t).getData().content.PAT_FALLST.Value="Existen alergias"}this.getModel(t).setProperty("/Allergies",r);break;case"Antecedente mdico":i=this.getModel("PatientMedicalHistory").getData().results.find(e=>e.MedHistid===s);var a=this.getModel(t).getProperty("/MedicalAntecedents");a.push({PAT_FDISNA:i.ZPMH.NameChild,PAT_FDISDA:i.DateMedHist,PAT_FDISTR:i.Treatment,PAT_FDISRM:i.RemarksInt,PAT_FDISID:i.MedHistid,PAT_FDISCM:i.Remarks});this.getModel(t).setProperty("/MedicalAntecedents",a);break;case"Antecedente quirrgico":i=this.getModel("PatientSurgeryHistory").getData().results.find(e=>e.SurgHistid===s);var o=this.getModel(t).getProperty("/SurgicalAntecedents");o.push({PAT_FSURDT:i.DateSurg,PAT_FSURNA:i.ZPSH.NameChild,PAT_FSURRM:i.RemarksInt,PAT_FSURAN:"",PAT_FSURID:i.SurgHistid,PAT_FSURCM:i.Remarks});this.getModel(t).setProperty("/SurgicalAntecedents",o);break;case"Antecedente familiar":i=this.getModel("PatientFamilyHistory").getData().results.find(e=>e.FamilyHistid===s);var n=this.getModel(t).getProperty("/FamilyAntecedents");n.push({PAT_FFHNAM:i.ZMFH.NameChild,PAT_FFHRMK:i.FamComment,PAT_FRSIB:"",PAT_FFHID:i.FamilyHistid,PAT_FRBRO:i.Brother,PAT_FRFAT:i.Father,PAT_FRGRA:"",PAT_FRMAGP:i.MaternalGrandparents,PAT_FRMOM:i.Mother,PAT_FRPAGP:i.PaternalGrandparents,PAT_FRSIS:i.Sister,PAT_FRSON:i.Son,PAT_FFHROB:i.RemarksInt});this.getModel(t).setProperty("/FamilyAntecedents",n);break;case"Factor de riesgo":i=this.getModel("PatientRiskFactor").getData().results.find(e=>e.Rsfnr===s);var l=this.getModel(t).getProperty("/RiskFactors");l.push({PAT_FRFDSC:i.Rsfna,PAT_FRFCOD:i.Rsfnr,PAT_FRFCOM:"",PAT_FRFID:"000"});this.getModel(t).setProperty("/RiskFactors",l);break;case"Hbito":if(t=="CAD_GINE")break;var o=this.getModel(t).getProperty("/SocialHabits")||[];o.push({P_HABIT_ID:s,P_HABIT_D:e.Description});this.getModel(t).setProperty("/SocialHabits",o);break;default:break}});this.getModel(t).setProperty("/DroppedHistoryModel",[]);this.fillDocumentHistoryModel(t)}})});